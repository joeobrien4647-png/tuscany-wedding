<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sophie & Joe ‚Äî Wedding Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíç</text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyAbEpCIPFFqiuElH0DK1dkkl7JBbNyZTc8",
      authDomain: "tuscany-wedding.firebaseapp.com",
      databaseURL: "https://tuscany-wedding-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "tuscany-wedding",
      storageBucket: "tuscany-wedding.firebasestorage.app",
      messagingSenderId: "215551026806",
      appId: "1:215551026806:web:c3520487c4ff794fe0e157",
    });
    var db = firebase.database();
  </script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    input, select, textarea, button { font-family: inherit; }
    ::-webkit-scrollbar { height: 4px; width: 4px; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      [data-no-print] { display: none !important; }
      [data-print-expand] { overflow: visible !important; max-height: none !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const WEDDING_DATE = new Date("2027-05-29T14:00:00");
    let EUR_RATE = 1.17;

    const P = {
      bg: "#FAF7F2", bgD: "#F0EBE3", card: "#FFFFFF",
      terra: "#C4704B", terraL: "#E8A882", terraP: "#FDF0E9",
      olive: "#6B7F4E", oliveL: "#8FA86E", oliveP: "#EFF4E8",
      stone: "#8C8377", stoneL: "#B5AFA7", stoneP: "#E8E5E1",
      txt: "#3D3228", txtM: "#6B5E52", txtL: "#9C8E82",
      gold: "#C9A84C", goldP: "#FFF8E7", red: "#C45050", redP: "#FDECEC",
      green: "#4E8C5E", greenP: "#E8F5EC", blue: "#4A90A8", blueP: "#E8F4F8",
    };

    const TABS = [
      { id: "dash", label: "Dashboard", icon: "\u25C8" },
      { id: "budget", label: "Budget", icon: "\u00A3" },
      { id: "vendors", label: "Vendors", icon: "\u260E" },
      { id: "guests", label: "Guests", icon: "\u2661" },
      { id: "seating", label: "Seating", icon: "\u2B21" },
      { id: "rooms", label: "Rooms", icon: "\uD83C\uDFE0" },
      { id: "project", label: "Project", icon: "\uD83D\uDCC5" },
      { id: "timeline", label: "Week-of", icon: "\u25F7" },
      { id: "music", label: "Music", icon: "\u266B" },
      { id: "packing", label: "Packing", icon: "\u2713" },
      { id: "decisions", label: "Decisions", icon: "\u270E" },
    ];

    const BUDGET_CATS = [
      { id: "venue", name: "Venue Hire", estimate: 8000, icon: "\uD83C\uDFE1" },
      { id: "catering", name: "Catering & Food", estimate: 7000, icon: "\uD83C\uDF7D" },
      { id: "drinks", name: "Drinks (Self-Supplied)", estimate: 2100, icon: "\uD83E\uDD42" },
      { id: "photo", name: "Photography", estimate: 3000, icon: "\uD83D\uDCF8" },
      { id: "video", name: "Videography", estimate: 2000, icon: "\uD83C\uDFAC" },
      { id: "flowers", name: "Flowers & Styling", estimate: 2500, icon: "\uD83D\uDC90" },
      { id: "music", name: "Music & Entertainment", estimate: 2000, icon: "\uD83C\uDFB5" },
      { id: "hair", name: "Hair & Makeup", estimate: 800, icon: "\uD83D\uDC84" },
      { id: "celebrant", name: "Celebrant", estimate: 500, icon: "\uD83D\uDC8D" },
      { id: "planner", name: "Wedding Planner", estimate: 3000, icon: "\uD83D\uDCCB" },
      { id: "transport", name: "Transport & Transfers", estimate: 1500, icon: "\uD83D\uDE90" },
      { id: "stationery", name: "Stationery & Signage", estimate: 400, icon: "\u2709" },
      { id: "attire", name: "Wedding Attire", estimate: 2500, icon: "\uD83D\uDC54" },
      { id: "activities", name: "Guest Activities", estimate: 1000, icon: "\uD83C\uDFA8" },
      { id: "cake", name: "Cake", estimate: 500, icon: "\uD83C\uDF82" },
      { id: "flights", name: "Flights (Joe & Sophie)", estimate: 400, icon: "\u2708" },
      { id: "contingency", name: "Contingency (10%)", estimate: 3700, icon: "\uD83D\uDEE1" },
    ];

    const VENDOR_CATS = ["Venue","Caterer","Photographer","Videographer","Florist","DJ / Band","Hair & Makeup","Celebrant","Wedding Planner","Transport","Cake","Stationery","Activities","Other"];
    const VENDOR_STATUSES = ["Researching","Contacted","Quoted","Booked","Paid Deposit","Paid in Full"];
    const VSC = { Researching:{bg:P.stoneP,c:P.stone}, Contacted:{bg:P.goldP,c:P.gold}, Quoted:{bg:P.blueP,c:P.blue}, Booked:{bg:P.oliveP,c:P.olive}, "Paid Deposit":{bg:P.terraP,c:P.terra}, "Paid in Full":{bg:P.greenP,c:P.green} };

    const AIRPORTS = ["Perugia (PEG)","Florence (FLR)","Rome Fiumicino (FCO)","Rome Ciampino (CIA)","Pisa (PSA)","Bologna (BLQ)","Self-driving","Other"];
    const GUEST_STATUSES = ["Invited","Confirmed","Declined","Pending"];
    const VILLA_OPTS = ["Santarsa","Vallorsaia","Off-site"];
    const DIETARY_OPTS = ["None","Vegetarian","Vegan","Gluten-free","Dairy-free","Other"];
    const DECISION_CATS = ["General","Venue & Setup","Food & Drinks","Entertainment","Styling","Guest Experience","Budget","Timeline"];
    const GUEST_GROUPS = ["","Bride's Family","Groom's Family","Bride's Friends","Groom's Friends","Couple's Friends","Work"];
    const GUEST_ROLES = ["","Best Man","Bridesmaid","Usher","Mother of Bride","Mother of Groom","Father of Bride","Father of Groom","Flower Girl","Page Boy","Reader"];
    const MEAL_OPTIONS = ["","Beef","Sea Bass","Risotto (V)","Kids Menu"];
    const MUSIC_MOMENTS = ["","Ceremony","First Dance","Dinner","Party"];
    const MILESTONE_ASSIGNEES = ["","Sophie","Joe","Both","Planner"];
    const LEGAL_CHECKLIST = [
      { key: "noticeOfMarriage", label: "Give Notice of Marriage (28+ days before)" },
      { key: "oakwoodBooked", label: "Book Legal Ceremony at Oakwood House" },
      { key: "documentsGathered", label: "Gather Required Documents (passports, birth certs, proof of address)" },
      { key: "ceremonyAttended", label: "Attend Legal Ceremony" },
      { key: "certificateObtained", label: "Obtain Marriage Certificate" },
      { key: "celebrantBriefed", label: "Brief Symbolic Celebrant in Italy" },
    ];
    const GROOM_PREP = [
      { key: "suit", label: "Buy / hire wedding suit" },
      { key: "groomsmen", label: "Choose groomsmen" },
      { key: "groomsmenGifts", label: "Buy groomsmen gifts" },
      { key: "rings", label: "Buy wedding rings" },
      { key: "vows", label: "Write vows" },
      { key: "stagDo", label: "Plan stag do" },
      { key: "shoes", label: "Buy & break in wedding shoes" },
      { key: "grooming", label: "Book haircut / grooming" },
      { key: "speech", label: "Prepare wedding speech" },
    ];
    const BRIDE_PREP = [
      { key: "dress", label: "Choose wedding dress" },
      { key: "dressFitting", label: "Dress fittings" },
      { key: "bridesmaids", label: "Choose bridesmaids" },
      { key: "bridesmaidsDresses", label: "Buy bridesmaids' dresses" },
      { key: "bridesmaidsGifts", label: "Buy bridesmaids' gifts" },
      { key: "hairTrial", label: "Book hair trial" },
      { key: "makeupTrial", label: "Book makeup trial" },
      { key: "accessories", label: "Choose accessories (veil, shoes, jewellery)" },
      { key: "vows", label: "Write vows" },
      { key: "henDo", label: "Plan hen do" },
      { key: "somethingBorrowed", label: "Something old, new, borrowed, blue" },
    ];
    const COMMS_ITEMS = [
      { key: "saveTheDate", label: "Save the Date" },
      { key: "invitation", label: "Invitation Sent" },
      { key: "rsvpChased", label: "RSVP Chased" },
      { key: "infoPack", label: "Info Pack Sent" },
      { key: "travelConfirmed", label: "Travel Confirmed" },
    ];

    const IDEAS = [
      { cat: "Guest Experiences", color: "#6B7F4E", ideas: [
        { title: "Truffle hunting in the Umbrian hills", desc: "Forage with a local guide and Lagotto dog \u2014 then taste your finds on fresh pasta.", due: "2027-03-15" },
        { title: "Pasta-making class at the villa", desc: "Hands-on pici & ravioli with a local nonna. Perfect for a relaxed Friday afternoon.", due: "2027-03-15" },
        { title: "Wine tasting tour \u2014 Cortona vineyards", desc: "Visit Leuta, Tanagatta or Pomaio for tastings with the group.", due: "2027-03-15" },
        { title: "Olive oil tasting with local producer", desc: "Valtiberina produces some of Tuscany\u2019s finest oil \u2014 arrange a guided tasting.", due: "2027-03-15" },
        { title: "Limoncello making workshop", desc: "Zest, infuse, bottle \u2014 guests take home their own limoncello as a memento.", due: "2027-04-01" },
        { title: "Morning yoga session by the pool", desc: "Hire a local instructor for a sunrise session \u2014 perfect pre-wedding calm.", due: "2027-04-01" },
        { title: "Piero della Francesca art trail", desc: "Sansepolcro is his birthplace \u2014 visit the Resurrection fresco + Monterchi Madonna.", due: "2027-04-01" },
        { title: "Arezzo antique market day trip", desc: "One of Italy\u2019s best flea markets, held first weekend of the month in Piazza Grande.", due: "2027-04-01" },
      ]},
      { cat: "Personal Touches", color: "#C4704B", ideas: [
        { title: "Create a signature cocktail for the day", desc: "Design a \u2018Sophie & Joe\u2019 cocktail \u2014 print the recipe on table cards.", due: "2027-04-15" },
        { title: "Handwrite personal vows", desc: "Take time to write vows that are truly yours \u2014 practice reading them aloud.", due: "2027-02-15" },
        { title: "Photo timeline display of your story", desc: "Print key moments from first date to proposal \u2014 string up at the welcome party.", due: "2027-05-01" },
        { title: "Time capsule \u2014 open on 1st anniversary", desc: "Guests write letters, you add mementos. Seal it and open 29 May 2028.", due: "2027-05-15" },
        { title: "Letters to each other (read on the morning)", desc: "Write a letter the night before \u2014 exchange them while getting ready.", due: "2027-05-15" },
        { title: "Polaroid guest wall \u2014 instant memories", desc: "Set up a Polaroid station with props. Guests pin photos to a board.", due: "2027-05-01" },
        { title: "Spotify playlist QR codes on tables", desc: "Each table gets a QR code linking to a themed playlist you\u2019ve curated.", due: "2027-05-10" },
        { title: "Italian-themed welcome bags", desc: "Tote bags with Aperol sachets, taralli, a mini Tuscan guidebook, and paracetamol.", due: "2027-05-01" },
      ]},
      { cat: "Food & Drink", color: "#C9A84C", ideas: [
        { title: "Build-your-own bruschetta station", desc: "Fresh bread, roasted tomatoes, burrata, prosciutto \u2014 let guests assemble their own.", due: "2027-04-15" },
        { title: "Negroni bar with custom recipe cards", desc: "Classic, Sbagliato, Boulevardier \u2014 a proper Italian aperitivo experience.", due: "2027-04-15" },
        { title: "Late-night porchetta rolls", desc: "Slow-roasted pork with salsa verde \u2014 the ultimate midnight feast.", due: "2027-04-15" },
        { title: "Italian cheese & charcuterie tower", desc: "Pecorino, Parmigiano, finocchiona, coppa \u2014 styled on a tiered stand.", due: "2027-04-15" },
        { title: "Espresso cart after dinner", desc: "Proper Italian espresso, affogato, and espresso martinis from a vintage cart.", due: "2027-04-15" },
        { title: "Gelato station on pool day", desc: "Local gelateria delivers fresh gelato for the Sunday pool party.", due: "2027-04-15" },
        { title: "Local honey & jam wedding favours", desc: "Small jars of Valtiberina honey or fig jam with a handwritten thank-you tag.", due: "2027-05-01" },
      ]},
    ];

    const SANTARSA_ROOMS = [
      { name: "Master Suite", sleeps: 2 }, { name: "Room 2", sleeps: 2 }, { name: "Room 3", sleeps: 2 },
      { name: "Room 4", sleeps: 2 }, { name: "Room 5", sleeps: 2 }, { name: "Room 6", sleeps: 2 },
      { name: "Room 7", sleeps: 2 }, { name: "Room 8", sleeps: 2 }, { name: "Room 9 (Triple)", sleeps: 3 },
      { name: "Room 10", sleeps: 2 }, { name: "Room 11", sleeps: 2 }, { name: "Room 12", sleeps: 2 },
      { name: "Room 13", sleeps: 2 }, { name: "Room 14 (Triple)", sleeps: 3 },
    ];
    const VALLORSAIA_ROOMS = [
      { name: "Room 1 (Suite)", sleeps: 2 }, { name: "Room 2", sleeps: 2 }, { name: "Room 3", sleeps: 2 },
      { name: "Room 4", sleeps: 2 }, { name: "Room 5", sleeps: 2 }, { name: "Room 6", sleeps: 2 },
      { name: "Room 7", sleeps: 2 }, { name: "Room 8 (Triple)", sleeps: 3 }, { name: "Room 9", sleeps: 2 },
      { name: "Room 10", sleeps: 2 }, { name: "Room 11 (Triple)", sleeps: 3 },
    ];

    const DEFAULT_PACKING = [
      { cat: "Documents", items: [
        { text: "Passports", done: false }, { text: "Travel insurance docs", done: false }, { text: "Venue confirmation / contract", done: false },
        { text: "Vendor contact sheet (printed)", done: false }, { text: "Ceremony script / readings", done: false }, { text: "Guest info packs (spares)", done: false },
        { text: "Euros (cash for tips)", done: false }, { text: "Marriage certificate (from Oakwood House)", done: false },
      ]},
      { cat: "Wedding Attire", items: [
        { text: "Wedding dress + hanger", done: false }, { text: "Veil / headpiece", done: false }, { text: "Wedding shoes", done: false },
        { text: "Suit / outfit", done: false }, { text: "Tie / pocket square", done: false }, { text: "Cufflinks", done: false },
        { text: "Rings", done: false }, { text: "Backup outfit (rehearsal / pool party)", done: false },
      ]},
      { cat: "Styling & D\u00E9cor", items: [
        { text: "Table plan / place cards", done: false }, { text: "Welcome signs", done: false }, { text: "Card box / wishing well", done: false },
        { text: "Guest book + pen", done: false }, { text: "Polaroid camera + film", done: false }, { text: "Sparklers", done: false },
        { text: "Fairy lights / candles", done: false }, { text: "Confetti", done: false },
      ]},
      { cat: "Guest Experience", items: [
        { text: "Welcome bags / totes", done: false }, { text: "Hangover kits", done: false }, { text: "Lawn games (bocce, Jenga)", done: false },
        { text: "Pool inflatables", done: false }, { text: "Bluetooth speaker (backup)", done: false },
        { text: "Limoncello bottles", done: false }, { text: "Favours", done: false },
      ]},
      { cat: "Personal", items: [
        { text: "Toiletries & SPF", done: false }, { text: "Medications", done: false }, { text: "Phone chargers / power banks", done: false },
        { text: "Camera / GoPro", done: false }, { text: "Swimwear", done: false }, { text: "Sunglasses", done: false },
        { text: "Comfortable shoes (for dancing)", done: false }, { text: "Sewing kit / safety pins", done: false },
      ]},
    ];

    const TIMELINE_DAYS = [
      { day: "Thursday 27 May", label: "Setup Day", color: P.stone, items: [
        { time: "10:00", event: "Joe & Sophie arrive at La Conca", vendor: "", done: false },
        { time: "11:00", event: "Walk-through with wedding planner", vendor: "Planner", done: false },
        { time: "13:00", event: "Vineyard visits \u2014 Leuta, Tanagatta, Pomaio", vendor: "", done: false },
        { time: "17:00", event: "Final venue setup & styling check", vendor: "Florist / Planner", done: false },
        { time: "19:00", event: "Quiet dinner \u2014 just the two of you", vendor: "", done: false },
      ]},
      { day: "Friday 28 May", label: "Welcome Day \uD83C\uDF55", color: P.olive, items: [
        { time: "All day", event: "Guests arrive \u2014 airport transfers", vendor: "Transport", done: false },
        { time: "14:00", event: "Welcome drinks by the pool", vendor: "", done: false },
        { time: "15:00", event: "Lawn games (bocce, giant Jenga)", vendor: "", done: false },
        { time: "17:00", event: "Aperol spritz station opens", vendor: "", done: false },
        { time: "19:30", event: "Pizza party welcome dinner", vendor: "Caterer", done: false },
        { time: "21:00", event: "Relaxed evening \u2014 music, mingling", vendor: "DJ / Playlist", done: false },
      ]},
      { day: "Saturday 29 May", label: "Wedding Day \uD83D\uDC8D", color: P.terra, items: [
        { time: "08:00", event: "Breakfast at both villas", vendor: "Caterer", done: false },
        { time: "09:00", event: "Hair & makeup begins", vendor: "Hair & Makeup", done: false },
        { time: "10:00", event: "Photographer \u2014 getting ready shots", vendor: "Photographer", done: false },
        { time: "12:00", event: "Videographer arrives", vendor: "Videographer", done: false },
        { time: "13:00", event: "Light lunch for guests", vendor: "Caterer", done: false },
        { time: "15:00", event: "Ceremony", vendor: "Celebrant / Musician", done: false },
        { time: "15:45", event: "Drinks reception & group photos", vendor: "Photographer", done: false },
        { time: "17:30", event: "Wedding breakfast", vendor: "Caterer", done: false },
        { time: "19:30", event: "Speeches", vendor: "", done: false },
        { time: "20:30", event: "First dance & evening party", vendor: "DJ / Band", done: false },
        { time: "21:00", event: "Negroni station opens", vendor: "", done: false },
        { time: "22:30", event: "Late-night snacks", vendor: "Caterer", done: false },
        { time: "23:00", event: "Limoncello & sparklers", vendor: "", done: false },
      ]},
      { day: "Sunday 30 May", label: "Pool Party \uD83C\uDFCA", color: P.blue, items: [
        { time: "09:00", event: "Hangover kits outside rooms", vendor: "", done: false },
        { time: "10:00", event: "Brunch \u2014 Bellinis & pastries", vendor: "Caterer", done: false },
        { time: "12:00", event: "Pool party \u2014 Hugo spritzes", vendor: "DJ / Playlist", done: false },
        { time: "14:00", event: "Optional \u2014 cooking class / wine tasting", vendor: "Activity provider", done: false },
        { time: "18:00", event: "Casual farewell dinner", vendor: "Caterer", done: false },
        { time: "20:00", event: "Final drinks, Polaroid station", vendor: "", done: false },
      ]},
      { day: "Monday 31 May", label: "Departure \uD83D\uDC4B", color: P.txtL, items: [
        { time: "08:00", event: "Breakfast & packing", vendor: "", done: false },
        { time: "10:00", event: "Transfers \u2014 staggered departures", vendor: "Transport", done: false },
        { time: "12:00", event: "Final goodbyes & villa handback", vendor: "", done: false },
      ]},
    ];

    const DEFAULT_DATA = {
      budget: BUDGET_CATS.reduce((a, c) => ({ ...a, [c.id]: { actual: 0, paid: 0, currency: "GBP", notes: "", payments: [
        { label: "Deposit", amount: 0, date: "", paid: false },
        { label: "Second payment", amount: 0, date: "", paid: false },
        { label: "Final payment", amount: 0, date: "", paid: false },
      ]}}), {}),
      guests: [
        { id: 1, name: "Tom Whitfield", status: "Confirmed", villa: "Santarsa", dietary: "None", plusOne: true, partner: "Laura Whitfield", email: "tom.w@email.com", phone: "+447700100001", notes: "Best man", airport: "Rome Fiumicino (FCO)", flightNo: "BA548", arrivalDate: "2027-05-27", arrivalTime: "14:30", departDate: "2027-06-01", departTime: "11:00" },
        { id: 2, name: "Laura Whitfield", status: "Confirmed", villa: "Santarsa", dietary: "Vegetarian", plusOne: false, partner: "", email: "laura.w@email.com", phone: "+447700100002", notes: "", airport: "Rome Fiumicino (FCO)", flightNo: "BA548", arrivalDate: "2027-05-27", arrivalTime: "14:30", departDate: "2027-06-01", departTime: "11:00" },
        { id: 3, name: "Charlie Evans", status: "Confirmed", villa: "Santarsa", dietary: "None", plusOne: true, partner: "Meg Evans", email: "charlie.e@email.com", phone: "+447700100003", notes: "Usher", airport: "Florence (FLR)", flightNo: "VY6234", arrivalDate: "2027-05-28", arrivalTime: "10:15", departDate: "2027-05-31", departTime: "16:00" },
        { id: 4, name: "Meg Evans", status: "Confirmed", villa: "Santarsa", dietary: "Gluten-free", plusOne: false, partner: "", email: "meg.e@email.com", phone: "+447700100004", notes: "", airport: "Florence (FLR)", flightNo: "VY6234", arrivalDate: "2027-05-28", arrivalTime: "10:15", departDate: "2027-05-31", departTime: "16:00" },
        { id: 5, name: "James O'Brien", status: "Confirmed", villa: "Santarsa", dietary: "None", plusOne: false, partner: "", email: "james.ob@email.com", phone: "+447700100005", notes: "Brother of groom", airport: "Rome Fiumicino (FCO)", flightNo: "FR9442", arrivalDate: "2027-05-27", arrivalTime: "18:00", departDate: "2027-06-01", departTime: "09:00" },
        { id: 6, name: "Emily Chen", status: "Confirmed", villa: "Vallorsaia", dietary: "Vegan", plusOne: true, partner: "Dan Morris", email: "emily.c@email.com", phone: "+447700100006", notes: "Bridesmaid", airport: "Pisa (PSA)", flightNo: "U28345", arrivalDate: "2027-05-28", arrivalTime: "09:00", departDate: "2027-05-31", departTime: "18:30" },
        { id: 7, name: "Dan Morris", status: "Confirmed", villa: "Vallorsaia", dietary: "None", plusOne: false, partner: "", email: "dan.m@email.com", phone: "+447700100007", notes: "", airport: "Pisa (PSA)", flightNo: "U28345", arrivalDate: "2027-05-28", arrivalTime: "09:00", departDate: "2027-05-31", departTime: "18:30" },
        { id: 8, name: "Poppy Williams", status: "Confirmed", villa: "Vallorsaia", dietary: "None", plusOne: false, partner: "", email: "poppy.w@email.com", phone: "+447700100008", notes: "Bridesmaid", airport: "Rome Fiumicino (FCO)", flightNo: "BA548", arrivalDate: "2027-05-27", arrivalTime: "14:30", departDate: "2027-06-01", departTime: "11:00" },
        { id: 9, name: "Harry Blake", status: "Confirmed", villa: "Santarsa", dietary: "None", plusOne: true, partner: "Jess Blake", email: "harry.b@email.com", phone: "+447700100009", notes: "Usher", airport: "Florence (FLR)", flightNo: "VY6234", arrivalDate: "2027-05-28", arrivalTime: "10:15", departDate: "2027-05-31", departTime: "16:00" },
        { id: 10, name: "Jess Blake", status: "Confirmed", villa: "Santarsa", dietary: "Dairy-free", plusOne: false, partner: "", email: "jess.b@email.com", phone: "+447700100010", notes: "", airport: "Florence (FLR)", flightNo: "VY6234", arrivalDate: "2027-05-28", arrivalTime: "10:15", departDate: "2027-05-31", departTime: "16:00" },
        { id: 11, name: "Liam Taylor", status: "Confirmed", villa: "Vallorsaia", dietary: "None", plusOne: false, partner: "", email: "liam.t@email.com", phone: "+447700100011", notes: "", airport: "Rome Ciampino (CIA)", flightNo: "FR1122", arrivalDate: "2027-05-28", arrivalTime: "12:00", departDate: "2027-05-31", departTime: "15:00" },
        { id: 12, name: "Grace Murphy", status: "Confirmed", villa: "Vallorsaia", dietary: "Vegetarian", plusOne: false, partner: "", email: "grace.m@email.com", phone: "+447700100012", notes: "Reading during ceremony", airport: "Rome Ciampino (CIA)", flightNo: "FR1122", arrivalDate: "2027-05-28", arrivalTime: "12:00", departDate: "2027-05-31", departTime: "15:00" },
        { id: 13, name: "Rob Sinclair", status: "Invited", villa: "Santarsa", dietary: "None", plusOne: true, partner: "Amy Sinclair", email: "rob.s@email.com", phone: "+447700100013", notes: "", airport: "", flightNo: "", arrivalDate: "", arrivalTime: "", departDate: "", departTime: "" },
        { id: 14, name: "Amy Sinclair", status: "Invited", villa: "Santarsa", dietary: "None", plusOne: false, partner: "", email: "amy.s@email.com", phone: "+447700100014", notes: "", airport: "", flightNo: "", arrivalDate: "", arrivalTime: "", departDate: "", departTime: "" },
        { id: 15, name: "Freya Dunn", status: "Confirmed", villa: "Vallorsaia", dietary: "None", plusOne: false, partner: "", email: "freya.d@email.com", phone: "+447700100015", notes: "Bridesmaid", airport: "Bologna (BLQ)", flightNo: "FR4456", arrivalDate: "2027-05-27", arrivalTime: "16:00", departDate: "2027-06-01", departTime: "10:00" },
        { id: 16, name: "Ollie Chambers", status: "Confirmed", villa: "Santarsa", dietary: "None", plusOne: true, partner: "Nia Chambers", email: "ollie.c@email.com", phone: "+447700100016", notes: "", airport: "Perugia (PEG)", flightNo: "FR7890", arrivalDate: "2027-05-28", arrivalTime: "11:30", departDate: "2027-05-31", departTime: "14:00" },
        { id: 17, name: "Nia Chambers", status: "Confirmed", villa: "Santarsa", dietary: "None", plusOne: false, partner: "", email: "nia.c@email.com", phone: "+447700100017", notes: "", airport: "Perugia (PEG)", flightNo: "FR7890", arrivalDate: "2027-05-28", arrivalTime: "11:30", departDate: "2027-05-31", departTime: "14:00" },
        { id: 18, name: "Sophie's Mum (Karen)", status: "Confirmed", villa: "Santarsa", dietary: "None", plusOne: false, partner: "", email: "karen@email.com", phone: "+447700100018", notes: "Mother of bride", airport: "Rome Fiumicino (FCO)", flightNo: "BA546", arrivalDate: "2027-05-26", arrivalTime: "13:00", departDate: "2027-06-01", departTime: "11:00" },
        { id: 19, name: "Sophie's Dad (Mike)", status: "Confirmed", villa: "Santarsa", dietary: "None", plusOne: false, partner: "", email: "mike@email.com", phone: "+447700100019", notes: "Father of bride", airport: "Rome Fiumicino (FCO)", flightNo: "BA546", arrivalDate: "2027-05-26", arrivalTime: "13:00", departDate: "2027-06-01", departTime: "11:00" },
        { id: 20, name: "Joe's Mum (Helen)", status: "Confirmed", villa: "Vallorsaia", dietary: "Vegetarian", plusOne: false, partner: "", email: "helen@email.com", phone: "+447700100020", notes: "Mother of groom", airport: "Rome Fiumicino (FCO)", flightNo: "BA546", arrivalDate: "2027-05-26", arrivalTime: "13:00", departDate: "2027-06-01", departTime: "11:00" },
        { id: 21, name: "Joe's Dad (Steve)", status: "Confirmed", villa: "Vallorsaia", dietary: "None", plusOne: false, partner: "", email: "steve@email.com", phone: "+447700100021", notes: "Father of groom", airport: "Rome Fiumicino (FCO)", flightNo: "BA546", arrivalDate: "2027-05-26", arrivalTime: "13:00", departDate: "2027-06-01", departTime: "11:00" },
        { id: 22, name: "Matt Perry", status: "Invited", villa: "Santarsa", dietary: "None", plusOne: false, partner: "", email: "matt.p@email.com", phone: "", notes: "", airport: "", flightNo: "", arrivalDate: "", arrivalTime: "", departDate: "", departTime: "" },
        { id: 23, name: "Isla Grant", status: "Pending", villa: "Vallorsaia", dietary: "None", plusOne: false, partner: "", email: "isla.g@email.com", phone: "+447700100023", notes: "", airport: "", flightNo: "", arrivalDate: "", arrivalTime: "", departDate: "", departTime: "" },
        { id: 24, name: "Ben Howard", status: "Confirmed", villa: "Santarsa", dietary: "None", plusOne: false, partner: "", email: "ben.h@email.com", phone: "+447700100024", notes: "", airport: "Self-driving", flightNo: "", arrivalDate: "2027-05-28", arrivalTime: "15:00", departDate: "2027-05-31", departTime: "10:00" },
      ],
      vendors: [
        // Wedding Planner
        { id: 1, name: "Serena \u2014 Tuscan Tours & Weddings", category: "Wedding Planner", status: "Researching", phone: "", email: "", website: "tuscantoursandweddings.com", notes: "Based Arezzo/Cortona. 20 yrs, fluent English.", starred: true },
        // Caterer
        { id: 2, name: "I Vecchi Amici", category: "Caterer", status: "Researching", phone: "", email: "", website: "", notes: "Local \u2014 confirm availability", starred: false },
        // Photographers
        { id: 10, name: "Federico Pannacci", category: "Photographer", status: "Researching", phone: "", email: "", website: "federicopannacci.com", notes: "Umbria/Tuscany border \u2014 closest to La Conca. Fine art, natural light. Fluent English. Shoots at agriturismos.", starred: true },
        { id: 11, name: "Stefano Santucci", category: "Photographer", status: "Researching", phone: "", email: "", website: "stefanosantucci.com", notes: "Florence. Documentary + fine art. Featured Junebug, Style Me Pretty. Calm & unobtrusive.", starred: false },
        { id: 12, name: "Laura Barbera", category: "Photographer", status: "Researching", phone: "", email: "", website: "laurabarbera.com", notes: "Florence. Fine art, editorial, film-like. Vogue, Martha Stewart. Sweet spot ~50 guests.", starred: false },
        { id: 13, name: "Lelia Scarfiotti", category: "Photographer", status: "Researching", phone: "", email: "", website: "leliascarfiotti.com", notes: "Tuscany. Painterly, Renaissance quality. Most distinctive style \u2014 photos feel like fine art prints.", starred: false },
        // Videographers
        { id: 20, name: "Gattotigre (Matteo Castelluccia)", category: "Videographer", status: "Researching", phone: "", email: "", website: "gattotigre.it", notes: "Tuscany. Cinematic storytelling \u2014 feels like short docs not highlight reels. Top reputation in Tuscany.", starred: true },
        { id: 21, name: "Waterfall Visuals", category: "Videographer", status: "Researching", phone: "", email: "", website: "waterfallvisuals.com", notes: "Tuscany. Cinematic + romantic. Great drone work for landscape. Regular British/American clients.", starred: false },
        { id: 22, name: "Facibeni Fotografia", category: "Videographer", status: "Researching", phone: "", email: "", website: "facibenifotografia.it", notes: "Florence. Cinematic documentary. Also do photography \u2014 could be coordinated photo+video team.", starred: false },
        // Florists
        { id: 30, name: "Tuscany Flowers", category: "Florist", status: "Researching", phone: "", email: "", website: "tuscanyflowers.com", notes: "Arezzo area \u2014 closest to La Conca. Specialises in eastern Tuscany. Lower travel costs. Knows local May blooms.", starred: true },
        { id: 31, name: "La Rosa Canina Firenze", category: "Florist", status: "Researching", phone: "", email: "", website: "larosacaninafirenze.it", notes: "Florence. Premium. Olive branches, wild roses, peonies. Featured Vogue Sposa. Considered the best in Italy.", starred: false },
        { id: 32, name: "Jardin Divers", category: "Florist", status: "Researching", phone: "", email: "", website: "jardindivers.it", notes: "Florence. Wildflower-inspired, whimsical, 'gathered from the garden' feel. English + French. Mid-to-premium.", starred: false },
        { id: 33, name: "Stiatti Fiori", category: "Florist", status: "Researching", phone: "", email: "", website: "stiattifiori.it", notes: "Arezzo (~40 min). Classic to rustic. English may be limited \u2014 planner could help.", starred: false },
        // DJ / Band
        { id: 40, name: "Romadjpianobar (Guido Belli)", category: "DJ / Band", status: "Researching", phone: "", email: "", website: "romadjpianobar.com", notes: "English-speaking. Full-day: ceremony, aperitivo, dinner, evening. Can add sax/violin. Knows Arezzo/Cortona.", starred: true },
        { id: 41, name: "Alma Project Music", category: "DJ / Band", status: "Researching", phone: "", email: "", website: "almaprojectmusic.com", notes: "Florence. Premium agency \u2014 bands, DJs, string quartets. Full production inc. lighting. Higher-end.", starred: false },
        { id: 42, name: "Musica Per Matrimoni Toscana", category: "DJ / Band", status: "Researching", phone: "", email: "", website: "musicapermatrimonitoscana.it", notes: "Tuscany. Acoustic ceremony + DJ. Bilingual. Great for intimate weddings. Budget-friendly.", starred: false },
        // Hair & Makeup
        { id: 50, name: "Janita Helova", category: "Hair & Makeup", status: "Researching", phone: "", email: "", website: "janitahelova.com", notes: "Tuscany. Top choice for British brides \u2014 native-level English. Natural 'you-but-better' style. Travels to villas.", starred: true },
        { id: 51, name: "Giulia Cresci", category: "Hair & Makeup", status: "Researching", phone: "", email: "", website: "giuliacresci.com", notes: "Florence. Bridal trials + party makeup. Classic glamour to soft natural. Travels to rural villas.", starred: false },
        { id: 52, name: "Gabriella De Girolamo", category: "Hair & Makeup", status: "Researching", phone: "", email: "", website: "gabriellamakeupartist.com", notes: "Tuscany. Covers Arezzo/Cortona. Fresh, romantic. Can recommend trusted hair stylist partner.", starred: false },
        // Celebrant
        { id: 60, name: "Katy McEwen \u2014 Tuscany Celebrants", category: "Celebrant", status: "Researching", phone: "", email: "", website: "tuscanycelebrants.com", notes: "British, based in Tuscany. Symbolic/humanist. Knows Sansepolcro area. Personalised vows, readings, handfasting.", starred: true },
        { id: 61, name: "Lisa Sheridan \u2014 Italian Celebrants", category: "Celebrant", status: "Researching", phone: "", email: "", website: "italiancelebrants.com", notes: "Trained celebrant (Celebrants Network). English or bilingual. Experienced outdoor agriturismo ceremonies.", starred: false },
        { id: 62, name: "Ade Rogers", category: "Celebrant", status: "Researching", phone: "", email: "", website: "englishtuscanycelebrant.com", notes: "British Humanist in Tuscany. Warm, relaxed, humorous. Natural not-too-formal. Well-reviewed by British couples.", starred: false },
        // Transport
        { id: 70, name: "PrimaCar (NCC Arezzo)", category: "Transport", status: "Researching", phone: "", email: "", website: "primacar.it", notes: "Local to Arezzo province \u2014 knows Sansepolcro/Valtiberina roads. Competitive pricing. English drivers available.", starred: true },
        { id: 71, name: "Tuscany Transfers", category: "Transport", status: "Researching", phone: "", email: "", website: "tuscanytransfers.com", notes: "Large, established. Sedans, minivans (8 pax), minibuses (20 pax). Airport pickups + wedding day shuttles. Fixed pricing.", starred: false },
        { id: 72, name: "Italy Limousine", category: "Transport", status: "Researching", phone: "", email: "", website: "italylimousine.com", notes: "Premium. Vintage Fiat 500 & classic cars for ceremony. Modern minibuses for guests. Full timeline coordination.", starred: false },
        // Cake
        { id: 80, name: "Delizie di Mamma (Melina Kelekis)", category: "Cake", status: "Researching", phone: "", email: "", website: "deliziemamma.com", notes: "Cortona (~45 min). English-speaking. Semi-naked to tiered. Blends British & Italian flavours.", starred: true },
        { id: 81, name: "Sugar Couture (Ilaria Trasi)", category: "Cake", status: "Researching", phone: "", email: "", website: "sugarcouture.it", notes: "Arezzo. Artisan cakes, Italian flavours. Fondant, semi-naked, buttercream. Close to La Conca.", starred: false },
        // Activities (vineyards + experiences)
        { id: 90, name: "Savini Tartufi", category: "Activities", status: "Researching", phone: "", email: "", website: "savinitartufi.com", notes: "Truffle hunting experiences. Check if they cover Arezzo/Valtiberina or just Palaia area.", starred: false },
        { id: 91, name: "Azienda Agricola Leuta", category: "Activities", status: "Researching", phone: "", email: "", website: "", notes: "Vineyard visit + tasting. Cortona (~45 min).", starred: false },
        { id: 92, name: "Cantina Tanagatta", category: "Activities", status: "Researching", phone: "", email: "", website: "", notes: "Wine tasting. Local to Sansepolcro.", starred: false },
        { id: 93, name: "Podere di Pomaio", category: "Activities", status: "Researching", phone: "", email: "", website: "pomaio.it/en", notes: "Organic vineyard + wine tasting. Arezzo (~40 min).", starred: false },
        // Stationery
        { id: 95, name: "Papier", category: "Stationery", status: "Researching", phone: "", email: "", website: "papier.com", notes: "UK-based online. Customisable suites \u2014 save the dates, invites, menus, place cards. Italian/Mediterranean templates.", starred: false },
      ],
      timeline: TIMELINE_DAYS.map(d => ({ ...d, items: d.items.map(i => ({ ...i })) })),
      milestones: [
        // Early Phase
        { task: "Get wedding insurance", due: "2026-03-15", done: false },
        { task: "Create mood board / Pinterest", due: "2026-03-30", done: false },
        { task: "Finalise guest list", due: "2026-04-15", done: false },
        { task: "Start wedding dress shopping", due: "2026-04-30", done: false },
        { task: "Research wedding planners & shortlist", due: "2026-05-15", done: false },
        // Booking Phase
        { task: "Book wedding planner/coordinator", due: "2026-06-01", done: false },
        { task: "Legal ceremony at Oakwood House", due: "2026-07-18", done: false },
        { task: "Book photographer", due: "2026-09-01", done: false },
        { task: "Book videographer", due: "2026-09-01", done: false },
        { task: "Book caterer", due: "2026-09-01", done: false },
        { task: "Book celebrant", due: "2026-09-01", done: false },
        { task: "Send save-the-dates", due: "2026-09-15", done: false },
        { task: "Book suit / groomswear", due: "2026-09-30", done: false },
        // Planning Phase
        { task: "Book florist", due: "2026-10-15", done: false },
        { task: "Book DJ / band", due: "2026-10-30", done: false },
        { task: "Book hair & makeup", due: "2026-11-01", done: false },
        { task: "Order wedding rings", due: "2026-11-15", done: false },
        { task: "Cake tasting sessions", due: "2026-11-20", done: false },
        { task: "Food tasting with caterer", due: "2026-11-30", done: false },
        { task: "Design & order stationery suite", due: "2026-12-01", done: false },
        { task: "Book guest activities (cooking class, wine tasting)", due: "2026-12-15", done: false },
        { task: "Plan welcome pizza party details", due: "2026-12-20", done: false },
        { task: "Plan pool party & day-after details", due: "2026-12-31", done: false },
        // Countdown Phase
        { task: "Send formal invitations", due: "2027-01-15", done: false },
        { task: "Hair & makeup trial (UK)", due: "2027-01-20", done: false },
        { task: "Book honeymoon", due: "2027-01-31", done: false },
        { task: "Choose ceremony readings & write vows", due: "2027-02-15", done: false },
        { task: "RSVP deadline", due: "2027-02-28", done: false },
        { task: "Brief best man & bridesmaids", due: "2027-03-01", done: false },
        { task: "Finalise menu with caterer", due: "2027-03-15", done: false },
        { task: "Book airport transfers", due: "2027-03-15", done: false },
        { task: "Sort wedding favours & welcome bags", due: "2027-03-31", done: false },
        // Final Phase
        { task: "Send guest info pack", due: "2027-04-01", done: false },
        { task: "Final dress fitting", due: "2027-04-10", done: false },
        { task: "Create day-of timeline with planner", due: "2027-04-15", done: false },
        { task: "Finalise ceremony script with celebrant", due: "2027-04-15", done: false },
        { task: "Practice first dance", due: "2027-04-20", done: false },
        { task: "Passport checks for all guests", due: "2027-04-30", done: false },
        { task: "Buy & ship self-supply drinks to Italy", due: "2027-05-10", done: false },
        { task: "Print table plan, place cards, signage", due: "2027-05-15", done: false },
        { task: "Final vendor payments", due: "2027-05-15", done: false },
        { task: "Vineyard visits & drinks shopping", due: "2027-05-27", done: false },
      ],
      decisions: [],
      music: { mustPlay: [], neverPlay: [], requests: [] },
      packing: DEFAULT_PACKING,
      seating: { tables: [] },
      rooms: { santarsa: SANTARSA_ROOMS.map(r => ({ ...r, guests: [] })), vallorsaia: VALLORSAIA_ROOMS.map(r => ({ ...r, guests: [] })) },
    };

    const iS = { width: "100%", padding: "7px 10px", borderRadius: 8, border: `1px solid ${P.stoneP}`, fontSize: 13, outline: "none", boxSizing: "border-box", fontFamily: "inherit" };
    const bP = { padding: "8px 18px", borderRadius: 10, border: "none", cursor: "pointer", background: P.terra, color: "#fff", fontSize: 13, fontWeight: 600 };
    const bS = { padding: "4px 12px", borderRadius: 8, border: "none", cursor: "pointer", fontSize: 12, fontWeight: 500 };
    const lb = { fontSize: 11, color: P.txtL, display: "block", marginBottom: 3 };
    const safeArr = (v) => Array.isArray(v) ? v : v && typeof v === "object" ? Object.values(v) : [];

    function useStorage(key, def) {
      const [d, setD] = useState(() => {
        try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : def; } catch { return def; }
      });
      const [ok, setOk] = useState(true);
      const fbOk = React.useRef(false);
      useEffect(() => {
        const ref = db.ref(key);
        const handler = ref.on("value", (snap) => {
          fbOk.current = true;
          const val = snap.exists() ? snap.val() : def;
          if (!snap.exists()) ref.set(def);
          setD(val);
          try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
        }, () => { fbOk.current = false; });
        return () => ref.off("value", handler);
      }, [key]);
      const save = useCallback((n) => {
        setD(n);
        try { localStorage.setItem(key, JSON.stringify(n)); } catch {}
        if (fbOk.current) db.ref(key).set(n);
      }, [key]);
      return [d, save, ok];
    }

    function useFirebaseConnected() {
      const [connected, setConnected] = useState(true);
      useEffect(() => {
        const ref = db.ref(".info/connected");
        const handler = ref.on("value", snap => setConnected(snap.val() === true));
        return () => ref.off("value", handler);
      }, []);
      return connected;
    }

    function toGBP(a, c) { return c === "EUR" ? Math.round(a / EUR_RATE) : a; }

    function downloadCSV(filename, rows) {
      const csv = rows.map(r => r.map(c => `"${String(c ?? "").replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    }

    /* ========== COUNTDOWN ========== */
    function DashTab({ data, saveMilestones, gC, cC, upPay, vendors, guests, timeline, allData, saveFns }) {
      const { budget, milestones } = data;
      const [showDone, setShowDone] = useState(false);
      const fileRef = React.useRef(null);
      const now = new Date();
      const diff = WEDDING_DATE - now;
      const days = Math.floor(diff / 86400000);
      const months = Math.floor(days / 30.44);
      const weeks = Math.floor(days / 7);
      const tE = BUDGET_CATS.reduce((s, c) => s + c.estimate, 0);
      const tA = BUDGET_CATS.reduce((s, c) => s + toGBP(budget[c.id]?.actual || 0, budget[c.id]?.currency || "GBP"), 0);
      const tP = BUDGET_CATS.reduce((s, c) => s + toGBP(budget[c.id]?.paid || 0, budget[c.id]?.currency || "GBP"), 0);
      const upcoming = [...milestones].filter(m => !m.done).sort((a, b) => new Date(a.due) - new Date(b.due));
      const overdue = milestones.filter(m => !m.done && new Date(m.due) < now);
      const completed = milestones.filter(m => m.done).length;
      const toggleM = (task) => { const i = milestones.findIndex(m => m.task === task); if (i < 0) return; const u = [...milestones]; u[i] = { ...u[i], done: !u[i].done }; saveMilestones(u); };

      return (
        <div>
          <div style={{ background: `linear-gradient(135deg, ${P.terra}, ${P.terraL})`, borderRadius: 20, padding: "34px 26px", marginBottom: 22, color: "#fff", position: "relative", overflow: "hidden" }}>
            <div style={{ position: "absolute", top: -40, right: -20, fontSize: 180, opacity: 0.08, fontFamily: "Georgia" }}>{"\u2661"}</div>
            <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 13, letterSpacing: 3, textTransform: "uppercase", opacity: 0.85, marginBottom: 5 }}>Joe & Sophie {"\u2014"} Tuscany 2027</div>
            <div style={{ display: "flex", gap: 32, alignItems: "baseline", flexWrap: "wrap" }}>
              <div><span style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 64, fontWeight: 700, lineHeight: 1 }}>{days}</span><span style={{ fontSize: 16, marginLeft: 8, opacity: 0.85 }}>days to go</span></div>
              <div style={{ display: "flex", gap: 18, fontSize: 13, opacity: 0.9 }}><div><strong>{months}</strong> months</div><div><strong>{weeks}</strong> weeks</div><div>Sat <strong>29 May 2027</strong></div></div>
            </div>
            <div style={{ marginTop: 12, fontSize: 12, opacity: 0.75 }}>La Conca, Sansepolcro {"\u00B7"} {gC > 0 ? `${cC} confirmed / ${gC} invited` : "~50 guests"}</div>
          </div>

          {/* Countdown Badges */}
          {(() => {
            const badges = [];
            // Next milestone
            const nextM = [...milestones].filter(m => !m.done && new Date(m.due) >= now).sort((a,b) => new Date(a.due) - new Date(b.due))[0];
            if (nextM) { const d = Math.ceil((new Date(nextM.due) - now) / 86400000); badges.push({ l: nextM.task.length > 25 ? nextM.task.slice(0,23) + "\u2026" : nextM.task, d, icon: "\u25CB" }); }
            // RSVP deadline
            const rsvpM = milestones.find(m => m.task.toLowerCase().includes("rsvp") && !m.done);
            if (rsvpM && (!nextM || rsvpM.task !== nextM.task)) { const d = Math.ceil((new Date(rsvpM.due) - now) / 86400000); badges.push({ l: "RSVP Deadline", d, icon: "\u2709" }); }
            // Next payment
            if (upPay.length > 0) { const d = Math.ceil((new Date(upPay[0].date) - now) / 86400000); badges.push({ l: `${BUDGET_CATS.find(c=>c.id===upPay[0].catId)?.name||"Payment"} \u2014 ${upPay[0].label}`, d, icon: "\u00A3" }); }
            // Info pack
            const infoM = milestones.find(m => m.task.toLowerCase().includes("info pack") && !m.done);
            if (infoM && (!nextM || infoM.task !== nextM.task)) { const d = Math.ceil((new Date(infoM.due) - now) / 86400000); badges.push({ l: "Guest Info Pack", d, icon: "\u2709" }); }
            return badges.length > 0 ? (
              <div style={{ display: "flex", gap: 8, marginBottom: 18, overflowX: "auto", paddingBottom: 2 }}>
                {badges.slice(0,4).map((b,i) => {
                  const col = b.d < 0 ? P.red : b.d <= 14 ? P.red : b.d <= 60 ? P.gold : P.green;
                  const bg = b.d < 0 ? P.redP : b.d <= 14 ? P.redP : b.d <= 60 ? P.goldP : P.greenP;
                  return (
                    <div key={i} style={{ flex: "0 0 auto", minWidth: 130, background: bg, borderRadius: 12, padding: "10px 14px", borderLeft: `4px solid ${col}` }}>
                      <div style={{ fontSize: 20, fontWeight: 700, color: col, fontFamily: "'Playfair Display', Georgia, serif" }}>{Math.abs(b.d)}d</div>
                      <div style={{ fontSize: 9, color: col, fontWeight: 600 }}>{b.d < 0 ? "OVERDUE" : b.d === 0 ? "TODAY" : "to go"}</div>
                      <div style={{ fontSize: 10, color: P.txtM, marginTop: 3, lineHeight: 1.2 }}>{b.l}</div>
                    </div>
                  );
                })}
              </div>
            ) : null;
          })()}

          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(150px, 1fr))", gap: 10, marginBottom: 22 }}>
            {[
              { l: "Estimated", v: `\u00A3${tE.toLocaleString()}`, s: "target", c: P.stone },
              { l: "Committed", v: `\u00A3${tA.toLocaleString()}`, s: `${tE ? Math.round(tA/tE*100) : 0}%`, c: P.terra },
              { l: "Paid", v: `\u00A3${tP.toLocaleString()}`, s: `\u00A3${(tA-tP).toLocaleString()} due`, c: P.olive },
              { l: "Milestones", v: `${completed}/${milestones.length}`, s: overdue.length ? `${overdue.length} overdue` : "on track", c: overdue.length ? P.red : P.green },
              { l: "Per Head", v: (() => { const hc = guests.filter(g=>g.status!=="Declined").reduce((s,g)=>s+1+(g.plusOne?1:0)+(g.children||0),0); return hc > 0 ? `\u00A3${Math.round(tA/hc).toLocaleString()}` : "\u2014"; })(), s: `${guests.filter(g=>g.status!=="Declined").reduce((s,g)=>s+1+(g.plusOne?1:0)+(g.children||0),0)} heads`, c: P.blue },
            ].map((s, i) => (
              <div key={i} style={{ background: P.card, borderRadius: 14, padding: "14px 12px", boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `4px solid ${s.c}` }}>
                <div style={{ fontSize: 10, color: P.txtL, textTransform: "uppercase", letterSpacing: 1, marginBottom: 2 }}>{s.l}</div>
                <div style={{ fontSize: 22, fontWeight: 700, color: P.txt, fontFamily: "'Playfair Display', Georgia, serif" }}>{s.v}</div>
                <div style={{ fontSize: 10, color: s.s?.includes("overdue") ? P.red : P.txtM, marginTop: 1 }}>{s.s}</div>
              </div>
            ))}
          </div>

          {upPay.length > 0 && (
            <div style={{ background: P.card, borderRadius: 14, padding: 18, marginBottom: 18, boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `4px solid ${P.gold}` }}>
              <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 15, fontWeight: 700, color: P.txt, marginBottom: 10 }}>{"\uD83D\uDCB0"} Upcoming Payments</div>
              {upPay.slice(0, 4).map((p, i) => {
                const ov = new Date(p.date) < now;
                return (
                  <div key={i} style={{ display: "flex", alignItems: "center", gap: 8, padding: "7px 0", borderBottom: i < Math.min(upPay.length, 4) - 1 ? `1px solid ${P.bgD}` : "none" }}>
                    <span style={{ fontSize: 15 }}>{BUDGET_CATS.find(c => c.id === p.catId)?.icon}</span>
                    <div style={{ flex: 1 }}><div style={{ fontSize: 12, fontWeight: 600, color: P.txt }}>{BUDGET_CATS.find(c => c.id === p.catId)?.name} {"\u2014"} {p.label}</div>
                    <div style={{ fontSize: 10, color: ov ? P.red : P.txtL }}>{new Date(p.date).toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" })}{ov ? " \u2014 overdue" : ""}</div></div>
                    <div style={{ fontSize: 13, fontWeight: 700, color: ov ? P.red : P.txt }}>{p.currency === "EUR" ? "\u20AC" : "\u00A3"}{p.amount.toLocaleString()}</div>
                  </div>
                );
              })}
            </div>
          )}

          <div style={{ background: P.card, borderRadius: 14, padding: 18, boxShadow: "0 1px 4px rgba(0,0,0,0.04)" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
              <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 15, fontWeight: 700, color: P.txt }}>Milestones</div>
              <button onClick={() => setShowDone(!showDone)} style={{ ...bS, background: showDone ? P.oliveP : P.bgD, color: showDone ? P.olive : P.txtM, padding: "3px 10px", fontSize: 11 }}>
                {showDone ? `Hide done (${completed})` : `Show done (${completed})`}
              </button>
            </div>
            {showDone && milestones.filter(m => m.done).map((m, i) => (
              <div key={"d"+i} style={{ display: "flex", alignItems: "center", gap: 9, padding: "7px 0", borderBottom: `1px solid ${P.bgD}`, opacity: 0.45 }}>
                <button onClick={() => toggleM(m.task)} style={{ width: 18, height: 18, borderRadius: 5, border: `2px solid ${P.green}`, background: P.green, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 10, flexShrink: 0 }}>{"\u2713"}</button>
                <div style={{ fontSize: 12, color: P.txt, textDecoration: "line-through" }}>{m.task}</div>
              </div>
            ))}
            {upcoming.map((m, i) => {
              const due = new Date(m.due); const ov = due < now; const dU = Math.ceil((due - now) / 86400000);
              return (
                <div key={i} style={{ display: "flex", alignItems: "center", gap: 9, padding: "8px 0", borderBottom: i < upcoming.length - 1 ? `1px solid ${P.bgD}` : "none" }}>
                  <button onClick={() => toggleM(m.task)} style={{ width: 18, height: 18, borderRadius: 5, border: `2px solid ${ov ? P.red : P.terra}`, background: "transparent", cursor: "pointer", flexShrink: 0 }} />
                  <div style={{ flex: 1 }}><div style={{ fontSize: 12, color: P.txt }}>{m.task}</div>
                  <div style={{ fontSize: 10, color: ov ? P.red : P.txtL, marginTop: 1 }}>{due.toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" })}{ov ? ` \u2014 ${Math.abs(dU)}d overdue` : dU <= 60 ? ` \u2014 ${dU}d` : ""}</div></div>
                </div>
              );
            })}
          </div>

          {/* RSVP Tracker */}
          {(() => {
            const invited = (guests||[]).filter(g => g.status === "Invited");
            const pending = (guests||[]).filter(g => g.status === "Pending");
            const confirmed = (guests||[]).filter(g => g.status === "Confirmed");
            const declined = (guests||[]).filter(g => g.status === "Declined");
            const awaiting = [...invited, ...pending];
            const rsvpM = milestones.find(m => m.task.toLowerCase().includes("rsvp"));
            const rsvpDue = rsvpM ? new Date(rsvpM.due) : null;
            const rsvpDays = rsvpDue ? Math.ceil((rsvpDue - now) / 86400000) : null;
            return (guests||[]).length > 0 ? (
              <div style={{ background: P.card, borderRadius: 14, padding: 18, marginTop: 18, boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `4px solid ${P.blue}` }}>
                <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 15, fontWeight: 700, color: P.txt, marginBottom: 10 }}>{"\u2709"} RSVP Tracker</div>
                <div style={{ display: "flex", gap: 8, marginBottom: 10, flexWrap: "wrap" }}>
                  {[{ l: "Confirmed", v: confirmed.length, bg: P.greenP, c: P.green }, { l: "Invited", v: invited.length, bg: P.goldP, c: P.gold }, { l: "Pending", v: pending.length, bg: P.blueP, c: P.blue }, { l: "Declined", v: declined.length, bg: P.redP, c: P.red }].map((s, i) => (
                    <span key={i} style={{ padding: "3px 10px", borderRadius: 12, fontSize: 11, fontWeight: 600, background: s.bg, color: s.c }}>{s.v} {s.l}</span>
                  ))}
                </div>
                {rsvpDue && <div style={{ fontSize: 11, color: rsvpDays < 0 ? P.red : P.txtM, marginBottom: 8 }}>{rsvpDays > 0 ? `${rsvpDays} days until RSVP deadline` : rsvpDays === 0 ? "RSVP deadline is today" : `RSVP deadline was ${Math.abs(rsvpDays)} days ago`} ({rsvpDue.toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" })})</div>}
                {awaiting.length > 0 && (
                  <div>
                    <div style={{ fontSize: 11, fontWeight: 600, color: P.gold, marginBottom: 5 }}>Awaiting response ({awaiting.length})</div>
                    <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                      {awaiting.slice(0, 12).map(g => (<span key={g.id} style={{ padding: "2px 8px", borderRadius: 10, background: P.goldP, fontSize: 10, color: P.gold }}>{g.name}</span>))}
                      {awaiting.length > 12 && <span style={{ fontSize: 10, color: P.txtL, padding: "2px 4px" }}>+{awaiting.length - 12} more</span>}
                    </div>
                  </div>
                )}
              </div>
            ) : null;
          })()}

          {/* Quick Contacts */}
          {(() => {
            const keyVendors = (vendors||[]).filter(v => v.starred || ["Booked","Paid Deposit","Paid in Full"].includes(v.status)).slice(0, 8);
            return keyVendors.length > 0 ? (
              <div style={{ background: P.card, borderRadius: 14, padding: 18, marginTop: 18, boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `4px solid ${P.olive}` }}>
                <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 15, fontWeight: 700, color: P.txt, marginBottom: 10 }}>{"\u260E"} Key Contacts</div>
                {keyVendors.map((v, i) => (
                  <div key={v.id} style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 0", borderBottom: i < keyVendors.length - 1 ? `1px solid ${P.bgD}` : "none" }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 12, fontWeight: 600, color: P.txt }}>{v.starred ? "\u2B50 " : ""}{v.name}</div>
                      <div style={{ fontSize: 10, color: P.txtL }}>{v.category}</div>
                    </div>
                    <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
                      {v.phone && <a href={`tel:${v.phone}`} style={{ fontSize: 10, color: P.blue, textDecoration: "none" }}>{v.phone}</a>}
                      {v.email && <a href={`mailto:${v.email}`} style={{ fontSize: 10, color: P.blue, textDecoration: "none" }}>{v.email}</a>}
                      {v.website && <a href={`https://${v.website.replace(/^https?:\/\//, "")}`} target="_blank" rel="noopener" style={{ fontSize: 10, color: P.blue, textDecoration: "none" }}>{"\uD83C\uDF10"}</a>}
                    </div>
                  </div>
                ))}
              </div>
            ) : null;
          })()}

          {/* Backup & Export */}
          <div style={{ background: P.card, borderRadius: 14, padding: 18, marginTop: 18, boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `4px solid ${P.stone}` }}>
            <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 15, fontWeight: 700, color: P.txt, marginBottom: 10 }}>{"\uD83D\uDCBE"} Backup & Restore</div>
            <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
              <button onClick={() => {
                const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
                const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `wedding-backup-${new Date().toISOString().split("T")[0]}.json`; a.click();
              }} style={{ ...bP, background: P.olive }}>{"\u2B07"} Export All Data</button>
              <button onClick={() => fileRef.current?.click()} style={{ ...bP, background: P.stone }}>{"\u2B06"} Import Backup</button>
              <input ref={fileRef} type="file" accept=".json" style={{ display: "none" }} onChange={e => {
                const file = e.target.files?.[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                  try {
                    const d = JSON.parse(reader.result);
                    if (d.budget) saveFns.saveBudget(d.budget);
                    if (d.guests) saveFns.saveGuests(d.guests);
                    if (d.vendors) saveFns.saveVendors(d.vendors);
                    if (d.timeline) saveFns.saveTimeline(d.timeline);
                    if (d.milestones) saveFns.saveMilestones(d.milestones);
                    if (d.decisions) saveFns.saveDecisions(d.decisions);
                    if (d.music) saveFns.saveMusic(d.music);
                    if (d.packing) saveFns.savePacking(d.packing);
                    if (d.seating) saveFns.saveSeating(d.seating);
                    if (d.rooms) saveFns.saveRooms(d.rooms);
                    if (d.contingency) saveFns.saveContingency(d.contingency);
                    if (d.legalChecklist) saveFns.saveLegalChecklist(d.legalChecklist);
                    if (d.speeches) saveFns.saveSpeeches(d.speeches);
                    if (d.eurRate) saveFns.saveEurRate(d.eurRate);
                    if (d.prepChecklist) saveFns.savePrepChecklist(d.prepChecklist);
                    alert("Backup restored successfully!");
                  } catch { alert("Invalid backup file"); }
                };
                reader.readAsText(file);
                e.target.value = "";
              }} />
            </div>
            <div style={{ fontSize: 10, color: P.txtL, marginTop: 6 }}>Export saves all tabs to a JSON file. Import restores from a previous backup.</div>
            <div style={{ fontSize: 9, color: P.stoneL, marginTop: 4 }} title="Go to Firebase Console ‚Üí Realtime Database ‚Üí Rules to configure read/write access">{"\uD83D\uDD12"} Firebase Security Rules should be configured in the Firebase Console for production use.</div>
          </div>

          {/* Destination Guide */}
          {(() => {
            const [expGuide, setExpGuide] = React.useState(null);
            const sections = [
              { id: "travel", title: "Travel & Documents", icon: "\u2708", color: P.blue, items: [
                { q: "Passport", a: "Valid UK passport required. Must not expire within 3 months of return date. Check all guests!" },
                { q: "Visa", a: "UK citizens: no visa needed for stays under 90 days in the EU (post-Brexit rule)." },
                { q: "Health Cover", a: "GHIC (Global Health Insurance Card) covers emergency treatment in Italy. Apply free via NHS. Travel insurance still essential." },
                { q: "Travel Insurance", a: "Get wedding-specific travel insurance covering supplier failure, cancellation, and medical repatriation." },
                { q: "Driving", a: "UK driving licence valid in Italy. Drive on the right. ZTL zones in town centres \u2014 avoid or risk fines." },
              ]},
              { id: "emergency", title: "Emergency Contacts", icon: "\uD83D\uDEA8", color: P.red, items: [
                { q: "Emergency Number", a: "112 (pan-European). Works for police, ambulance, fire." },
                { q: "Nearest Hospital", a: "Ospedale Valtiberina, Sansepolcro (~10 min from La Conca). A&E available." },
                { q: "Pharmacy", a: "Farmacia Comunale Sansepolcro, Via XX Settembre. Open Mon\u2013Sat. Night rota posted on door." },
                { q: "UK Consulate", a: "British Consulate General, Florence. +39 055 284133. For passport loss / emergencies." },
              ]},
              { id: "local", title: "Local Area", icon: "\uD83D\uDDFA", color: P.olive, items: [
                { q: "Sansepolcro", a: "Charming medieval town, 10 min from villas. Birthplace of Piero della Francesca. Good restaurants & shops." },
                { q: "Supermarket", a: "Conad Sansepolcro (10 min). Open daily 8:30\u201320:00, closed Sun afternoon." },
                { q: "ATM / Cash", a: "ATMs in Sansepolcro centre. Italy is card-friendly but carry cash for markets and small bars." },
                { q: "Market Days", a: "Sansepolcro: Saturday morning. Arezzo: first Sunday of month (famous antique market in Piazza Grande)." },
                { q: "WiFi", a: "Both villas have WiFi. Passwords in your welcome pack. Mobile signal can be patchy in valleys." },
              ]},
              { id: "weather", title: "May Weather", icon: "\u2600", color: P.gold, items: [
                { q: "Temperature", a: "Avg highs 22\u201326\u00B0C. Evenings cool to 12\u201315\u00B0C \u2014 bring a wrap for outdoor dinner." },
                { q: "Rain", a: "May averages 6\u20137 rainy days. Usually short afternoon showers. Mornings are reliably sunny." },
                { q: "UV Index", a: "High (6\u20138). SPF 30+ essential, especially by the pool. Hats recommended for ceremony." },
                { q: "What to Wear", a: "Light layers, comfortable shoes for gravel paths. Smart casual for dinners. Swimwear for pool days." },
              ]},
            ];
            return (
              <div style={{ background: P.card, borderRadius: 14, padding: 18, marginTop: 18, boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `4px solid ${P.blue}` }}>
                <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 15, fontWeight: 700, color: P.txt, marginBottom: 4 }}>{"\uD83C\uDDEE\uD83C\uDDF9"} Destination Guide</div>
                <div style={{ fontSize: 11, color: P.txtL, marginBottom: 12 }}>Everything your guests need to know about travelling to Tuscany</div>
                {sections.map(sec => {
                  const isE = expGuide === sec.id;
                  return (
                    <div key={sec.id} style={{ marginBottom: 4 }}>
                      <div onClick={() => setExpGuide(isE ? null : sec.id)} style={{
                        display: "flex", alignItems: "center", gap: 8, padding: "9px 10px", cursor: "pointer",
                        background: isE ? `${sec.color}10` : P.bgD, borderRadius: isE ? "10px 10px 0 0" : 10, transition: "background 0.15s",
                      }}>
                        <span style={{ fontSize: 14 }}>{sec.icon}</span>
                        <span style={{ flex: 1, fontSize: 12, fontWeight: 600, color: P.txt }}>{sec.title}</span>
                        <span style={{ fontSize: 13, color: P.stoneL, transform: isE ? "rotate(90deg)" : "none", transition: "transform 0.2s" }}>{"\u203A"}</span>
                      </div>
                      {isE && (
                        <div style={{ background: `${sec.color}08`, borderRadius: "0 0 10px 10px", padding: "4px 10px 10px" }}>
                          {sec.items.map((item, i) => (
                            <div key={i} style={{ padding: "8px 0", borderBottom: i < sec.items.length - 1 ? `1px solid ${P.bgD}` : "none" }}>
                              <div style={{ fontSize: 11, fontWeight: 600, color: sec.color }}>{item.q}</div>
                              <div style={{ fontSize: 10, color: P.txtM, lineHeight: 1.4, marginTop: 2 }}>{item.a}</div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            );
          })()}

          {/* Guest Info Pack Export */}
          <button onClick={() => {
            const tl = timeline || [];
            const scheduleHtml = tl.map(day => `<h3 style="color:${day.color||"#333"};margin:14px 0 6px">${day.day}</h3><table style="width:100%;border-collapse:collapse;font-size:13px">${safeArr(day.items || day.events).map(ev => `<tr><td style="padding:4px 8px;border-bottom:1px solid #eee;width:60px;font-weight:600">${ev.time}</td><td style="padding:4px 8px;border-bottom:1px solid #eee">${ev.event}${ev.vendor?` <span style="color:#888;font-size:11px">(${ev.vendor})</span>`:""}</td></tr>`).join("")}</table>`).join("");
            const guestCount = (guests||[]).filter(g => g.status !== "Declined").reduce((s, g) => s + 1 + (g.plusOne ? 1 : 0) + (g.children || 0), 0);
            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Sophie & Joe ‚Äî Wedding Info Pack</title><style>@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;600&display=swap');body{font-family:'Inter',sans-serif;max-width:700px;margin:0 auto;padding:30px;color:#3D2B1F;line-height:1.6}h1{font-family:'Playfair Display',serif;color:#3D2B1F;text-align:center;margin-bottom:4px}h2{font-family:'Playfair Display',serif;color:#8B6F47;border-bottom:2px solid #F5E6D3;padding-bottom:6px;margin-top:30px}h3{font-family:'Playfair Display',serif}.header{text-align:center;margin-bottom:30px}.subtitle{text-align:center;color:#888;font-size:14px}@media print{body{padding:20px}}</style></head><body><div class="header"><h1>\uD83D\uDC90 Sophie & Joe</h1><p class="subtitle">29 May 2027 ‚Äî La Conca del Sole, Sansepolcro, Tuscany</p><p class="subtitle">${guestCount} guests</p></div><h2>\uD83D\uDCC5 Schedule</h2>${scheduleHtml}<h2>\u2708\uFE0F Travel & Documents</h2><ul><li><strong>Passport:</strong> Valid UK passport required (3+ months validity)</li><li><strong>Visa:</strong> Not needed for UK citizens (under 90 days)</li><li><strong>Health:</strong> GHIC card + travel insurance recommended</li><li><strong>Driving:</strong> UK licence valid in Italy ‚Äî drive on the right</li></ul><h2>\uD83D\uDEA8 Emergency Info</h2><ul><li><strong>Emergency:</strong> 112</li><li><strong>Hospital:</strong> Ospedale Valtiberina, Sansepolcro (~10 min)</li><li><strong>Pharmacy:</strong> Farmacia Comunale, Via XX Settembre, Sansepolcro</li><li><strong>UK Consulate:</strong> Florence ‚Äî +39 055 284133</li></ul><h2>\u2600\uFE0F May Weather</h2><ul><li>Highs 22‚Äì26¬∞C, evenings 12‚Äì15¬∞C ‚Äî bring a wrap</li><li>May averages 6‚Äì7 rainy days ‚Äî usually short afternoon showers</li><li>UV index 6‚Äì8 ‚Äî SPF 30+ essential</li></ul><div style="text-align:center;margin-top:40px;color:#ccc;font-size:11px">Generated from the Wedding Dashboard</div></body></html>`;
            const w = window.open("", "_blank");
            w.document.write(html);
            w.document.close();
          }} style={{ ...bP, width: "100%", marginTop: 14, padding: "12px 16px", borderRadius: 12, fontSize: 12, display: "flex", alignItems: "center", justifyContent: "center", gap: 8 }}>
            {"\uD83D\uDCE8"} Generate Guest Info Pack
          </button>
        </div>
      );
    }

    /* ========== BUDGET ========== */
    function BudgetTab({ budget, saveBudget, vendors, eurRate, saveEurRate }) {
      const [editing, setEditing] = useState(null);
      const [showEur, setShowEur] = useState(false);
      const tE = BUDGET_CATS.reduce((s, c) => s + c.estimate, 0);
      const tA = BUDGET_CATS.reduce((s, c) => s + toGBP(budget[c.id]?.actual || 0, budget[c.id]?.currency || "GBP"), 0);
      const tP = BUDGET_CATS.reduce((s, c) => s + toGBP(budget[c.id]?.paid || 0, budget[c.id]?.currency || "GBP"), 0);
      const pct = tE ? Math.round(tA / tE * 100) : 0;
      const dA = (g) => showEur ? `\u20AC${Math.round(g * EUR_RATE).toLocaleString()}` : `\u00A3${g.toLocaleString()}`;

      const upd = (id, f, v) => saveBudget({ ...budget, [id]: { ...budget[id], [f]: parseFloat(v) || 0 } });
      const setCur = (id, c) => saveBudget({ ...budget, [id]: { ...budget[id], currency: c } });
      const setNotes = (id, n) => saveBudget({ ...budget, [id]: { ...budget[id], notes: n } });
      const updPay = (cid, pi, f, v) => {
        const b = { ...budget[cid] }; const ps = [...(b.payments || [])];
        ps[pi] = { ...ps[pi], [f]: f === "amount" ? (parseFloat(v) || 0) : v };
        const paid = ps.filter(p => p.paid).reduce((s, p) => s + p.amount, 0);
        saveBudget({ ...budget, [cid]: { ...b, payments: ps, paid } });
      };
      const addPay = (cid) => { const b = { ...budget[cid] }; const ps = [...(b.payments || [])]; ps.push({ label: "Payment " + (ps.length + 1), amount: 0, date: "", paid: false }); saveBudget({ ...budget, [cid]: { ...b, payments: ps } }); };
      const rmPay = (cid, pi) => { if (!window.confirm("Remove this payment?")) return; const b = { ...budget[cid] }; const ps = [...(b.payments || [])].filter((_, i) => i !== pi); const paid = ps.filter(p => p.paid).reduce((s, p) => s + p.amount, 0); saveBudget({ ...budget, [cid]: { ...b, payments: ps, paid } }); };

      const exportBudget = () => {
        const rows = [["Category", "Estimate (\u00A3)", "Actual", "Currency", "Actual (\u00A3)", "Paid", "Outstanding (\u00A3)", "Notes"]];
        BUDGET_CATS.forEach(c => { const b = budget[c.id] || {}; const aG = toGBP(b.actual || 0, b.currency || "GBP"); rows.push([c.name, c.estimate, b.actual || 0, b.currency || "GBP", aG, toGBP(b.paid || 0, b.currency || "GBP"), aG - toGBP(b.paid || 0, b.currency || "GBP"), b.notes || ""]); });
        rows.push([]); rows.push(["TOTAL", tE, "", "", tA, tP, tA - tP, ""]);
        downloadCSV("wedding-budget.csv", rows);
      };

      return (
        <div>
          <div style={{ background: P.card, borderRadius: 14, padding: 20, marginBottom: 16, boxShadow: "0 1px 4px rgba(0,0,0,0.04)" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 12, flexWrap: "wrap", gap: 8 }}>
              <div>
                <div style={{ fontSize: 10, color: P.txtL, textTransform: "uppercase", letterSpacing: 1 }}>Total Budget</div>
                <div style={{ fontSize: 26, fontWeight: 700, color: P.txt, fontFamily: "'Playfair Display', Georgia, serif" }}>{dA(tA)} <span style={{ fontSize: 13, color: P.txtL, fontWeight: 400 }}>/ {dA(tE)}</span></div>
              </div>
              <div style={{ display: "flex", flexDirection: "column", alignItems: "flex-end", gap: 5 }}>
                <div style={{ display: "flex", gap: 3 }}>
                  <div style={{ display: "flex", gap: 2, background: P.bgD, borderRadius: 7, padding: 2 }}>
                    {["GBP","EUR"].map(c => (<button key={c} onClick={() => setShowEur(c==="EUR")} style={{ ...bS, background: (c==="EUR")===showEur?P.terra:"transparent", color: (c==="EUR")===showEur?"#fff":P.txtM, padding: "3px 10px", fontSize: 11 }}>{c==="GBP"?"\u00A3":"\u20AC"}</button>))}
                  </div>
                  <button onClick={exportBudget} style={{ ...bS, background: P.oliveP, color: P.olive, padding: "3px 10px", fontSize: 11 }}>{"\u2B07"} CSV</button>
                </div>
                <div style={{ textAlign: "right" }}><div style={{ fontSize: 10, color: P.txtL }}>Paid</div><div style={{ fontSize: 16, fontWeight: 600, color: P.olive }}>{dA(tP)}</div></div>
              </div>
            </div>
            <div style={{ background: P.bgD, borderRadius: 8, height: 8, overflow: "hidden" }}>
              <div style={{ height: "100%", borderRadius: 8, transition: "width 0.5s", width: `${Math.min(pct, 100)}%`, background: pct > 100 ? P.red : `linear-gradient(90deg, ${P.olive}, ${P.oliveL})` }} />
            </div>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: 4 }}><div style={{ fontSize: 10, color: P.txtL }}>{"\u00A3"}1 = {"\u20AC"}<input type="number" step="0.01" value={eurRate} onChange={e => saveEurRate(parseFloat(e.target.value) || 1)} style={{ width: 42, border: "none", borderBottom: `1px solid ${P.stoneL}`, background: "transparent", fontSize: 10, color: P.txtM, textAlign: "center", outline: "none", padding: 0 }} /></div><div style={{ fontSize: 10, color: pct > 100 ? P.red : P.txtL }}>{pct}%</div></div>
          </div>

          {BUDGET_CATS.map(cat => {
            const b = budget[cat.id] || { actual: 0, paid: 0, currency: "GBP", notes: "", payments: [] };
            const isE = editing === cat.id; const aG = toGBP(b.actual, b.currency); const cp = cat.estimate ? Math.round(aG / cat.estimate * 100) : 0;
            const payments = b.payments || []; const next = payments.find(p => !p.paid && p.date); const sym = b.currency === "EUR" ? "\u20AC" : "\u00A3";
            return (
              <div key={cat.id} style={{ background: P.card, borderRadius: 12, padding: "11px 13px", marginBottom: 6, boxShadow: "0 1px 3px rgba(0,0,0,0.03)", border: isE ? `2px solid ${P.terra}` : "2px solid transparent" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8, cursor: "pointer" }} onClick={() => setEditing(isE ? null : cat.id)}>
                  <span style={{ fontSize: 16 }}>{cat.icon}</span>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 12, fontWeight: 600, color: P.txt }}>{cat.name}</div>
                    <div style={{ fontSize: 10, color: P.txtL }}>Est. {showEur ? `\u20AC${Math.round(cat.estimate*EUR_RATE).toLocaleString()}` : `\u00A3${cat.estimate.toLocaleString()}`}{next ? ` \u00B7 Next: ${new Date(next.date).toLocaleDateString("en-GB",{day:"numeric",month:"short"})}` : ""}</div>
                  </div>
                  <div style={{ textAlign: "right" }}>
                    <div style={{ fontSize: 13, fontWeight: 600, color: b.actual > 0 ? P.txt : P.stoneL }}>{b.actual > 0 ? `${sym}${b.actual.toLocaleString()}` : "\u2014"}</div>
                    {b.actual > 0 && <div style={{ fontSize: 10, color: cp > 110 ? P.red : P.txtL }}>{b.paid > 0 ? `${sym}${b.paid.toLocaleString()} paid` : "unpaid"}</div>}
                  </div>
                </div>
                {b.notes && !isE && <div style={{ fontSize: 10, color: P.txtM, marginTop: 5, marginLeft: 26, fontStyle: "italic" }}>{"\uD83D\uDCDD"} {b.notes}</div>}
                {!isE && (() => { const linked = (vendors||[]).filter(v => v.budgetCategory === cat.id && v.quote > 0); return linked.length > 0 ? <div style={{ marginTop: 3, marginLeft: 26 }}>{linked.map(v => <span key={v.id} style={{ fontSize: 9, padding: "1px 6px", borderRadius: 6, background: P.oliveP, color: P.olive, marginRight: 3 }}>{v.name}: {"\u00A3"}{v.quote.toLocaleString()}{b.actual===0 && <button onClick={e=>{e.stopPropagation();upd(cat.id,"actual",v.quote)}} style={{background:"none",border:"none",cursor:"pointer",color:P.blue,fontSize:8,marginLeft:3}}>{"\u2192"} use</button>}</span>)}</div> : null; })()}
                {isE && (
                  <div style={{ marginTop: 10, borderTop: `1px solid ${P.bgD}`, paddingTop: 10 }} onClick={e => e.stopPropagation()}>
                    <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 8 }}>
                      <div style={{ flex: 1, minWidth: 70 }}><label style={lb}>Currency</label>
                        <div style={{ display: "flex", gap: 2, background: P.bgD, borderRadius: 6, padding: 2 }}>
                          {["GBP","EUR"].map(c => (<button key={c} onClick={() => setCur(cat.id, c)} style={{ ...bS, flex: 1, background: b.currency===c?P.olive:"transparent", color: b.currency===c?"#fff":P.txtM, padding: "4px", fontSize: 11 }}>{c==="GBP"?"\u00A3":"\u20AC"}</button>))}
                        </div></div>
                      <div style={{ flex: 2, minWidth: 90 }}><label style={lb}>Total Cost ({sym})</label><input type="number" value={b.actual||""} onChange={e => upd(cat.id,"actual",e.target.value)} style={iS} placeholder="0" /></div>
                      <div style={{ flex: 2, minWidth: 90 }}><label style={lb}>Total Paid ({sym})</label><input type="number" value={b.paid||""} style={{ ...iS, background: "#f5f5f5" }} disabled placeholder="Auto" /></div>
                    </div>
                    {b.actual > 0 && b.currency === "EUR" && <div style={{ fontSize: 10, color: P.txtM, marginBottom: 6 }}>{"\u2248"} {"\u00A3"}{toGBP(b.actual,"EUR").toLocaleString()}</div>}
                    <div style={{ marginBottom: 10 }}><label style={lb}>Notes</label><textarea value={b.notes||""} onChange={e => setNotes(cat.id, e.target.value)} placeholder="Payment ref, contract, key dates..." style={{ ...iS, minHeight: 36, resize: "vertical" }} /></div>
                    <div style={{ background: P.bgD, borderRadius: 10, padding: 10 }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                        <div style={{ fontSize: 11, fontWeight: 600, color: P.txt }}>Payment Schedule</div>
                        <button onClick={() => addPay(cat.id)} style={{ ...bS, background: P.oliveP, color: P.olive, fontSize: 10, padding: "3px 8px" }}>+ Add</button>
                      </div>
                      {payments.map((p, pi) => (
                        <div key={pi} style={{ display: "flex", gap: 5, alignItems: "center", marginBottom: 5, flexWrap: "wrap" }}>
                          <button onClick={() => updPay(cat.id, pi, "paid", !p.paid)} style={{ width: 18, height: 18, borderRadius: 4, border: `2px solid ${p.paid?P.green:P.stoneL}`, background: p.paid?P.green:"transparent", cursor: "pointer", flexShrink: 0, display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 9 }}>{p.paid&&"\u2713"}</button>
                          <input value={p.label} onChange={e => updPay(cat.id,pi,"label",e.target.value)} style={{ ...iS, flex: 2, minWidth: 80, fontSize: 11, padding: "4px 7px" }} />
                          <select value={p.currency || b.currency || "GBP"} onChange={e => updPay(cat.id,pi,"currency",e.target.value)} style={{ ...iS, width: 52, fontSize: 10, padding: "4px 3px", background: "#fff", flexShrink: 0 }}><option value="GBP">¬£</option><option value="EUR">‚Ç¨</option></select>
                          <input type="number" value={p.amount||""} onChange={e => updPay(cat.id,pi,"amount",e.target.value)} style={{ ...iS, flex: 1, minWidth: 55, fontSize: 11, padding: "4px 7px" }} />
                          <input type="date" value={p.date||""} onChange={e => updPay(cat.id,pi,"date",e.target.value)} style={{ ...iS, flex: 1, minWidth: 100, fontSize: 11, padding: "4px 5px" }} />
                          <input value={p.reference||""} onChange={e => updPay(cat.id,pi,"reference",e.target.value)} placeholder="Ref" style={{ ...iS, flex: 1, minWidth: 60, fontSize: 10, padding: "4px 5px" }} />
                          <button onClick={() => rmPay(cat.id, pi)} style={{ background: "none", border: "none", cursor: "pointer", color: P.stoneL, fontSize: 13, padding: "0 3px" }}>{"\u00D7"}</button>
                        </div>
                      ))}
                      {payments.length === 0 && <div style={{ fontSize: 10, color: P.txtL, textAlign: "center", padding: 6 }}>No payments {"\u2014"} click + Add</div>}
                    </div>
                  </div>
                )}
              </div>
            );
          })}

          {/* Payment Schedule */}
          {(() => {
            const allPays = [];
            BUDGET_CATS.forEach(c => { const b = budget[c.id]; if (!b?.payments) return; b.payments.forEach(p => { if (p.date && p.amount > 0) allPays.push({ ...p, catId: c.id, catName: c.name, icon: c.icon, currency: b.currency || "GBP" }); }); });
            if (allPays.length === 0) return null;
            allPays.sort((a,b) => a.date.localeCompare(b.date));
            const byMonth = {};
            allPays.forEach(p => { const k = p.date.substring(0,7); if (!byMonth[k]) byMonth[k] = { paid: 0, unpaid: 0, items: [] }; const g = toGBP(p.amount, p.currency); if (p.paid) byMonth[k].paid += g; else byMonth[k].unpaid += g; byMonth[k].items.push(p); });
            const months = Object.keys(byMonth).sort();
            const max = Math.max(...months.map(k => byMonth[k].paid + byMonth[k].unpaid), 1);
            return (
              <div style={{ background: P.card, borderRadius: 14, padding: 18, marginTop: 16, boxShadow: "0 1px 4px rgba(0,0,0,0.04)" }}>
                <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 15, fontWeight: 700, color: P.txt, marginBottom: 12 }}>Payment Schedule</div>
                <div style={{ display: "flex", gap: 6, overflowX: "auto", paddingBottom: 4 }}>
                  {months.map(m => {
                    const d = byMonth[m]; const total = d.paid + d.unpaid;
                    const monthDate = new Date(m + "-15");
                    const isPast = monthDate < new Date();
                    return (
                      <div key={m} style={{ flex: "0 0 auto", width: 70, textAlign: "center" }}>
                        <div style={{ height: 80, display: "flex", flexDirection: "column", justifyContent: "flex-end", alignItems: "center", gap: 1, marginBottom: 4 }}>
                          {d.unpaid > 0 && <div style={{ width: 32, borderRadius: "4px 4px 0 0", background: isPast && d.unpaid > 0 ? P.red : P.gold, height: `${Math.max(d.unpaid / max * 70, 4)}px` }} />}
                          {d.paid > 0 && <div style={{ width: 32, borderRadius: d.unpaid > 0 ? "0 0 4px 4px" : 4, background: P.olive, height: `${Math.max(d.paid / max * 70, 4)}px` }} />}
                        </div>
                        <div style={{ fontSize: 10, fontWeight: 600, color: P.txt }}>{"\u00A3"}{total.toLocaleString()}</div>
                        <div style={{ fontSize: 9, color: P.txtL }}>{monthDate.toLocaleDateString("en-GB", { month: "short", year: "2-digit" })}</div>
                      </div>
                    );
                  })}
                </div>
                <div style={{ display: "flex", gap: 12, marginTop: 8, fontSize: 10, color: P.txtL }}>
                  <span><span style={{ display: "inline-block", width: 8, height: 8, borderRadius: 2, background: P.olive, marginRight: 3 }} />Paid</span>
                  <span><span style={{ display: "inline-block", width: 8, height: 8, borderRadius: 2, background: P.gold, marginRight: 3 }} />Due</span>
                  <span><span style={{ display: "inline-block", width: 8, height: 8, borderRadius: 2, background: P.red, marginRight: 3 }} />Overdue</span>
                </div>
              </div>
            );
          })()}
        </div>
      );
    }

    /* ========== VENDORS ========== */
    function VendorsTab({ vendors, saveVendors }) {
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const [filter, setFilter] = useState("All");
      const [compare, setCompare] = useState(false);
      const [vSearch, setVSearch] = useState("");
      const [form, setForm] = useState({ name: "", category: "Other", status: "Researching", phone: "", email: "", website: "", notes: "", starred: false });
      const addV = () => { if (!form.name.trim()) return; saveVendors([...vendors, { ...form, id: Date.now() }]); setForm({ name: "", category: "Other", status: "Researching", phone: "", email: "", website: "", notes: "", starred: false }); setShowForm(false); };
      const upV = (id, u) => saveVendors(vendors.map(v => v.id === id ? { ...v, ...u } : v));
      const rmV = (id) => { if (!window.confirm("Remove this vendor?")) return; saveVendors(vendors.filter(v => v.id !== id)); };
      const cats = ["All", ...new Set(vendors.map(v => v.category))];
      const preFil = filter === "All" ? vendors : vendors.filter(v => v.category === filter);
      const fil = vSearch.trim() ? preFil.filter(v => { const s = vSearch.toLowerCase(); return v.name.toLowerCase().includes(s) || (v.category||"").toLowerCase().includes(s) || (v.notes||"").toLowerCase().includes(s) || (v.email||"").toLowerCase().includes(s); }) : preFil;
      const bkd = vendors.filter(v => ["Booked","Paid Deposit","Paid in Full"].includes(v.status)).length;

      return (
        <div>
          <div style={{ display: "flex", gap: 8, marginBottom: 16, flexWrap: "wrap" }}>
            {[{ l: "Total", v: vendors.length, c: P.stone },{ l: "Booked", v: bkd, c: P.green },{ l: "Researching", v: vendors.filter(v => v.status==="Researching").length, c: P.gold }].map((s,i) => (
              <div key={i} style={{ flex: 1, minWidth: 85, background: P.card, borderRadius: 12, padding: "11px 12px", boxShadow: "0 1px 3px rgba(0,0,0,0.03)", borderTop: `3px solid ${s.c}` }}>
                <div style={{ fontSize: 18, fontWeight: 700, color: P.txt }}>{s.v}</div><div style={{ fontSize: 9, color: P.txtL, textTransform: "uppercase", letterSpacing: 1 }}>{s.l}</div></div>))}
          </div>
          <div style={{ marginBottom: 10 }}>
            <input placeholder={"\uD83D\uDD0D Search vendors..."} value={vSearch} onChange={e => setVSearch(e.target.value)} style={{ ...iS, marginBottom: 6, fontSize: 12 }} />
          </div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10, flexWrap: "wrap", gap: 5 }}>
            <div style={{ display: "flex", gap: 3, flexWrap: "wrap" }}>{cats.map(c => (<button key={c} onClick={() => { setFilter(c); if (c === "All") setCompare(false); }} style={{ ...bS, background: filter===c?P.terra:P.bgD, color: filter===c?"#fff":P.txtM, padding: "3px 9px", fontSize: 11 }}>{c}</button>))}</div>
            <div style={{ display: "flex", gap: 4 }}>
              {filter !== "All" && <button onClick={() => setCompare(!compare)} style={{...bS, background: compare ? P.blueP : P.bgD, color: compare ? P.blue : P.txtM, padding: "3px 10px", fontSize: 11}}>{compare ? "\u2630 List" : "\u2194 Compare"}</button>}
              <button onClick={() => setShowForm(!showForm)} style={bP}>+ Add</button>
            </div>
          </div>
          {showForm && (
            <div style={{ background: P.terraP, borderRadius: 14, padding: 14, marginBottom: 10 }}>
              <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                <input placeholder="Name" value={form.name} onChange={e => setForm({...form,name:e.target.value})} style={{ ...iS, flex: 2, minWidth: 130 }} />
                <select value={form.category} onChange={e => setForm({...form,category:e.target.value})} style={{ ...iS, flex: 1, minWidth: 110, background: "#fff" }}>{VENDOR_CATS.map(c => <option key={c}>{c}</option>)}</select>
              </div>
              <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                <input placeholder="Phone" value={form.phone} onChange={e => setForm({...form,phone:e.target.value})} style={{ ...iS, flex: 1, minWidth: 90 }} />
                <input placeholder="Email" value={form.email} onChange={e => setForm({...form,email:e.target.value})} style={{ ...iS, flex: 1, minWidth: 110 }} />
                <input placeholder="Website" value={form.website} onChange={e => setForm({...form,website:e.target.value})} style={{ ...iS, flex: 1, minWidth: 90 }} />
              </div>
              <div style={{ display: "flex", gap: 5 }}><input placeholder="Notes" value={form.notes} onChange={e => setForm({...form,notes:e.target.value})} style={{ ...iS, flex: 1 }} /><button onClick={addV} style={bP}>Add</button></div>
            </div>
          )}
          {compare && filter !== "All" ? (
            <div style={{ overflowX: "auto", paddingBottom: 8 }}>
              <div style={{ display: "flex", gap: 10, minWidth: "min-content" }}>
                {fil.sort((a,b) => (b.starred?1:0)-(a.starred?1:0)).map(v => {
                  const sc = VSC[v.status] || VSC.Researching;
                  return (
                    <div key={v.id} style={{ minWidth: 220, maxWidth: 260, flex: "0 0 auto", background: P.card, borderRadius: 14, padding: 14, boxShadow: "0 1px 4px rgba(0,0,0,0.05)", border: v.starred ? `2px solid ${P.gold}` : `2px solid ${P.bgD}`, display: "flex", flexDirection: "column", gap: 8 }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                        <div>
                          <div style={{ fontSize: 13, fontWeight: 700, color: P.txt }}>{v.starred ? "\u2B50 " : ""}{v.name}</div>
                          <span style={{ padding: "2px 8px", borderRadius: 12, fontSize: 10, fontWeight: 600, background: sc.bg, color: sc.c, display: "inline-block", marginTop: 3 }}>{v.status}</span>
                        </div>
                      </div>
                      {[
                        { l: "Quote", v: v.quote ? `\u00A3${v.quote.toLocaleString()}` : null },
                        { l: "Phone", v: v.phone },
                        { l: "Email", v: v.email },
                        { l: "Website", v: v.website },
                        { l: "Backup", v: v.backupContact ? `${v.backupContact}${v.backupPhone ? ` (${v.backupPhone})` : ""}` : null },
                      ].map(f => f.v ? (
                        <div key={f.l}>
                          <div style={{ fontSize: 9, color: P.txtL, textTransform: "uppercase", letterSpacing: 0.5 }}>{f.l}</div>
                          <div style={{ fontSize: 11, color: P.txt, wordBreak: "break-all" }}>{f.v}</div>
                        </div>
                      ) : null)}
                      {v.notes && (
                        <div>
                          <div style={{ fontSize: 9, color: P.txtL, textTransform: "uppercase", letterSpacing: 0.5 }}>Notes</div>
                          <div style={{ fontSize: 10, color: P.txtM, lineHeight: 1.4 }}>{v.notes}</div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          ) : fil.sort((a,b)=>(b.starred?1:0)-(a.starred?1:0)).map(v => {
            const isE = editing===v.id; const sc = VSC[v.status]||VSC.Researching;
            return (
              <div key={v.id} style={{ background: P.card, borderRadius: 12, padding: "11px 13px", marginBottom: 6, boxShadow: "0 1px 3px rgba(0,0,0,0.03)", border: isE?`2px solid ${P.terra}`:v.starred?`2px solid ${P.goldP}`:"2px solid transparent" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 7, cursor: "pointer" }} onClick={() => setEditing(isE?null:v.id)}>
                  <button onClick={e=>{e.stopPropagation();upV(v.id,{starred:!v.starred})}} style={{ background:"none",border:"none",cursor:"pointer",fontSize:15,padding:0 }}>{v.starred?"\u2B50":"\u2606"}</button>
                  <div style={{ flex: 1 }}><div style={{ fontSize: 12, fontWeight: 600, color: P.txt }}>{v.name}</div><div style={{ fontSize: 10, color: P.txtL }}>{v.category}{v.phone?` \u00B7 ${v.phone}`:""}{v.email?` \u00B7 ${v.email}`:""}{v.quote?` \u00B7 \u00A3${v.quote.toLocaleString()}`:""}</div></div>
                  <span style={{ padding: "2px 8px", borderRadius: 12, fontSize: 10, fontWeight: 600, background: sc.bg, color: sc.c }}>{v.status}</span>
                </div>
                {v.cancellationDeadline && !isE && (() => { const d = Math.ceil((new Date(v.cancellationDeadline) - new Date()) / 86400000); return d <= 14 && d > 0 ? <div style={{ fontSize: 10, color: P.red, marginTop: 3, marginLeft: 28 }}>{"\u26A0"} Cancel deadline in {d} day{d!==1?"s":""}</div> : null; })()}
                {v.notes && !isE && <div style={{ fontSize: 10, color: P.txtM, marginTop: 5, marginLeft: 28 }}>{v.notes}</div>}
                {isE && (
                  <div style={{ marginTop: 10, borderTop: `1px solid ${P.bgD}`, paddingTop: 10 }} onClick={e=>e.stopPropagation()}>
                    <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                      <div style={{ flex: 2, minWidth: 120 }}><label style={lb}>Name</label><input value={v.name} onChange={e=>upV(v.id,{name:e.target.value})} style={iS} /></div>
                      <div style={{ flex: 1, minWidth: 100 }}><label style={lb}>Status</label><select value={v.status} onChange={e=>upV(v.id,{status:e.target.value})} style={{...iS,background:"#fff"}}>{VENDOR_STATUSES.map(s=><option key={s}>{s}</option>)}</select></div>
                    </div>
                    <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                      <div style={{ flex: 1, minWidth: 90 }}><label style={lb}>Phone</label><input value={v.phone||""} onChange={e=>upV(v.id,{phone:e.target.value})} style={iS} /></div>
                      <div style={{ flex: 1, minWidth: 110 }}><label style={lb}>Email</label><input value={v.email||""} onChange={e=>upV(v.id,{email:e.target.value})} style={iS} /></div>
                      <div style={{ flex: 1, minWidth: 90 }}><label style={lb}>Website</label><input value={v.website||""} onChange={e=>upV(v.id,{website:e.target.value})} style={iS} /></div>
                    </div>
                    <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                      <div style={{ flex: 1, minWidth: 100 }}><label style={lb}>Backup Contact</label><input value={v.backupContact||""} onChange={e=>upV(v.id,{backupContact:e.target.value})} placeholder="Name" style={iS} /></div>
                      <div style={{ flex: 1, minWidth: 90 }}><label style={lb}>Backup Phone</label><input value={v.backupPhone||""} onChange={e=>upV(v.id,{backupPhone:e.target.value})} placeholder="+39..." style={iS} /></div>
                    </div>
                    <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                      <div style={{ flex: 1, minWidth: 90 }}><label style={lb}>Quote ({"\u00A3"})</label><input type="number" value={v.quote||""} onChange={e=>upV(v.id,{quote:parseFloat(e.target.value)||0})} style={iS} placeholder="0" /></div>
                      <div style={{ flex: 1, minWidth: 100 }}><label style={lb}>Quote Date</label><input type="date" value={v.quoteDate||""} onChange={e=>upV(v.id,{quoteDate:e.target.value})} style={iS} /></div>
                      <div style={{ flex: 1, minWidth: 110 }}><label style={lb}>Budget Category</label><select value={v.budgetCategory||""} onChange={e=>upV(v.id,{budgetCategory:e.target.value})} style={{...iS,background:"#fff"}}><option value="">{"\u2014"} None {"\u2014"}</option>{BUDGET_CATS.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                    </div>
                    <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                      <div style={{ flex: 1, minWidth: 100 }}><label style={lb}>Booked Date</label><input type="date" value={v.bookedDate||""} onChange={e=>upV(v.id,{bookedDate:e.target.value})} style={iS} /></div>
                      <div style={{ flex: 1, minWidth: 100 }}><label style={lb}>Cancel Deadline</label><input type="date" value={v.cancellationDeadline||""} onChange={e=>upV(v.id,{cancellationDeadline:e.target.value})} style={iS} /></div>
                    </div>
                    {/* Vendor Links */}
                    <div style={{ marginBottom: 6 }}>
                      <label style={lb}>Links / Attachments</label>
                      {(v.links||[]).map((lk, li) => (
                        <div key={li} style={{ display: "flex", gap: 4, marginBottom: 3 }}>
                          <input placeholder="Label" value={lk.label||""} onChange={e=>{ const ls=[...(v.links||[])]; ls[li]={...ls[li],label:e.target.value}; upV(v.id,{links:ls}); }} style={{...iS, flex:1}} />
                          <input placeholder="URL" value={lk.url||""} onChange={e=>{ const ls=[...(v.links||[])]; ls[li]={...ls[li],url:e.target.value}; upV(v.id,{links:ls}); }} style={{...iS, flex:2}} />
                          <button onClick={()=>{ const ls=(v.links||[]).filter((_,i)=>i!==li); upV(v.id,{links:ls}); }} style={{...bS,background:P.redP,color:P.red,padding:"2px 8px"}}>{"\u00D7"}</button>
                        </div>
                      ))}
                      <button onClick={()=>upV(v.id,{links:[...(v.links||[]),{label:"",url:""}]})} style={{...bS,background:P.blueP,color:P.blue,fontSize:10,padding:"2px 8px"}}>+ Link</button>
                    </div>
                    <div style={{ marginBottom: 6 }}><label style={lb}>Notes</label><textarea value={v.notes||""} onChange={e=>upV(v.id,{notes:e.target.value})} style={{...iS,minHeight:44,resize:"vertical"}} /></div>
                    <div style={{ display: "flex", gap: 5, justifyContent: "flex-end" }}><button onClick={()=>rmV(v.id)} style={{...bS,background:P.redP,color:P.red}}>Remove</button></div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      );
    }

    /* ========== GUESTS ========== */
    function GuestsTab({ guests, saveGuests }) {
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const [filter, setFilter] = useState("All");
      const [search, setSearch] = useState("");
      const csvRef = React.useRef(null);
      const [csvPreview, setCsvPreview] = useState(null); // { guests: [], warnings: [] }
      const [form, setForm] = useState({ name: "", status: "Invited", villa: "Santarsa", dietary: "None", plusOne: false, partner: "", email: "", phone: "", notes: "", airport: "", flightNo: "", arrivalDate: "", arrivalTime: "", departDate: "", departTime: "" });
      const addG = () => { if (!form.name.trim()) return; saveGuests([...guests, { ...form, id: Date.now() }]); setForm({ name: "", status: "Invited", villa: "Santarsa", dietary: "None", plusOne: false, partner: "", email: "", phone: "", notes: "", airport: "", flightNo: "", arrivalDate: "", arrivalTime: "", departDate: "", departTime: "" }); setShowForm(false); };
      const upG = (id, u) => saveGuests(guests.map(g => g.id === id ? { ...g, ...u } : g));
      const rmG = (id) => { if (!window.confirm("Remove this guest?")) return; saveGuests(guests.filter(g => g.id !== id)); };
      const validVillas = ["Santarsa", "Vallorsaia", "Off-site"];
      const importCSV = (text) => {
        const lines = text.split(/\r?\n/).filter(l => l.trim());
        if (lines.length < 2) { alert("CSV must have a header row and at least one data row."); return; }
        const hdrs = lines[0].split(",").map(h => h.replace(/^"|"$/g, "").trim().toLowerCase());
        const colMap = { name: hdrs.findIndex(h => h.includes("name") && !h.includes("partner")), email: hdrs.findIndex(h => h.includes("email")), phone: hdrs.findIndex(h => h.includes("phone")), villa: hdrs.findIndex(h => h.includes("villa")), dietary: hdrs.findIndex(h => h.includes("diet")), status: hdrs.findIndex(h => h.includes("status")), notes: hdrs.findIndex(h => h.includes("note")), partner: hdrs.findIndex(h => h.includes("partner") || h.includes("+1")), airport: hdrs.findIndex(h => h.includes("airport")), flightNo: hdrs.findIndex(h => h.includes("flight")) };
        const newGuests = []; const warnings = [];
        const existingNames = guests.map(g => g.name.toLowerCase());
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].match(/(".*?"|[^",]+)/g)?.map(c => c.replace(/^"|"$/g, "").trim()) || [];
          const name = colMap.name >= 0 ? cols[colMap.name] : "";
          if (!name) { warnings.push({ row: i + 1, msg: "Missing name ‚Äî skipped" }); continue; }
          const villa = (colMap.villa >= 0 && cols[colMap.villa]) || "Santarsa";
          if (!validVillas.includes(villa)) warnings.push({ row: i + 1, msg: `Unknown villa "${villa}" for ${name} ‚Äî defaulting to Santarsa` });
          if (existingNames.includes(name.toLowerCase())) warnings.push({ row: i + 1, msg: `"${name}" already exists ‚Äî will create duplicate` });
          newGuests.push({ id: Date.now() + i, name, status: (colMap.status >= 0 && cols[colMap.status]) || "Invited", villa: validVillas.includes(villa) ? villa : "Santarsa", dietary: (colMap.dietary >= 0 && cols[colMap.dietary]) || "None", plusOne: false, partner: (colMap.partner >= 0 && cols[colMap.partner]) || "", email: (colMap.email >= 0 && cols[colMap.email]) || "", phone: (colMap.phone >= 0 && cols[colMap.phone]) || "", notes: (colMap.notes >= 0 && cols[colMap.notes]) || "", airport: (colMap.airport >= 0 && cols[colMap.airport]) || "", flightNo: (colMap.flightNo >= 0 && cols[colMap.flightNo]) || "", arrivalDate: "", arrivalTime: "", departDate: "", departTime: "" });
        }
        if (newGuests.length === 0) { alert("No valid guests found in the CSV."); return; }
        setCsvPreview({ guests: newGuests, warnings });
      };
      const confirmImport = () => { if (!csvPreview) return; saveGuests([...guests, ...csvPreview.guests]); setCsvPreview(null); };
      const cancelImport = () => setCsvPreview(null);
      const preFilter = filter === "All" ? guests : guests.filter(g => g.status === filter);
      const fil = search.trim() ? preFilter.filter(g => { const s = search.toLowerCase(); return (g.name||"").toLowerCase().includes(s) || (g.partner||"").toLowerCase().includes(s) || (g.email||"").toLowerCase().includes(s) || (g.notes||"").toLowerCase().includes(s); }) : preFilter;
      const conf = guests.filter(g => g.status === "Confirmed").length;
      const hc = guests.filter(g => g.status !== "Declined").reduce((s, g) => s + 1 + (g.plusOne ? 1 : 0) + (g.children || 0), 0);
      const san = guests.filter(g => g.villa === "Santarsa" && g.status !== "Declined").length;
      const val = guests.filter(g => g.villa === "Vallorsaia" && g.status !== "Declined").length;
      const noE = guests.filter(g => !g.email && g.status !== "Declined").length;
      const noTravel = guests.filter(g => g.status === "Confirmed" && !g.airport).length;

      const exportGuests = () => {
        const rows = [["Name","Partner/+1","Status","Villa","Dietary","Meal Choice","Role","Group","Children","Thanked","Email","Phone","Airport","Flight","Arrival","Departure","Notes"]];
        guests.forEach(g => rows.push([g.name, g.partner||"", g.status, g.villa, g.dietary, g.mealChoice||"", g.role||"", g.group||"", g.children||0, g.thankYou?"Yes":"", g.email||"", g.phone||"", g.airport||"", g.flightNo||"", g.arrivalDate?`${g.arrivalDate} ${g.arrivalTime||""}`:""  , g.departDate?`${g.departDate} ${g.departTime||""}`:""  , g.notes||""]));
        downloadCSV("wedding-guests.csv", rows);
      };

      return (
        <div>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(110px, 1fr))", gap: 7, marginBottom: 14 }}>
            {[
              { l: "Invited", v: guests.length, c: P.stone },
              { l: "Confirmed", v: conf, c: P.green },
              { l: "Headcount", v: hc, s: "inc. +1s", c: P.terra },
              { l: "No Email", v: noE, c: noE ? P.gold : P.stone },
              { l: "No Travel", v: noTravel, s: "confirmed", c: noTravel ? P.gold : P.stone },
              { l: "Thanked", v: `${guests.filter(g=>g.thankYou).length}/${guests.filter(g=>g.status!=="Declined").length}`, c: P.green },
            ].map((s, i) => (
              <div key={i} style={{ background: P.card, borderRadius: 12, padding: "10px 11px", boxShadow: "0 1px 3px rgba(0,0,0,0.03)", borderTop: `3px solid ${s.c}` }}>
                <div style={{ fontSize: 18, fontWeight: 700, color: P.txt }}>{s.v}</div>
                <div style={{ fontSize: 9, color: P.txtL, textTransform: "uppercase", letterSpacing: 1 }}>{s.l}</div>
                {s.s && <div style={{ fontSize: 9, color: P.txtM }}>{s.s}</div>}
              </div>
            ))}
          </div>

          <div style={{ display: "flex", gap: 7, marginBottom: 14, flexWrap: "wrap" }}>
            {[{ n: "Santarsa", c: san, m: 31 }, { n: "Vallorsaia", c: val, m: 26 }].map((v, i) => (
              <div key={i} style={{ flex: 1, minWidth: 130, background: P.card, borderRadius: 12, padding: "8px 11px", boxShadow: "0 1px 3px rgba(0,0,0,0.03)" }}>
                <div style={{ fontSize: 11, fontWeight: 600, color: P.txt }}>Villa {v.n}</div>
                <div style={{ fontSize: 10, color: v.c > v.m ? P.red : P.txtM }}>{v.c}/{v.m} {v.c>v.m?"\u26A0\uFE0F":""}</div>
                <div style={{ background: P.bgD, borderRadius: 6, height: 4, marginTop: 3, overflow: "hidden" }}><div style={{ height: "100%", borderRadius: 6, width: `${Math.min(v.c/v.m*100,100)}%`, background: v.c>v.m?P.red:P.olive }} /></div>
              </div>
            ))}
          </div>

          <div style={{ marginBottom: 10 }}>
            <input placeholder={"\uD83D\uDD0D Search guests..."} value={search} onChange={e => setSearch(e.target.value)} style={{ ...iS, marginBottom: 8 }} />
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: 5 }}>
              <div style={{ display: "flex", gap: 3, flexWrap: "wrap" }}>{["All",...GUEST_STATUSES].map(f => (<button key={f} onClick={() => { setFilter(f); setSearch(""); }} style={{ ...bS, background: filter===f?P.terra:P.bgD, color: filter===f?"#fff":P.txtM, padding: "3px 9px", fontSize: 11 }}>{f}</button>))}</div>
              <div style={{ display: "flex", gap: 4 }}>
                <button onClick={exportGuests} style={{ ...bS, background: P.oliveP, color: P.olive, padding: "3px 10px", fontSize: 11 }}>{"\u2B07"} CSV</button>
                <button onClick={() => csvRef.current?.click()} style={{ ...bS, background: P.blueP, color: P.blue, padding: "3px 10px", fontSize: 11 }}>{"\u2B06"} Import</button>
                <input ref={csvRef} type="file" accept=".csv" style={{ display: "none" }} onChange={e => { const f = e.target.files?.[0]; if (!f) return; const r = new FileReader(); r.onload = () => importCSV(r.result); r.readAsText(f); e.target.value = ""; }} />
                <button onClick={() => setShowForm(!showForm)} style={bP}>+ Add</button>
              </div>
            </div>
          </div>

          {csvPreview && (
            <div style={{ background: P.card, borderRadius: 14, padding: 14, marginBottom: 12, boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `4px solid ${P.blue}` }}>
              <div style={{ fontSize: 13, fontWeight: 700, color: P.txt, marginBottom: 6 }}>Import Preview</div>
              <div style={{ fontSize: 11, color: P.txtM, marginBottom: 8 }}>{csvPreview.guests.length} guest{csvPreview.guests.length !== 1 ? "s" : ""} found</div>
              {csvPreview.warnings.length > 0 && (
                <div style={{ background: `${P.gold}15`, borderRadius: 8, padding: 8, marginBottom: 8 }}>
                  <div style={{ fontSize: 10, fontWeight: 600, color: P.gold, marginBottom: 4 }}>{"\u26A0"} Warnings ({csvPreview.warnings.length})</div>
                  {csvPreview.warnings.map((w, i) => <div key={i} style={{ fontSize: 10, color: P.txtM, padding: "2px 0" }}>Row {w.row}: {w.msg}</div>)}
                </div>
              )}
              <div style={{ maxHeight: 150, overflow: "auto", marginBottom: 8 }}>
                {csvPreview.guests.map((g, i) => (
                  <div key={i} style={{ fontSize: 10, padding: "3px 0", borderBottom: `1px solid ${P.bgD}`, display: "flex", gap: 8 }}>
                    <span style={{ fontWeight: 600, color: P.txt }}>{g.name}</span>
                    <span style={{ color: P.txtL }}>{g.villa}</span>
                    <span style={{ color: P.txtL }}>{g.status}</span>
                    {g.email && <span style={{ color: P.txtL }}>{g.email}</span>}
                  </div>
                ))}
              </div>
              <div style={{ display: "flex", gap: 6 }}>
                <button onClick={confirmImport} style={{ ...bP, fontSize: 11, padding: "6px 16px" }}>{"\u2713"} Import {csvPreview.guests.length} Guests</button>
                <button onClick={cancelImport} style={{ ...bS, fontSize: 11, padding: "6px 12px" }}>Cancel</button>
              </div>
            </div>
          )}

          {showForm && (
            <div style={{ background: P.terraP, borderRadius: 14, padding: 14, marginBottom: 10 }}>
              <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                <input placeholder="Name" value={form.name} onChange={e => setForm({...form,name:e.target.value})} style={{ ...iS, flex: 2, minWidth: 130 }} />
                <select value={form.villa} onChange={e => setForm({...form,villa:e.target.value})} style={{ ...iS, flex: 1, minWidth: 95, background: "#fff" }}>{VILLA_OPTS.map(v => <option key={v}>{v}</option>)}</select>
                <select value={form.dietary} onChange={e => setForm({...form,dietary:e.target.value})} style={{ ...iS, flex: 1, minWidth: 95, background: "#fff" }}>{DIETARY_OPTS.map(d => <option key={d}>{d}</option>)}</select>
              </div>
              <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                <input placeholder="Email" value={form.email} onChange={e => setForm({...form,email:e.target.value})} style={{ ...iS, flex: 1, minWidth: 130 }} />
                <input placeholder="Phone" value={form.phone} onChange={e => setForm({...form,phone:e.target.value})} style={{ ...iS, flex: 1, minWidth: 100 }} />
              </div>
              <div style={{ display: "flex", gap: 5, alignItems: "center", flexWrap: "wrap" }}>
                <label style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 11, color: P.txtM, cursor: "pointer" }}><input type="checkbox" checked={form.plusOne} onChange={e => setForm({...form,plusOne:e.target.checked})} /> +1</label>
                {form.plusOne && <input placeholder="+1 name" value={form.partner} onChange={e => setForm({...form,partner:e.target.value})} style={{ ...iS, flex: 1, minWidth: 90 }} />}
                <input placeholder="Notes" value={form.notes} onChange={e => setForm({...form,notes:e.target.value})} style={{ ...iS, flex: 2, minWidth: 90 }} />
                <button onClick={addG} style={bP}>Add</button>
              </div>
            </div>
          )}

          {fil.length === 0 ? <div style={{ textAlign: "center", padding: 30, color: P.txtL, fontSize: 12 }}>{guests.length === 0 ? <div><div>No guests yet</div><div style={{ fontSize: 10, marginTop: 4 }}>Add your first guest above or import from a CSV spreadsheet</div></div> : "No match"}</div>
          : fil.map(g => {
            const isE = editing === g.id;
            return (
              <div key={g.id} style={{ background: P.card, borderRadius: 10, padding: "10px 12px", marginBottom: 5, boxShadow: "0 1px 3px rgba(0,0,0,0.03)", border: isE ? `2px solid ${P.terra}` : "2px solid transparent" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 7, cursor: "pointer" }} onClick={() => setEditing(isE ? null : g.id)}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 12, fontWeight: 600, color: P.txt }}>{g.name}{g.plusOne && g.partner ? ` & ${g.partner}` : g.plusOne ? " +1" : ""}{g.children > 0 ? ` +${g.children} kid${g.children>1?"s":""}` : ""}{g.role ? <span style={{ marginLeft: 5, padding: "1px 6px", borderRadius: 8, background: P.terraP, color: P.terra, fontSize: 9, fontWeight: 500 }}>{g.role}</span> : null}{g.thankYou ? <span style={{ marginLeft: 4, padding: "1px 6px", borderRadius: 8, background: P.greenP, color: P.green, fontSize: 9, fontWeight: 500 }}>{"\u2713"} Thanked</span> : null}</div>
                    <div style={{ fontSize: 10, color: P.txtL, marginTop: 1 }}>
                      {g.villa}{g.group ? ` \u00B7 ${g.group}` : ""}{g.dietary !== "None" ? ` \u00B7 ${g.dietary}` : ""}{g.mealChoice ? ` \u00B7 ${g.mealChoice}` : ""}{g.email ? ` \u00B7 ${g.email}` : !isE ? " \u00B7 \u26A0\uFE0F no email" : ""}
                      {g.airport ? ` \u00B7 \u2708 ${g.airport}` : ""}{g.notes ? ` \u00B7 ${g.notes}` : ""}
                      {g.mealChoice && g.dietary !== "None" && (
                        (g.dietary === "Vegan" && ["Beef","Sea Bass","Kids Menu"].includes(g.mealChoice)) ||
                        (g.dietary === "Vegetarian" && ["Beef","Sea Bass"].includes(g.mealChoice)) ||
                        (g.dietary === "Gluten-free" && g.mealChoice === "Risotto (V)")
                      ) && <span style={{ color: P.red, fontWeight: 600 }}> {"\u00B7"} {"\u26A0"} meal/diet clash</span>}
                    </div>
                  </div>
                  <select value={g.status} onChange={e => { e.stopPropagation(); upG(g.id, { status: e.target.value }); }} style={{
                    padding: "2px 7px", borderRadius: 14, fontSize: 10, fontWeight: 600, border: "none", cursor: "pointer",
                    background: g.status === "Confirmed" ? P.greenP : g.status === "Declined" ? P.redP : P.goldP,
                    color: g.status === "Confirmed" ? P.green : g.status === "Declined" ? P.red : P.gold
                  }}>{GUEST_STATUSES.map(s => <option key={s}>{s}</option>)}</select>
                </div>
                {isE && (
                  <div style={{ marginTop: 10, borderTop: `1px solid ${P.bgD}`, paddingTop: 10 }} onClick={e => e.stopPropagation()}>
                    <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                      <div style={{ flex: 2, minWidth: 110 }}><label style={lb}>Name</label><input value={g.name} onChange={e => upG(g.id,{name:e.target.value})} style={iS} /></div>
                      <div style={{ flex: 1, minWidth: 85 }}><label style={lb}>Villa</label><select value={g.villa} onChange={e => upG(g.id,{villa:e.target.value})} style={{...iS,background:"#fff"}}>{VILLA_OPTS.map(v=><option key={v}>{v}</option>)}</select></div>
                      <div style={{ flex: 1, minWidth: 85 }}><label style={lb}>Dietary</label><select value={g.dietary} onChange={e => upG(g.id,{dietary:e.target.value})} style={{...iS,background:"#fff"}}>{DIETARY_OPTS.map(d=><option key={d}>{d}</option>)}</select></div>
                    </div>
                    <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                      <div style={{ flex: 1, minWidth: 85 }}><label style={lb}>Role</label><select value={g.role||""} onChange={e => upG(g.id,{role:e.target.value})} style={{...iS,background:"#fff"}}>{GUEST_ROLES.map(r=><option key={r} value={r}>{r||"\u2014 None \u2014"}</option>)}</select></div>
                      <div style={{ flex: 1, minWidth: 85 }}><label style={lb}>Group</label><select value={g.group||""} onChange={e => upG(g.id,{group:e.target.value})} style={{...iS,background:"#fff"}}>{GUEST_GROUPS.map(r=><option key={r} value={r}>{r||"\u2014 None \u2014"}</option>)}</select></div>
                      <div style={{ flex: 1, minWidth: 85 }}><label style={lb}>Meal Choice</label><select value={g.mealChoice||""} onChange={e => upG(g.id,{mealChoice:e.target.value})} style={{...iS,background:"#fff"}}>{MEAL_OPTIONS.map(m=><option key={m} value={m}>{m||"\u2014 TBC \u2014"}</option>)}</select></div>
                      <div style={{ flex: 1, minWidth: 60 }}><label style={lb}>Children</label><input type="number" min="0" value={g.children||0} onChange={e => upG(g.id,{children:parseInt(e.target.value)||0})} style={iS} /></div>
                      <div style={{ flex: 0, minWidth: 65, display: "flex", alignItems: "flex-end", paddingBottom: 4 }}><label style={{ fontSize: 10, color: P.txtL, display: "flex", alignItems: "center", gap: 4, cursor: "pointer" }}><input type="checkbox" checked={!!g.thankYou} onChange={e => upG(g.id,{thankYou:e.target.checked})} style={{ accentColor: P.green }} /> Thanked</label></div>
                    </div>
                    <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                      <div style={{ flex: 1, minWidth: 130 }}><label style={lb}>Email</label><input value={g.email||""} onChange={e => upG(g.id,{email:e.target.value})} style={iS} placeholder="email@..." /></div>
                      <div style={{ flex: 1, minWidth: 100 }}><label style={lb}>Phone</label><input value={g.phone||""} onChange={e => upG(g.id,{phone:e.target.value})} style={iS} placeholder="+44..." /></div>
                    </div>
                    <div style={{ background: P.blueP, borderRadius: 10, padding: 10, marginBottom: 6 }}>
                      <div style={{ fontSize: 11, fontWeight: 600, color: P.blue, marginBottom: 6 }}>{"\u2708"} Travel Details</div>
                      <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                        <div style={{ flex: 2, minWidth: 120 }}><label style={lb}>Airport</label><select value={g.airport||""} onChange={e => upG(g.id,{airport:e.target.value})} style={{...iS,background:"#fff"}}><option value="">{"\u2014"} Select {"\u2014"}</option>{AIRPORTS.map(a=><option key={a}>{a}</option>)}</select></div>
                        <div style={{ flex: 1, minWidth: 90 }}><label style={lb}>Flight No.</label><input value={g.flightNo||""} onChange={e => upG(g.id,{flightNo:e.target.value})} style={iS} placeholder="BA1234" /></div>
                      </div>
                      <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                        <div style={{ flex: 1, minWidth: 100 }}><label style={lb}>Arrival Date</label><input type="date" value={g.arrivalDate||""} onChange={e => upG(g.id,{arrivalDate:e.target.value})} style={iS} /></div>
                        <div style={{ flex: 1, minWidth: 70 }}><label style={lb}>Time</label><input type="time" value={g.arrivalTime||""} onChange={e => upG(g.id,{arrivalTime:e.target.value})} style={iS} /></div>
                        <div style={{ flex: 1, minWidth: 100 }}><label style={lb}>Depart Date</label><input type="date" value={g.departDate||""} onChange={e => upG(g.id,{departDate:e.target.value})} style={iS} /></div>
                        <div style={{ flex: 1, minWidth: 70 }}><label style={lb}>Time</label><input type="time" value={g.departTime||""} onChange={e => upG(g.id,{departTime:e.target.value})} style={iS} /></div>
                      </div>
                    </div>
                    <div style={{ background: P.terraP, borderRadius: 10, padding: 10, marginBottom: 6 }}>
                      <div style={{ fontSize: 11, fontWeight: 600, color: P.terra, marginBottom: 6 }}>{"\u2709"} Comms Tracking</div>
                      <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                        {COMMS_ITEMS.map(ci => {
                          const comms = g.comms || {};
                          const sent = comms[ci.key];
                          return (
                            <label key={ci.key} style={{ display: "flex", alignItems: "center", gap: 3, fontSize: 10, color: sent ? P.green : P.txtM, cursor: "pointer", padding: "3px 8px", borderRadius: 8, background: sent ? P.greenP : P.bgD }}>
                              <input type="checkbox" checked={!!sent} onChange={() => {
                                const newComms = { ...comms, [ci.key]: sent ? null : new Date().toISOString().slice(0,10) };
                                upG(g.id, { comms: newComms });
                              }} style={{ margin: 0 }} />
                              {ci.label}
                              {sent && <span style={{ fontSize: 8, color: P.txtL, marginLeft: 2 }}>{sent}</span>}
                            </label>
                          );
                        })}
                      </div>
                    </div>
                    <div style={{ display: "flex", gap: 5, alignItems: "center", flexWrap: "wrap" }}>
                      <label style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 11, color: P.txtM, cursor: "pointer" }}><input type="checkbox" checked={g.plusOne||false} onChange={e => upG(g.id,{plusOne:e.target.checked})} /> +1</label>
                      {g.plusOne && <input value={g.partner||""} onChange={e => upG(g.id,{partner:e.target.value})} placeholder="+1 name" style={{...iS,flex:1,minWidth:85}} />}
                      <input value={g.notes||""} onChange={e => upG(g.id,{notes:e.target.value})} placeholder="Notes" style={{...iS,flex:2,minWidth:90}} />
                      <button onClick={() => rmG(g.id)} style={{...bS,background:P.redP,color:P.red}}>Remove</button>
                    </div>
                  </div>
                )}
              </div>
            );
          })}

          {/* Dietary Summary */}
          {(() => {
            const active = guests.filter(g => g.status !== "Declined");
            const counts = {}; active.forEach(g => { const d = g.dietary || "None"; counts[d] = (counts[d]||0) + 1; });
            const specials = Object.entries(counts).filter(([k]) => k !== "None").sort((a,b) => b[1]-a[1]);
            const exportDietary = () => {
              const rows = [["Dietary Requirement","Count","Guests"]];
              Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([d,c]) => rows.push([d, c, active.filter(g=>(g.dietary||"None")===d).map(g=>g.name).join(", ")]));
              downloadCSV("wedding-dietary-summary.csv", rows);
            };
            return active.length > 0 ? (
              <div style={{ background: P.card, borderRadius: 14, padding: 16, marginTop: 16, boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `4px solid ${P.olive}` }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                  <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 14, fontWeight: 700, color: P.txt }}>{"\uD83C\uDF7D"} Dietary Summary</div>
                  <button onClick={exportDietary} style={{ ...bS, background: P.oliveP, color: P.olive, fontSize: 10, padding: "3px 8px" }}>{"\u2B07"} CSV</button>
                </div>
                <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: specials.length > 0 ? 10 : 0 }}>
                  {Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([d,c]) => (
                    <div key={d} style={{ padding: "4px 10px", borderRadius: 10, background: d === "None" ? P.bgD : P.oliveP, fontSize: 11, fontWeight: 600, color: d === "None" ? P.txtM : P.olive }}>
                      {c} {d}
                    </div>
                  ))}
                </div>
                {specials.length > 0 && (
                  <div>
                    {specials.map(([d]) => (
                      <div key={d} style={{ marginBottom: 4 }}>
                        <div style={{ fontSize: 10, fontWeight: 600, color: P.olive, marginBottom: 2 }}>{d}</div>
                        <div style={{ display: "flex", gap: 3, flexWrap: "wrap" }}>
                          {active.filter(g => g.dietary === d).map(g => (
                            <span key={g.id} style={{ padding: "1px 7px", borderRadius: 8, background: P.oliveP, fontSize: 10, color: P.olive }}>{g.name}</span>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ) : null;
          })()}

          {/* Transport Logistics */}
          {(() => {
            const withTravel = guests.filter(g => g.status === "Confirmed" && g.airport);
            const byAirport = {}; withTravel.forEach(g => { const a = g.airport; if (!byAirport[a]) byAirport[a] = []; byAirport[a].push(g); });
            const byArrDate = {}; withTravel.filter(g => g.arrivalDate).forEach(g => { const k = g.arrivalDate; if (!byArrDate[k]) byArrDate[k] = []; byArrDate[k].push(g); });
            const noTravel = guests.filter(g => g.status === "Confirmed" && !g.airport);
            const exportTransport = () => {
              const rows = [["Date","Time","Airport","Flight","Guest","Villa"]];
              [...withTravel].sort((a,b) => (a.arrivalDate||"").localeCompare(b.arrivalDate||"") || (a.arrivalTime||"").localeCompare(b.arrivalTime||"")).forEach(g => rows.push([g.arrivalDate||"", g.arrivalTime||"", g.airport, g.flightNo||"", g.name, g.villa]));
              downloadCSV("wedding-transport-logistics.csv", rows);
            };
            return withTravel.length > 0 || noTravel.length > 0 ? (
              <div style={{ background: P.card, borderRadius: 14, padding: 16, marginTop: 12, boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `4px solid ${P.blue}` }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                  <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 14, fontWeight: 700, color: P.txt }}>{"\u2708"} Transport Logistics</div>
                  <button onClick={exportTransport} style={{ ...bS, background: P.blueP, color: P.blue, fontSize: 10, padding: "3px 8px" }}>{"\u2B07"} CSV</button>
                </div>

                {/* By arrival date */}
                {Object.entries(byArrDate).sort(([a],[b]) => a.localeCompare(b)).map(([date, gs]) => (
                  <div key={date} style={{ marginBottom: 10 }}>
                    <div style={{ fontSize: 11, fontWeight: 700, color: P.blue, marginBottom: 4 }}>
                      {new Date(date+"T12:00").toLocaleDateString("en-GB", { weekday: "short", day: "numeric", month: "short" })}
                      <span style={{ fontWeight: 400, color: P.txtL, marginLeft: 4 }}>({gs.length} guest{gs.length !== 1 ? "s" : ""})</span>
                    </div>
                    {gs.sort((a,b) => (a.arrivalTime||"").localeCompare(b.arrivalTime||"")).map(g => (
                      <div key={g.id} style={{ display: "flex", alignItems: "center", gap: 6, padding: "4px 0", borderBottom: `1px solid ${P.bgD}` }}>
                        <div style={{ width: 42, fontSize: 10, fontWeight: 600, color: P.txtM, flexShrink: 0 }}>{g.arrivalTime || "TBC"}</div>
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 11, color: P.txt }}>{g.name}</div>
                          <div style={{ fontSize: 9, color: P.txtL }}>{g.airport}{g.flightNo ? ` \u00B7 ${g.flightNo}` : ""} {"\u2192"} {g.villa}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                ))}

                {/* Shuttle Runs */}
                {(() => {
                  const runs = [];
                  const arrivals = withTravel.filter(g => g.arrivalDate && g.arrivalTime && g.airport);
                  const grouped = {};
                  arrivals.forEach(g => {
                    const key = `${g.airport}|${g.arrivalDate}`;
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(g);
                  });
                  Object.entries(grouped).forEach(([key, gs]) => {
                    gs.sort((a, b) => a.arrivalTime.localeCompare(b.arrivalTime));
                    let run = [gs[0]];
                    for (let i = 1; i < gs.length; i++) {
                      const prev = run[run.length - 1].arrivalTime.split(":").map(Number);
                      const curr = gs[i].arrivalTime.split(":").map(Number);
                      const diffMin = (curr[0] * 60 + (curr[1]||0)) - (prev[0] * 60 + (prev[1]||0));
                      if (diffMin <= 60) { run.push(gs[i]); } else { if (run.length > 1) runs.push(run); run = [gs[i]]; }
                    }
                    if (run.length > 1) runs.push(run);
                  });
                  const departures = withTravel.filter(g => g.departDate && g.departTime && g.airport);
                  const depGrouped = {};
                  departures.forEach(g => {
                    const key = `${g.airport}|${g.departDate}`;
                    if (!depGrouped[key]) depGrouped[key] = [];
                    depGrouped[key].push(g);
                  });
                  const depRuns = [];
                  Object.entries(depGrouped).forEach(([key, gs]) => {
                    gs.sort((a, b) => a.departTime.localeCompare(b.departTime));
                    let run = [gs[0]];
                    for (let i = 1; i < gs.length; i++) {
                      const prev = run[run.length - 1].departTime.split(":").map(Number);
                      const curr = gs[i].departTime.split(":").map(Number);
                      const diffMin = (curr[0] * 60 + (curr[1]||0)) - (prev[0] * 60 + (prev[1]||0));
                      if (diffMin <= 60) { run.push(gs[i]); } else { if (run.length > 1) depRuns.push(run); run = [gs[i]]; }
                    }
                    if (run.length > 1) depRuns.push(run);
                  });
                  const allRuns = [...runs.map(r => ({ type: "arrival", guests: r })), ...depRuns.map(r => ({ type: "departure", guests: r }))];
                  return allRuns.length > 0 ? (
                    <div style={{ marginTop: 10, marginBottom: 6 }}>
                      <div style={{ fontSize: 11, fontWeight: 700, color: P.olive, marginBottom: 6 }}>{"\uD83D\uDE90"} Suggested Shuttle Runs</div>
                      <div style={{ display: "flex", flexDirection: "column", gap: 5 }}>
                        {allRuns.map((run, ri) => {
                          const gs = run.guests;
                          const airport = gs[0].airport;
                          const date = run.type === "arrival" ? gs[0].arrivalDate : gs[0].departDate;
                          const times = gs.map(g => run.type === "arrival" ? g.arrivalTime : g.departTime).sort();
                          const isMinibus = gs.length >= 4;
                          const arrow = run.type === "arrival" ? `${airport} \u2192 Villa` : `Villa \u2192 ${airport}`;
                          const dateStr = new Date(date + "T12:00").toLocaleDateString("en-GB", { weekday: "short", day: "numeric", month: "short" });
                          return (
                            <div key={ri} style={{ background: isMinibus ? P.oliveP : P.blueP, borderRadius: 10, padding: "8px 11px", borderLeft: `4px solid ${isMinibus ? P.olive : P.blue}` }}>
                              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                                <div style={{ fontSize: 11, fontWeight: 700, color: isMinibus ? P.olive : P.blue }}>{arrow}</div>
                                <span style={{ fontSize: 9, padding: "1px 6px", borderRadius: 6, background: isMinibus ? P.olive : P.blue, color: "#fff", fontWeight: 600 }}>{isMinibus ? "Minibus" : "Sedan"}</span>
                              </div>
                              <div style={{ fontSize: 10, color: P.txtM, marginTop: 2 }}>{dateStr} {"\u00B7"} {times[0]}{"\u2013"}{times[times.length-1]} {"\u00B7"} {gs.length} guest{gs.length !== 1 ? "s" : ""}</div>
                              <div style={{ fontSize: 10, color: P.txt, marginTop: 3 }}>{gs.map(g => g.name).join(", ")}</div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ) : null;
                })()}

                {/* Mixed-villa arrival warnings */}
                {(() => {
                  const arrivals = withTravel.filter(g => g.arrivalDate && g.arrivalTime);
                  const groups = {};
                  arrivals.forEach(g => { const k = `${g.airport}|${g.arrivalDate}`; if (!groups[k]) groups[k] = []; groups[k].push(g); });
                  const conflicts = [];
                  Object.entries(groups).forEach(([key, gs]) => {
                    gs.sort((a, b) => a.arrivalTime.localeCompare(b.arrivalTime));
                    let run = [gs[0]];
                    for (let i = 1; i < gs.length; i++) {
                      const prev = run[run.length - 1].arrivalTime.split(":").map(Number);
                      const curr = gs[i].arrivalTime.split(":").map(Number);
                      if ((curr[0]*60+(curr[1]||0)) - (prev[0]*60+(prev[1]||0)) <= 60) { run.push(gs[i]); }
                      else { if (run.length > 1) { const villas = new Set(run.map(g => g.villa)); if (villas.size > 1) conflicts.push({ key, guests: run }); } run = [gs[i]]; }
                    }
                    if (run.length > 1) { const villas = new Set(run.map(g => g.villa)); if (villas.size > 1) conflicts.push({ key, guests: run }); }
                  });
                  return conflicts.length > 0 ? (
                    <div style={{ background: P.goldP, borderRadius: 10, padding: "8px 12px", marginTop: 8, borderLeft: `4px solid ${P.gold}` }}>
                      <div style={{ fontSize: 10, fontWeight: 700, color: P.gold, marginBottom: 4 }}>{"\u26A0"} Mixed villas at same pickup ({conflicts.length})</div>
                      {conflicts.map((c, ci) => {
                        const [apt, date] = c.key.split("|");
                        const byVilla = {};
                        c.guests.forEach(g => { if (!byVilla[g.villa]) byVilla[g.villa] = []; byVilla[g.villa].push(g); });
                        return (
                          <div key={ci} style={{ fontSize: 10, color: P.txtM, marginBottom: 4 }}>
                            <span style={{ fontWeight: 600 }}>{apt}</span> {date} ‚Äî {Object.entries(byVilla).map(([v, gs]) => `${v}: ${gs.map(g => g.name).join(", ")}`).join(" | ")}
                          </div>
                        );
                      })}
                    </div>
                  ) : null;
                })()}

                {/* By airport summary */}
                <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginTop: 6 }}>
                  {Object.entries(byAirport).sort((a,b) => b[1].length - a[1].length).map(([apt, gs]) => (
                    <div key={apt} style={{ padding: "3px 9px", borderRadius: 8, background: P.blueP, fontSize: 10, color: P.blue, fontWeight: 600 }}>
                      {gs.length} {"\u2192"} {apt}
                    </div>
                  ))}
                </div>

                {noTravel.length > 0 && (
                  <div style={{ marginTop: 8 }}>
                    <div style={{ fontSize: 10, fontWeight: 600, color: P.gold, marginBottom: 3 }}>{"\u26A0"} No travel details ({noTravel.length})</div>
                    <div style={{ display: "flex", gap: 3, flexWrap: "wrap" }}>
                      {noTravel.map(g => (<span key={g.id} style={{ padding: "1px 7px", borderRadius: 8, background: P.goldP, fontSize: 9, color: P.gold }}>{g.name}</span>))}
                    </div>
                  </div>
                )}
              </div>
            ) : null;
          })()}

          {/* Comms Overview */}
          {(() => {
            const active = guests.filter(g => g.status !== "Declined");
            if (active.length === 0) return null;
            const totals = {};
            COMMS_ITEMS.forEach(ci => { totals[ci.key] = active.filter(g => g.comms && g.comms[ci.key]).length; });
            const exportComms = () => {
              const rows = [["Guest", "Status", ...COMMS_ITEMS.map(ci => ci.label)]];
              active.forEach(g => rows.push([g.name, g.status, ...COMMS_ITEMS.map(ci => (g.comms && g.comms[ci.key]) || "")]));
              downloadCSV("wedding-comms-tracker.csv", rows);
            };
            return (
              <div style={{ background: P.card, borderRadius: 14, padding: 16, marginTop: 12, boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `4px solid ${P.terra}` }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                  <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 14, fontWeight: 700, color: P.txt }}>{"\u2709"} Comms Tracker</div>
                  <button onClick={exportComms} style={{ ...bS, background: P.terraP, color: P.terra, fontSize: 10, padding: "3px 8px" }}>{"\u2B07"} CSV</button>
                </div>
                <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 12 }}>
                  {COMMS_ITEMS.map(ci => (
                    <div key={ci.key} style={{ padding: "6px 11px", borderRadius: 10, background: totals[ci.key] === active.length ? P.greenP : P.bgD }}>
                      <div style={{ fontSize: 15, fontWeight: 700, color: totals[ci.key] === active.length ? P.green : P.txt }}>{totals[ci.key]}/{active.length}</div>
                      <div style={{ fontSize: 9, color: P.txtL }}>{ci.label}</div>
                    </div>
                  ))}
                </div>
                <div style={{ overflowX: "auto" }}>
                  <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 10 }}>
                    <thead>
                      <tr style={{ borderBottom: `2px solid ${P.bgD}` }}>
                        <th style={{ textAlign: "left", padding: "4px 6px", color: P.txtM, fontWeight: 600 }}>Guest</th>
                        {COMMS_ITEMS.map(ci => <th key={ci.key} style={{ textAlign: "center", padding: "4px 4px", color: P.txtM, fontWeight: 600, whiteSpace: "nowrap" }}>{ci.label}</th>)}
                      </tr>
                    </thead>
                    <tbody>
                      {active.map(g => (
                        <tr key={g.id} style={{ borderBottom: `1px solid ${P.bgD}` }}>
                          <td style={{ padding: "4px 6px", color: P.txt, whiteSpace: "nowrap" }}>{g.name}</td>
                          {COMMS_ITEMS.map(ci => {
                            const sent = g.comms && g.comms[ci.key];
                            return <td key={ci.key} style={{ textAlign: "center", padding: "4px 4px", color: sent ? P.green : P.stoneL }}>{sent ? "\u2713" : "\u2014"}</td>;
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            );
          })()}
        </div>
      );
    }

    /* ========== SEATING ========== */
    function SeatingTab({ seating, saveSeating, guests }) {
      const [form, setForm] = useState({ name: "", seats: 8, shape: "round" });
      const [dragOverId, setDragOverId] = useState(null);
      const [dragging, setDragging] = useState(null);

      const tables = safeArr(seating.tables).map(t => ({ ...t, shape: t.shape || "round", guests: safeArr(t.guests) }));
      const seated = tables.flatMap(t => t.guests);
      const confirmed = guests.filter(g => g.status === "Confirmed");
      const unseated = confirmed.filter(g => !seated.includes(g.name)).map(g => g.name);

      const getInitials = (name) => { const p = name.trim().split(/\s+/); return p.length === 1 ? p[0][0].toUpperCase() : (p[0][0] + p[p.length-1][0]).toUpperCase(); };

      const getTables = () => (seating.tables || []);
      const addTable = () => {
        if (!form.name.trim()) return;
        saveSeating({ ...seating, tables: [...getTables(), { id: Date.now(), name: form.name, seats: form.seats, shape: form.shape, guests: [] }] });
        setForm({ name: "", seats: 8, shape: form.shape });
      };
      const rmTable = (id) => { if (!window.confirm("Remove this table and unseat all guests?")) return; saveSeating({ ...seating, tables: getTables().filter(t => t.id !== id) }); };
      const moveTable = (id, dir) => { const ts = [...getTables()]; const i = ts.findIndex(t => t.id === id); const ni = i + dir; if (ni < 0 || ni >= ts.length) return; [ts[i], ts[ni]] = [ts[ni], ts[i]]; saveSeating({ ...seating, tables: ts }); };
      const addToTable = (tid, gName) => {
        if (!gName) return;
        saveSeating({ ...seating, tables: getTables().map(t => t.id === tid ? { ...t, guests: [...(t.guests || []), gName] } : t) });
      };
      const rmFromTable = (tid, gName) => {
        if (!window.confirm(`Remove ${gName} from this table?`)) return;
        saveSeating({ ...seating, tables: getTables().map(t => t.id === tid ? { ...t, guests: (t.guests || []).filter(g => g !== gName) } : t) });
      };
      const moveGuest = (gName, fromId, toId) => {
        if (fromId === toId) return;
        let newTables = [...getTables()];
        if (fromId !== "pool") newTables = newTables.map(t => t.id === fromId ? { ...t, guests: (t.guests || []).filter(g => g !== gName) } : t);
        if (toId !== "pool") newTables = newTables.map(t => t.id === toId ? { ...t, guests: [...(t.guests || []), gName] } : t);
        saveSeating({ ...seating, tables: newTables });
      };

      const dropHandlers = (targetId) => ({
        onDragOver: e => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; },
        onDragEnter: e => { e.preventDefault(); setDragOverId(targetId); },
        onDragLeave: e => { if (e.relatedTarget && e.currentTarget.contains(e.relatedTarget)) return; setDragOverId(null); },
        onDrop: e => {
          e.preventDefault();
          const gName = e.dataTransfer.getData("text/plain");
          const from = e.dataTransfer.getData("application/x-source-table");
          moveGuest(gName, from === "pool" ? "pool" : parseInt(from), targetId);
          setDragOverId(null); setDragging(null);
        },
      });

      const dragProps = (gName, sourceId) => ({
        draggable: true,
        onDragStart: e => { e.dataTransfer.setData("text/plain", gName); e.dataTransfer.setData("application/x-source-table", String(sourceId)); e.dataTransfer.effectAllowed = "move"; setDragging(gName); },
        onDragEnd: () => setDragging(null),
      });

      const seatStyle = (guest) => ({
        display: "flex", alignItems: "center", justifyContent: "center",
        fontSize: 10, fontWeight: 600,
        background: guest ? P.oliveP : "transparent",
        border: guest ? `2px solid ${P.oliveL}` : `2px dashed ${P.stoneL}`,
        color: guest ? P.olive : P.txtL,
        cursor: guest ? "grab" : "default",
        opacity: dragging === guest ? 0.4 : 1,
        transition: "opacity 0.15s",
      });

      const tableCard = (t, isOver) => ({
        background: isOver ? P.terraP : P.card, borderRadius: 16, padding: 14,
        boxShadow: "0 1px 4px rgba(0,0,0,0.04)",
        border: isOver ? `2px solid ${P.terra}` : "2px solid transparent",
        transition: "border-color 0.15s, background-color 0.15s",
      });

      const renderRoundTable = (t) => {
        const sz = 250, cx = sz/2, cy = sz/2, tR = 42, oR = 90, sS = 34;
        const isOver = dragOverId === t.id;
        const slots = Array.from({ length: t.seats }, (_, i) => ({
          guest: t.guests[i] || null,
          angle: (2 * Math.PI * i / t.seats) - Math.PI / 2,
        }));
        return (
          <div key={t.id} {...dropHandlers(t.id)} style={tableCard(t, isOver)}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
              <div><span style={{ fontSize: 13, fontWeight: 700, color: P.txt }}>{t.name}</span><span style={{ fontSize: 10, color: t.guests.length > t.seats ? P.red : P.txtL, marginLeft: 6 }}>{t.guests.length}/{t.seats}</span></div>
              <button onClick={() => moveTable(t.id, -1)} style={{...bS, background: P.bgD, color: P.txtM, fontSize: 10, padding: "2px 6px"}}>{"\u25B2"}</button><button onClick={() => moveTable(t.id, 1)} style={{...bS, background: P.bgD, color: P.txtM, fontSize: 10, padding: "2px 6px"}}>{"\u25BC"}</button><button onClick={() => rmTable(t.id)} style={{...bS, background: P.redP, color: P.red, fontSize: 10}}>Remove</button>
            </div>
            <div style={{ position: "relative", width: sz, height: sz, margin: "0 auto" }}>
              <div style={{ position: "absolute", left: cx-tR, top: cy-tR, width: tR*2, height: tR*2, borderRadius: "50%", background: P.bgD, border: `1px solid ${P.stoneP}`, display: "flex", alignItems: "center", justifyContent: "center", flexDirection: "column" }}>
                <div style={{ fontSize: 10, fontWeight: 600, color: P.txtM, textAlign: "center", padding: "0 4px", lineHeight: 1.2 }}>{t.name}</div>
              </div>
              {slots.map((s, i) => {
                const x = cx + oR * Math.cos(s.angle) - sS/2;
                const y = cy + oR * Math.sin(s.angle) - sS/2;
                return (
                  <div key={i} {...(s.guest ? dragProps(s.guest, t.id) : {})} title={s.guest || "Empty seat"}
                    style={{ position: "absolute", left: x, top: y, width: sS, height: sS, borderRadius: "50%", ...seatStyle(s.guest) }}>
                    {s.guest ? getInitials(s.guest) : "+"}
                  </div>
                );
              })}
            </div>
            {t.guests.length < t.seats && (
              <select onChange={e => { addToTable(t.id, e.target.value); e.target.value = ""; }} style={{ ...iS, fontSize: 11, padding: "4px 8px", background: "#fff", marginTop: 6 }} defaultValue="">
                <option value="" disabled>+ Add guest{"\u2026"}</option>
                {unseated.filter(n => !t.guests.includes(n)).map(n => <option key={n}>{n}</option>)}
              </select>
            )}
            {t.guests.length > 0 && (
              <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginTop: 8 }}>
                {t.guests.map(g => (
                  <span key={g} style={{ padding: "2px 8px", borderRadius: 12, background: P.oliveP, fontSize: 10, color: P.olive, display: "flex", alignItems: "center", gap: 3 }}>
                    {g} <button onClick={() => rmFromTable(t.id, g)} style={{ background: "none", border: "none", cursor: "pointer", color: P.olive, fontSize: 11, padding: 0, lineHeight: 1 }}>{"\u00D7"}</button>
                  </span>
                ))}
              </div>
            )}
            {(() => {
              const diets = {}; t.guests.forEach(gn => { const gObj = guests.find(g => g.name === gn); const d = gObj?.dietary || "None"; if (d !== "None") diets[d] = (diets[d]||0) + 1; });
              const entries = Object.entries(diets);
              return entries.length > 0 ? (
                <div style={{ display: "flex", gap: 3, flexWrap: "wrap", marginTop: 5 }}>
                  {entries.map(([d,c]) => <span key={d} style={{ padding: "1px 7px", borderRadius: 8, background: P.terraP, fontSize: 9, color: P.terra }}>{c} {d}</span>)}
                </div>
              ) : null;
            })()}
          </div>
        );
      };

      const renderLongTable = (t) => {
        const cW = 260, cH = 180, tW = 190, tH = 44, sS = 30;
        const tL = (cW - tW) / 2, tT = (cH - tH) / 2;
        const isOver = dragOverId === t.id;
        const topN = Math.ceil(t.seats / 2), botN = Math.floor(t.seats / 2);
        const mkRow = (count, yPos, startIdx) => Array.from({ length: count }, (_, i) => ({
          x: tL + (tW / (count + 1)) * (i + 1) - sS/2,
          y: yPos,
          guest: t.guests[startIdx + i] || null,
        }));
        const allSeats = [...mkRow(topN, tT - sS - 6, 0), ...mkRow(botN, tT + tH + 6, topN)];
        return (
          <div key={t.id} {...dropHandlers(t.id)} style={tableCard(t, isOver)}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
              <div><span style={{ fontSize: 13, fontWeight: 700, color: P.txt }}>{t.name}</span><span style={{ fontSize: 10, color: t.guests.length > t.seats ? P.red : P.txtL, marginLeft: 6 }}>{t.guests.length}/{t.seats}</span></div>
              <button onClick={() => moveTable(t.id, -1)} style={{...bS, background: P.bgD, color: P.txtM, fontSize: 10, padding: "2px 6px"}}>{"\u25B2"}</button><button onClick={() => moveTable(t.id, 1)} style={{...bS, background: P.bgD, color: P.txtM, fontSize: 10, padding: "2px 6px"}}>{"\u25BC"}</button><button onClick={() => rmTable(t.id)} style={{...bS, background: P.redP, color: P.red, fontSize: 10}}>Remove</button>
            </div>
            <div style={{ position: "relative", width: cW, height: cH, margin: "0 auto" }}>
              <div style={{ position: "absolute", left: tL, top: tT, width: tW, height: tH, borderRadius: 8, background: P.bgD, border: `1px solid ${P.stoneP}`, display: "flex", alignItems: "center", justifyContent: "center" }}>
                <div style={{ fontSize: 10, fontWeight: 600, color: P.txtM }}>{t.name}</div>
              </div>
              {allSeats.map((s, i) => (
                <div key={i} {...(s.guest ? dragProps(s.guest, t.id) : {})} title={s.guest || "Empty seat"}
                  style={{ position: "absolute", left: s.x, top: s.y, width: sS, height: sS, borderRadius: 6, ...seatStyle(s.guest) }}>
                  {s.guest ? getInitials(s.guest) : "+"}
                </div>
              ))}
            </div>
            {t.guests.length < t.seats && (
              <select onChange={e => { addToTable(t.id, e.target.value); e.target.value = ""; }} style={{ ...iS, fontSize: 11, padding: "4px 8px", background: "#fff", marginTop: 6 }} defaultValue="">
                <option value="" disabled>+ Add guest{"\u2026"}</option>
                {unseated.filter(n => !t.guests.includes(n)).map(n => <option key={n}>{n}</option>)}
              </select>
            )}
            {t.guests.length > 0 && (
              <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginTop: 8 }}>
                {t.guests.map(g => (
                  <span key={g} style={{ padding: "2px 8px", borderRadius: 12, background: P.oliveP, fontSize: 10, color: P.olive, display: "flex", alignItems: "center", gap: 3 }}>
                    {g} <button onClick={() => rmFromTable(t.id, g)} style={{ background: "none", border: "none", cursor: "pointer", color: P.olive, fontSize: 11, padding: 0, lineHeight: 1 }}>{"\u00D7"}</button>
                  </span>
                ))}
              </div>
            )}
            {(() => {
              const diets = {}; t.guests.forEach(gn => { const gObj = guests.find(g => g.name === gn); const d = gObj?.dietary || "None"; if (d !== "None") diets[d] = (diets[d]||0) + 1; });
              const entries = Object.entries(diets);
              return entries.length > 0 ? (
                <div style={{ display: "flex", gap: 3, flexWrap: "wrap", marginTop: 5 }}>
                  {entries.map(([d,c]) => <span key={d} style={{ padding: "1px 7px", borderRadius: 8, background: P.terraP, fontSize: 9, color: P.terra }}>{c} {d}</span>)}
                </div>
              ) : null;
            })()}
          </div>
        );
      };

      return (
        <div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
            <div>
              <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 20, fontWeight: 700, color: P.txt, marginBottom: 3 }}>Seating Plan</div>
              <div style={{ fontSize: 12, color: P.txtL, marginBottom: 18 }}>Drag guests to tables {"\u00B7"} {seated.length} seated / {confirmed.length} confirmed</div>
            </div>
            <div data-no-print style={{ display: "flex", gap: 4 }}>
              <button onClick={() => window.print()} style={{...bS, background: P.stoneP, color: P.stone, padding: "6px 14px"}}>{"\uD83D\uDDA8"} Print</button>
              <button onClick={() => {
                const cards = tables.flatMap(t => t.guests.map(gn => {
                  const gObj = guests.find(g => g.name === gn);
                  return { name: gn, table: t.name, dietary: gObj?.dietary !== "None" ? gObj?.dietary : "" };
                }));
                const w = window.open("", "_blank");
                w.document.write("<html><head><title>Place Cards</title><style>@page{size:landscape;margin:10mm}body{font-family:'DM Sans',sans-serif;margin:0;padding:10mm}.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8mm}.card{border:1px solid #ddd;border-radius:6px;padding:16px 12px;text-align:center;break-inside:avoid;min-height:50mm;display:flex;flex-direction:column;justify-content:center}.name{font-family:'Playfair Display',Georgia,serif;font-size:22px;font-weight:700;color:#3D3228}.table{font-size:13px;color:#8C8377;margin-top:6px}.diet{font-size:11px;color:#C4704B;margin-top:4px;font-style:italic}</style></head><body><div class='grid'>");
                cards.forEach(c => w.document.write(`<div class='card'><div class='name'>${c.name}</div><div class='table'>${c.table}</div>${c.dietary ? `<div class='diet'>${c.dietary}</div>` : ""}</div>`));
                w.document.write("</div></body></html>"); w.document.close(); w.print();
              }} style={{...bS, background: P.terraP, color: P.terra, padding: "6px 14px"}}>Place Cards</button>
            </div>
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(100px, 1fr))", gap: 7, marginBottom: 14 }}>
            {[{ l: "Confirmed", v: confirmed.length, c: P.green },{ l: "Seated", v: seated.length, c: P.olive },{ l: "Unseated", v: unseated.length, c: unseated.length > 0 ? P.gold : P.stone },{ l: "Tables", v: tables.length, c: P.terra }].map((s,i) => (
              <div key={i} style={{ background: P.card, borderRadius: 12, padding: "10px 11px", boxShadow: "0 1px 3px rgba(0,0,0,0.03)", borderTop: `3px solid ${s.c}` }}>
                <div style={{ fontSize: 18, fontWeight: 700, color: P.txt }}>{s.v}</div>
                <div style={{ fontSize: 9, color: P.txtL, textTransform: "uppercase", letterSpacing: 1 }}>{s.l}</div>
              </div>
            ))}
          </div>

          <div {...dropHandlers("pool")} style={{
            background: dragOverId === "pool" ? P.terraP : P.goldP, borderRadius: 12, padding: 14, marginBottom: 16,
            border: dragOverId === "pool" ? `2px dashed ${P.terra}` : "2px solid transparent", transition: "all 0.15s",
            minHeight: 48
          }}>
            <div style={{ fontSize: 11, fontWeight: 600, color: P.gold, marginBottom: 6 }}>
              {unseated.length > 0 ? `Unseated (${unseated.length}) \u2014 drag to a table` : "All confirmed guests are seated"}
            </div>
            <div style={{ display: "flex", gap: 5, flexWrap: "wrap" }}>
              {unseated.map(n => (
                <span key={n} {...dragProps(n, "pool")} style={{ padding: "4px 11px", borderRadius: 14, background: "#fff", fontSize: 11, color: P.txt, cursor: "grab", opacity: dragging === n ? 0.4 : 1, transition: "opacity 0.15s", boxShadow: "0 1px 3px rgba(0,0,0,0.06)" }}>{n}</span>
              ))}
            </div>
          </div>

          {/* Couple seating warnings */}
          {(() => {
            const warnings = [];
            guests.filter(g => g.plusOne && g.partner).forEach(g => {
              const gTable = tables.find(t => t.guests.includes(g.name));
              const pTable = tables.find(t => t.guests.includes(g.partner));
              if (gTable && pTable && gTable.id !== pTable.id) warnings.push({ guest: g.name, partner: g.partner, gT: gTable.name, pT: pTable.name });
            });
            return warnings.length > 0 ? (
              <div style={{ background: P.goldP, borderRadius: 10, padding: "8px 12px", marginBottom: 10, borderLeft: `4px solid ${P.gold}` }}>
                <div style={{ fontSize: 11, fontWeight: 600, color: P.gold, marginBottom: 4 }}>{"\u26A0"} Couples split across tables</div>
                {warnings.map((w, i) => <div key={i} style={{ fontSize: 10, color: P.txtM }}>{w.guest} ({w.gT}) & {w.partner} ({w.pT})</div>)}
              </div>
            ) : null;
          })()}

          <div data-no-print style={{ display: "flex", gap: 5, marginBottom: 16, flexWrap: "wrap", alignItems: "center" }}>
            <input placeholder="Table name (e.g. Top Table)" value={form.name} onChange={e => setForm({...form,name:e.target.value})} onKeyDown={e => e.key === "Enter" && addTable()} style={{ ...iS, flex: 2, minWidth: 120 }} />
            <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
              <label style={{ fontSize: 11, color: P.txtL }}>Seats</label>
              <input type="number" value={form.seats} min={2} max={20} onChange={e => setForm({...form,seats:parseInt(e.target.value)||8})} style={{ ...iS, width: 55 }} />
            </div>
            <div style={{ display: "flex", gap: 2, background: P.bgD, borderRadius: 8, padding: 2 }}>
              {["round","long"].map(s => (
                <button key={s} onClick={() => setForm({...form,shape:s})} style={{ ...bS, padding: "5px 10px", background: form.shape===s?P.terra:"transparent", color: form.shape===s?"#fff":P.txtM, borderRadius: 6, textTransform: "capitalize" }}>
                  {s === "round" ? "\u25CB" : "\u25AD"} {s}
                </button>
              ))}
            </div>
            <button onClick={addTable} style={bP}>+ Table</button>
          </div>

          {tables.length > 0 ? (
            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(280px, 1fr))", gap: 16 }}>
              {tables.map(t => t.shape === "long" ? renderLongTable(t) : renderRoundTable(t))}
            </div>
          ) : (
            <div style={{ textAlign: "center", padding: 50, color: P.txtL }}>
              <div style={{ fontSize: 40, marginBottom: 10, opacity: 0.3 }}>{"\u2B21"}</div>
              <div style={{ fontSize: 13 }}>No tables yet {"\u2014"} create your first table above</div>
              <div style={{ fontSize: 11, marginTop: 4 }}>Choose round for dinner tables or long for banquet-style seating</div>
            </div>
          )}
        </div>
      );
    }

    /* ========== TIMELINE ========== */
    function TimelineTab({ timeline, saveTimeline, contingency, saveContingency, speeches, saveSpeeches }) {
      const [exp, setExp] = useState(2);
      const [cpOpen, setCpOpen] = useState(false);
      const [spOpen, setSpOpen] = useState(false);
      const [spForm, setSpForm] = useState({ person: "", type: "Speech", title: "", duration: 5, notes: "" });
      const [editingEv, setEditingEv] = useState(null); // {di, ii}
      const [addingDay, setAddingDay] = useState(null); // dayIdx
      const [evForm, setEvForm] = useState({ time: "", event: "", vendor: "", notes: "", link: "" });
      const safeTL = timeline.map(d => ({ ...d, items: safeArr(d.items) }));
      const tog = (di, ii) => { const u = safeTL.map((d, i) => i === di ? { ...d, items: d.items.map((it, j) => j === ii ? { ...it, done: !it.done } : it) } : d); saveTimeline(u); };
      const addEvent = (di) => { if (!evForm.time || !evForm.event.trim()) return; const u = safeTL.map((d, i) => i !== di ? d : { ...d, items: [...d.items, { ...evForm, done: false }].sort((a, b) => a.time.localeCompare(b.time)) }); saveTimeline(u); setEvForm({ time: "", event: "", vendor: "", notes: "", link: "" }); setAddingDay(null); };
      const editEvent = (di, ii, updates) => { const u = safeTL.map((d, i) => i !== di ? d : { ...d, items: d.items.map((it, j) => j !== ii ? it : { ...it, ...updates }).sort((a, b) => a.time.localeCompare(b.time)) }); saveTimeline(u); setEditingEv(null); };
      const removeEvent = (di, ii) => { if (!window.confirm("Remove this event?")) return; const u = safeTL.map((d, i) => i !== di ? d : { ...d, items: d.items.filter((_, j) => j !== ii) }); saveTimeline(u); };
      return (
        <div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
            <div>
              <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 20, fontWeight: 700, color: P.txt, marginBottom: 3 }}>Week-of Timeline</div>
              <div style={{ fontSize: 12, color: P.txtL, marginBottom: 18 }}>Thu 27 {"\u2013"} Mon 31 May 2027</div>
            </div>
            <button data-no-print onClick={() => window.print()} style={{...bS, background: P.stoneP, color: P.stone, padding: "6px 14px"}}>{"\uD83D\uDDA8"} Print</button>
          </div>
          {safeTL.map((day, di) => {
            const isE = exp === di; const dc = day.items.filter(i => i.done).length;
            return (
              <div key={di} style={{ marginBottom: 7 }}>
                <div onClick={() => setExp(isE ? -1 : di)} style={{ background: P.card, borderRadius: isE ? "14px 14px 0 0" : 14, padding: "11px 14px", cursor: "pointer", boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `5px solid ${day.color}` }}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                    <div><div style={{ fontSize: 13, fontWeight: 700, color: P.txt }}>{day.day}</div><div style={{ fontSize: 10, color: P.txtM, marginTop: 1 }}>{day.label}</div></div>
                    <div style={{ display: "flex", alignItems: "center", gap: 5 }}><span style={{ fontSize: 10, color: P.txtL }}>{dc}/{day.items.length}</span><span style={{ fontSize: 13, color: P.stoneL, transform: isE?"rotate(90deg)":"none", transition: "transform 0.2s" }}>{"\u203A"}</span></div>
                  </div>
                </div>
                {isE && (
                  <div style={{ background: P.card, borderRadius: "0 0 14px 14px", padding: "3px 14px 10px", boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `5px solid ${day.color}` }}>
                    {day.items.map((it, ii) => {
                      const isEditing = editingEv && editingEv.di === di && editingEv.ii === ii;
                      return isEditing ? (
                        <div key={ii} style={{ padding: "7px 0", borderBottom: ii < day.items.length-1?`1px solid ${P.bgD}`:"none" }}>
                          <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginBottom: 4 }}>
                            <input type="time" defaultValue={it.time} id={`ev-time-${di}-${ii}`} style={{ ...iS, width: 75, fontSize: 10 }} />
                            <input defaultValue={it.event} id={`ev-name-${di}-${ii}`} placeholder="Event" style={{ ...iS, flex: 2, minWidth: 120, fontSize: 10 }} />
                            <input defaultValue={it.vendor||""} id={`ev-vendor-${di}-${ii}`} placeholder="Vendor" style={{ ...iS, flex: 1, minWidth: 70, fontSize: 10 }} />
                          </div>
                          <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                            <input defaultValue={it.notes||""} id={`ev-notes-${di}-${ii}`} placeholder="Notes" style={{ ...iS, flex: 2, minWidth: 120, fontSize: 10 }} />
                            <input defaultValue={it.link||""} id={`ev-link-${di}-${ii}`} placeholder="Link URL" style={{ ...iS, flex: 1, minWidth: 100, fontSize: 10 }} />
                            <button onClick={() => { const g = (id) => document.getElementById(id).value; editEvent(di, ii, { time: g(`ev-time-${di}-${ii}`), event: g(`ev-name-${di}-${ii}`), vendor: g(`ev-vendor-${di}-${ii}`), notes: g(`ev-notes-${di}-${ii}`), link: g(`ev-link-${di}-${ii}`) }); }} style={{ ...bP, fontSize: 9, padding: "4px 10px" }}>Save</button>
                            <button onClick={() => setEditingEv(null)} style={{ ...bS, fontSize: 9, padding: "4px 8px" }}>Cancel</button>
                          </div>
                        </div>
                      ) : (
                        <div key={ii} style={{ display: "flex", alignItems: "flex-start", gap: 7, padding: "7px 0", borderBottom: ii < day.items.length-1?`1px solid ${P.bgD}`:"none", opacity: it.done?.4:1 }}>
                          <button onClick={() => tog(di,ii)} style={{ width: 16, height: 16, borderRadius: 4, border: `2px solid ${day.color}`, background: it.done?day.color:"transparent", cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 9, marginTop: 1, flexShrink: 0 }}>{it.done&&"\u2713"}</button>
                          <div style={{ width: 44, fontSize: 10, fontWeight: 600, color: P.txtM, flexShrink: 0, marginTop: 1 }}>{it.time}</div>
                          <div style={{ flex: 1 }}><div style={{ fontSize: 11, color: P.txt, textDecoration: it.done?"line-through":"none" }}>{it.event}{it.link && <a href={it.link} target="_blank" rel="noopener" style={{ marginLeft: 4, fontSize: 9, color: P.blue }}>{"\uD83D\uDD17"}</a>}</div>{it.vendor && <div style={{ fontSize: 9, color: day.color, marginTop: 1 }}>{"\u21B3"} {it.vendor}</div>}{it.notes && <div style={{ fontSize: 9, color: P.txtL, marginTop: 1, fontStyle: "italic" }}>{it.notes}</div>}</div>
                          <div data-no-print style={{ display: "flex", gap: 3, flexShrink: 0 }}>
                            <button onClick={() => { setEditingEv({ di, ii }); }} style={{ ...bS, fontSize: 8, padding: "2px 6px" }}>{"\u270E"}</button>
                            <button onClick={() => removeEvent(di, ii)} style={{ ...bS, color: P.red, fontSize: 8, padding: "2px 6px" }}>{"\u00D7"}</button>
                          </div>
                        </div>
                      );
                    })}
                    {addingDay === di ? (
                      <div style={{ padding: "8px 0", borderTop: `1px solid ${P.bgD}` }}>
                        <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginBottom: 4 }}>
                          <input type="time" value={evForm.time} onChange={e => setEvForm({ ...evForm, time: e.target.value })} style={{ ...iS, width: 75, fontSize: 10 }} />
                          <input value={evForm.event} onChange={e => setEvForm({ ...evForm, event: e.target.value })} placeholder="Event name" style={{ ...iS, flex: 2, minWidth: 120, fontSize: 10 }} />
                          <input value={evForm.vendor} onChange={e => setEvForm({ ...evForm, vendor: e.target.value })} placeholder="Vendor" style={{ ...iS, flex: 1, minWidth: 70, fontSize: 10 }} />
                        </div>
                        <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                          <input value={evForm.notes} onChange={e => setEvForm({ ...evForm, notes: e.target.value })} placeholder="Notes" style={{ ...iS, flex: 2, minWidth: 120, fontSize: 10 }} />
                          <input value={evForm.link} onChange={e => setEvForm({ ...evForm, link: e.target.value })} placeholder="Link URL" style={{ ...iS, flex: 1, minWidth: 100, fontSize: 10 }} />
                          <button onClick={() => addEvent(di)} style={{ ...bP, fontSize: 9, padding: "4px 10px" }}>Add</button>
                          <button onClick={() => { setAddingDay(null); setEvForm({ time: "", event: "", vendor: "", notes: "", link: "" }); }} style={{ ...bS, fontSize: 9, padding: "4px 8px" }}>Cancel</button>
                        </div>
                      </div>
                    ) : (
                      <button data-no-print onClick={() => { setAddingDay(di); setEvForm({ time: "", event: "", vendor: "", notes: "", link: "" }); }} style={{ ...bS, fontSize: 9, padding: "5px 10px", marginTop: 6, background: `${day.color}12`, color: day.color, border: `1px dashed ${day.color}40` }}>+ Add Event</button>
                    )}
                  </div>
                )}
              </div>
            );
          })}

          {/* Contingency Plans */}
          <div style={{ marginTop: 18 }}>
            <div onClick={() => setCpOpen(!cpOpen)} style={{ background: P.card, borderRadius: cpOpen ? "14px 14px 0 0" : 14, padding: "12px 14px", cursor: "pointer", boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `5px solid ${P.gold}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div>
                <div style={{ fontSize: 14, fontWeight: 700, color: P.txt, fontFamily: "'Playfair Display', Georgia, serif" }}>{"\uD83D\uDEE1"} Contingency Plans</div>
                <div style={{ fontSize: 10, color: P.txtL, marginTop: 1 }}>Backup plans for rain, vendor issues, emergencies</div>
              </div>
              <span style={{ fontSize: 15, color: P.stoneL, transform: cpOpen ? "rotate(90deg)" : "none", transition: "transform 0.2s" }}>{"\u203A"}</span>
            </div>
            {cpOpen && (
              <div style={{ background: P.card, borderRadius: "0 0 14px 14px", padding: "6px 14px 14px", boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `5px solid ${P.gold}` }}>
                {[
                  { key: "rain", icon: "\uD83C\uDF27", label: "Rain / Bad Weather", color: P.blue },
                  { key: "vendorNoShow", icon: "\u260E", label: "Vendor No-Show", color: P.terra },
                  { key: "medical", icon: "\uD83C\uDFE5", label: "Medical Emergency", color: P.red },
                  { key: "transport", icon: "\uD83D\uDE90", label: "Transport Issues", color: P.olive },
                ].map(s => (
                  <div key={s.key} style={{ marginTop: 10 }}>
                    <div style={{ fontSize: 11, fontWeight: 700, color: s.color, marginBottom: 4 }}>{s.icon} {s.label}</div>
                    <textarea
                      value={contingency[s.key] || ""}
                      onChange={e => saveContingency({ ...contingency, [s.key]: e.target.value })}
                      rows={3}
                      style={{ ...iS, width: "100%", resize: "vertical", fontSize: 11, lineHeight: 1.5 }}
                    />
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Speeches & Readings */}
          <div style={{ marginTop: 18 }}>
            <div onClick={() => setSpOpen(!spOpen)} style={{ background: P.card, borderRadius: spOpen ? "14px 14px 0 0" : 14, padding: "12px 14px", cursor: "pointer", boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `5px solid ${P.terra}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div>
                <div style={{ fontSize: 14, fontWeight: 700, color: P.txt, fontFamily: "'Playfair Display', Georgia, serif" }}>{"\uD83C\uDFA4"} Speeches & Readings</div>
                <div style={{ fontSize: 10, color: P.txtL, marginTop: 1 }}>{speeches.length} item{speeches.length !== 1 ? "s" : ""} ‚Äî {speeches.reduce((s, sp) => s + (sp.duration || 0), 0)} min total</div>
              </div>
              <span style={{ fontSize: 15, color: P.stoneL, transform: spOpen ? "rotate(90deg)" : "none", transition: "transform 0.2s" }}>{"\u203A"}</span>
            </div>
            {spOpen && (
              <div style={{ background: P.card, borderRadius: "0 0 14px 14px", padding: "8px 14px 14px", boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `5px solid ${P.terra}` }}>
                <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 10 }}>
                  <input placeholder="Person" value={spForm.person} onChange={e => setSpForm({ ...spForm, person: e.target.value })} style={{ ...iS, flex: 2, minWidth: 100 }} />
                  <select value={spForm.type} onChange={e => setSpForm({ ...spForm, type: e.target.value })} style={{ ...iS, flex: 1, minWidth: 80, background: "#fff" }}>
                    {["Speech", "Reading", "Toast", "Prayer", "Other"].map(t => <option key={t} value={t}>{t}</option>)}
                  </select>
                  <input placeholder="Title (optional)" value={spForm.title} onChange={e => setSpForm({ ...spForm, title: e.target.value })} style={{ ...iS, flex: 2, minWidth: 100 }} />
                  <input type="number" min="1" max="30" placeholder="Min" value={spForm.duration} onChange={e => setSpForm({ ...spForm, duration: parseInt(e.target.value) || 0 })} style={{ ...iS, width: 45 }} />
                  <button onClick={() => {
                    if (!spForm.person.trim()) return;
                    saveSpeeches([...speeches, { ...spForm, id: Date.now(), order: speeches.length }]);
                    setSpForm({ person: "", type: "Speech", title: "", duration: 5, notes: "" });
                  }} style={{ ...bP, fontSize: 10, padding: "6px 12px" }}>+ Add</button>
                </div>
                {speeches.length > 0 && speeches.sort((a, b) => (a.order || 0) - (b.order || 0)).map((sp, idx) => (
                  <div key={sp.id} style={{ display: "flex", alignItems: "center", gap: 6, padding: "7px 0", borderBottom: `1px solid ${P.bgD}` }}>
                    <div style={{ display: "flex", flexDirection: "column", gap: 1 }}>
                      <button onClick={() => { if (idx === 0) return; const ns = [...speeches]; const prev = ns.find(s => s.order === idx - 1); const cur = ns.find(s => s.order === idx); if (prev && cur) { prev.order = idx; cur.order = idx - 1; } saveSpeeches(ns); }} style={{ ...bS, padding: "0 4px", fontSize: 9, opacity: idx === 0 ? 0.3 : 1 }}>{"\u25B2"}</button>
                      <button onClick={() => { if (idx === speeches.length - 1) return; const ns = [...speeches]; const next = ns.find(s => s.order === idx + 1); const cur = ns.find(s => s.order === idx); if (next && cur) { next.order = idx; cur.order = idx + 1; } saveSpeeches(ns); }} style={{ ...bS, padding: "0 4px", fontSize: 9, opacity: idx === speeches.length - 1 ? 0.3 : 1 }}>{"\u25BC"}</button>
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 11, fontWeight: 600, color: P.txt }}>{sp.person} <span style={{ fontSize: 9, padding: "1px 5px", borderRadius: 4, background: sp.type === "Speech" ? P.terraP : sp.type === "Reading" ? P.blueP : P.oliveP, color: sp.type === "Speech" ? P.terra : sp.type === "Reading" ? P.blue : P.olive, marginLeft: 3 }}>{sp.type}</span></div>
                      {sp.title && <div style={{ fontSize: 10, color: P.txtL, marginTop: 1 }}>{sp.title}</div>}
                      <div style={{ fontSize: 9, color: P.txtL, marginTop: 1 }}>{sp.duration} min{sp.notes ? ` ‚Äî ${sp.notes}` : ""}</div>
                    </div>
                    <button onClick={() => { if (!window.confirm(`Remove ${sp.person}'s ${sp.type.toLowerCase()}?`)) return; const ns = speeches.filter(s => s.id !== sp.id).map((s, i) => ({ ...s, order: i })); saveSpeeches(ns); }} style={{ ...bS, color: P.red, fontSize: 10, padding: "4px 8px" }}>{"\u00D7"}</button>
                  </div>
                ))}
                {speeches.length > 0 && (
                  <div style={{ marginTop: 8, fontSize: 10, color: P.txtM, textAlign: "right" }}>
                    Total: {speeches.reduce((s, sp) => s + (sp.duration || 0), 0)} minutes
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      );
    }

    /* ========== MUSIC ========== */
    function MusicTab({ music: rawMusic, saveMusic }) {
      const music = { mustPlay: safeArr(rawMusic.mustPlay), neverPlay: safeArr(rawMusic.neverPlay), requests: safeArr(rawMusic.requests) };
      const [input, setInput] = useState({ must: "", never: "", req: "", reqBy: "", moment: "" });
      const normMust = (item) => typeof item === "string" ? { song: item, moment: "" } : item;
      const add = (list, item) => { if (!item.trim()) return; const val = list === "mustPlay" ? { song: item, moment: input.moment } : list === "requests" ? { song: item, by: input.reqBy } : item; saveMusic({ ...rawMusic, [list]: [...music[list], val] }); setInput({ ...input, [list === "mustPlay" ? "must" : list === "neverPlay" ? "never" : "req"]: "", reqBy: list === "requests" ? "" : input.reqBy, moment: list === "mustPlay" ? "" : input.moment }); };
      const rm = (list, idx) => { if (!window.confirm("Remove this song?")) return; saveMusic({ ...rawMusic, [list]: music[list].filter((_, i) => i !== idx) }); };

      return (
        <div>
          <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 20, fontWeight: 700, color: P.txt, marginBottom: 3 }}>Music</div>
          <div style={{ fontSize: 12, color: P.txtL, marginBottom: 18 }}>Build your playlist brief for the DJ / band</div>

          <div style={{ background: P.card, borderRadius: 14, padding: 16, marginBottom: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.03)", borderLeft: `4px solid ${P.green}` }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: P.txt, marginBottom: 8 }}>{"\u2705"} Must Play</div>
            <div style={{ display: "flex", gap: 5, marginBottom: 8, flexWrap: "wrap" }}>
              <input placeholder="Song \u2014 Artist" value={input.must} onChange={e => setInput({...input,must:e.target.value})} onKeyDown={e => e.key==="Enter"&&add("mustPlay",input.must)} style={{ ...iS, flex: 2, minWidth: 140 }} />
              <select value={input.moment} onChange={e => setInput({...input,moment:e.target.value})} style={{...iS, flex:1, minWidth:90, background:"#fff"}}>{MUSIC_MOMENTS.map(m=><option key={m} value={m}>{m||"Any moment"}</option>)}</select>
              <button onClick={() => add("mustPlay", input.must)} style={{...bS,background:P.greenP,color:P.green}}>Add</button>
            </div>
            {music.mustPlay.map((s, i) => { const n = normMust(s); return (
              <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "5px 0", borderBottom: i<music.mustPlay.length-1?`1px solid ${P.bgD}`:"none" }}>
                <span style={{ fontSize: 12, color: P.txt }}>{"\uD83C\uDFB5"} {n.song}{n.moment && <span style={{ marginLeft: 5, padding: "1px 6px", borderRadius: 6, background: P.oliveP, color: P.olive, fontSize: 9 }}>{n.moment}</span>}</span>
                <button onClick={() => rm("mustPlay",i)} style={{ background:"none",border:"none",cursor:"pointer",color:P.stoneL,fontSize:13 }}>{"\u00D7"}</button>
              </div>
            ); })}
            {music.mustPlay.length === 0 && <div style={{ fontSize: 11, color: P.txtL, padding: 4 }}>No must-play songs yet<div style={{ fontSize: 10, marginTop: 2 }}>Add your first dance song or ceremony entrance track</div></div>}
          </div>

          <div style={{ background: P.card, borderRadius: 14, padding: 16, marginBottom: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.03)", borderLeft: `4px solid ${P.red}` }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: P.txt, marginBottom: 8 }}>{"\uD83D\uDEAB"} Do Not Play</div>
            <div style={{ display: "flex", gap: 5, marginBottom: 8 }}>
              <input placeholder="Song \u2014 Artist" value={input.never} onChange={e => setInput({...input,never:e.target.value})} onKeyDown={e => e.key==="Enter"&&add("neverPlay",input.never)} style={{ ...iS, flex: 1 }} />
              <button onClick={() => add("neverPlay", input.never)} style={{...bS,background:P.redP,color:P.red}}>Add</button>
            </div>
            {music.neverPlay.map((s, i) => (
              <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "5px 0", borderBottom: i<music.neverPlay.length-1?`1px solid ${P.bgD}`:"none" }}>
                <span style={{ fontSize: 12, color: P.txt }}>{"\uD83D\uDEAB"} {s}</span>
                <button onClick={() => rm("neverPlay",i)} style={{ background:"none",border:"none",cursor:"pointer",color:P.stoneL,fontSize:13 }}>{"\u00D7"}</button>
              </div>
            ))}
            {music.neverPlay.length === 0 && <div style={{ fontSize: 11, color: P.txtL, padding: 4 }}>No banned songs (yet!)<div style={{ fontSize: 10, marginTop: 2 }}>Any songs that would kill the vibe?</div></div>}
          </div>

          <div style={{ background: P.card, borderRadius: 14, padding: 16, boxShadow: "0 1px 3px rgba(0,0,0,0.03)", borderLeft: `4px solid ${P.gold}` }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: P.txt, marginBottom: 8 }}>{"\uD83D\uDC83"} Guest Requests</div>
            <div style={{ display: "flex", gap: 5, marginBottom: 8, flexWrap: "wrap" }}>
              <input placeholder="Song \u2014 Artist" value={input.req} onChange={e => setInput({...input,req:e.target.value})} style={{ ...iS, flex: 2, minWidth: 140 }} />
              <input placeholder="Requested by" value={input.reqBy} onChange={e => setInput({...input,reqBy:e.target.value})} style={{ ...iS, flex: 1, minWidth: 90 }} />
              <button onClick={() => add("requests", input.req)} style={{...bS,background:P.goldP,color:P.gold}}>Add</button>
            </div>
            {music.requests.map((r, i) => (
              <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "5px 0", borderBottom: i<music.requests.length-1?`1px solid ${P.bgD}`:"none" }}>
                <span style={{ fontSize: 12, color: P.txt }}>{"\uD83C\uDFB6"} {r.song}{r.by ? ` (${r.by})` : ""}</span>
                <button onClick={() => rm("requests",i)} style={{ background:"none",border:"none",cursor:"pointer",color:P.stoneL,fontSize:13 }}>{"\u00D7"}</button>
              </div>
            ))}
            {music.requests.length === 0 && <div style={{ fontSize: 11, color: P.txtL, padding: 4 }}>No guest requests yet<div style={{ fontSize: 10, marginTop: 2 }}>Collect song requests from your guests ahead of the big day</div></div>}
          </div>
        </div>
      );
    }

    /* ========== PACKING ========== */
    function PackingTab({ packing: rawPacking, savePacking }) {
      const packing = safeArr(rawPacking).map(c => ({ ...c, items: safeArr(c.items) }));
      const [adding, setAdding] = useState(null);
      const [newItem, setNewItem] = useState("");
      const [newCat, setNewCat] = useState("");

      const toggle = (ci, ii) => {
        const u = packing.map((c, i) => i === ci ? { ...c, items: c.items.map((it, j) => j === ii ? { ...it, done: !it.done } : it) } : c);
        savePacking(u);
      };
      const addItem = (ci) => {
        if (!newItem.trim()) return;
        const u = packing.map((c, i) => i === ci ? { ...c, items: [...c.items, { text: newItem.trim(), done: false }] } : c);
        savePacking(u); setNewItem(""); setAdding(null);
      };
      const rmItem = (ci, ii) => {
        if (!window.confirm("Remove this item?")) return;
        const u = packing.map((c, i) => i === ci ? { ...c, items: c.items.filter((_, j) => j !== ii) } : c);
        savePacking(u);
      };
      const total = packing.reduce((s, c) => s + c.items.length, 0);
      const done = packing.reduce((s, c) => s + c.items.filter(i => i.done).length, 0);

      return (
        <div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 18 }}>
            <div>
              <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 20, fontWeight: 700, color: P.txt }}>Packing List</div>
              <div style={{ fontSize: 12, color: P.txtL, marginTop: 2 }}>{done}/{total} packed</div>
            </div>
            <div style={{ background: P.bgD, borderRadius: 20, height: 8, width: 120, overflow: "hidden" }}>
              <div style={{ height: "100%", borderRadius: 20, width: `${total?done/total*100:0}%`, background: P.olive, transition: "width 0.3s" }} />
            </div>
          </div>

          {packing.map((cat, ci) => {
            const catDone = cat.items.filter(i => i.done).length;
            return (
              <div key={ci} style={{ background: P.card, borderRadius: 14, padding: 14, marginBottom: 10, boxShadow: "0 1px 3px rgba(0,0,0,0.03)" }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
                  <div style={{ fontSize: 13, fontWeight: 700, color: P.txt }}>{cat.cat}</div>
                  <div style={{ fontSize: 10, color: catDone === cat.items.length && cat.items.length > 0 ? P.green : P.txtL }}>{catDone}/{cat.items.length}</div>
                </div>
                {cat.items.map((it, ii) => (
                  <div key={ii} style={{ display: "flex", alignItems: "center", gap: 8, padding: "5px 0", borderBottom: ii < cat.items.length-1?`1px solid ${P.bgD}`:"none" }}>
                    <button onClick={() => toggle(ci, ii)} style={{ width: 17, height: 17, borderRadius: 4, border: `2px solid ${it.done?P.green:P.stoneL}`, background: it.done?P.green:"transparent", cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 9, flexShrink: 0 }}>{it.done&&"\u2713"}</button>
                    <span style={{ fontSize: 12, color: P.txt, textDecoration: it.done?"line-through":"none", opacity: it.done?.5:1, flex: 1 }}>{it.text}</span>
                    <button onClick={() => rmItem(ci, ii)} style={{ background:"none",border:"none",cursor:"pointer",color:P.stoneL,fontSize:12,padding:0 }}>{"\u00D7"}</button>
                  </div>
                ))}
                {adding === ci ? (
                  <div style={{ display: "flex", gap: 5, marginTop: 6 }}>
                    <input value={newItem} onChange={e => setNewItem(e.target.value)} onKeyDown={e => e.key==="Enter"&&addItem(ci)} placeholder="New item..." style={{ ...iS, flex: 1, fontSize: 11 }} autoFocus />
                    <button onClick={() => addItem(ci)} style={{...bS,background:P.oliveP,color:P.olive,fontSize:10}}>Add</button>
                    <button onClick={() => { setAdding(null); setNewItem(""); }} style={{...bS,background:P.bgD,color:P.txtM,fontSize:10}}>Cancel</button>
                  </div>
                ) : (
                  <button onClick={() => setAdding(ci)} style={{ fontSize: 11, color: P.txtL, background: "none", border: "none", cursor: "pointer", marginTop: 4, padding: 0 }}>+ Add item</button>
                )}
              </div>
            );
          })}

          {/* Add Category */}
          <div style={{ display: "flex", gap: 5, marginTop: 10 }}>
            <input placeholder="New category name..." value={newCat} onChange={e => setNewCat(e.target.value)} onKeyDown={e => { if (e.key === "Enter" && newCat.trim()) { savePacking([...packing, { cat: newCat.trim(), items: [] }]); setNewCat(""); }}} style={{ ...iS, flex: 1 }} />
            <button onClick={() => { if (!newCat.trim()) return; savePacking([...packing, { cat: newCat.trim(), items: [] }]); setNewCat(""); }} style={{...bS, background: P.oliveP, color: P.olive}}>+ Category</button>
          </div>
        </div>
      );
    }

    /* ========== DECISIONS ========== */
    function DecisionsTab({ decisions, saveDecisions }) {
      const [showForm, setShowForm] = useState(false);
      const [editingId, setEditingId] = useState(null);
      const [form, setForm] = useState({ title: "", decision: "", reasoning: "", category: "General", date: new Date().toISOString().split("T")[0] });
      const addD = () => { if (!form.title.trim()) return; saveDecisions([{ ...form, id: Date.now() }, ...decisions]); setForm({ title: "", decision: "", reasoning: "", category: "General", date: new Date().toISOString().split("T")[0] }); setShowForm(false); };
      const upD = (id, updates) => saveDecisions(decisions.map(d => d.id === id ? { ...d, ...updates } : d));

      return (
        <div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
            <div><div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 20, fontWeight: 700, color: P.txt }}>Decision Log</div><div style={{ fontSize: 12, color: P.txtL, marginTop: 2 }}>So you never re-debate what's settled</div></div>
            <button onClick={() => setShowForm(!showForm)} style={bP}>+ Add</button>
          </div>
          {showForm && (
            <div style={{ background: P.terraP, borderRadius: 14, padding: 14, marginBottom: 14 }}>
              <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                <input placeholder="What was decided?" value={form.title} onChange={e => setForm({...form,title:e.target.value})} style={{ ...iS, flex: 3, minWidth: 150 }} />
                <select value={form.category} onChange={e => setForm({...form,category:e.target.value})} style={{ ...iS, flex: 1, minWidth: 110, background: "#fff" }}>{DECISION_CATS.map(c=><option key={c}>{c}</option>)}</select>
              </div>
              <textarea placeholder="The decision" value={form.decision} onChange={e => setForm({...form,decision:e.target.value})} style={{ ...iS, minHeight: 36, resize: "vertical", marginBottom: 5 }} />
              <div style={{ display: "flex", gap: 5 }}>
                <textarea placeholder="Why? (so future-you remembers)" value={form.reasoning} onChange={e => setForm({...form,reasoning:e.target.value})} style={{ ...iS, flex: 1, minHeight: 36, resize: "vertical" }} />
                <button onClick={addD} style={{...bP,alignSelf:"flex-end"}}>Save</button>
              </div>
            </div>
          )}
          {decisions.length === 0 ? <div style={{ textAlign: "center", padding: 40, color: P.txtL }}><div style={{ fontSize: 30, marginBottom: 8 }}>{"\u270E"}</div><div style={{ fontSize: 12 }}>No decisions yet</div><div style={{ fontSize: 10, marginTop: 4 }}>Track venue, menu, colour scheme and other choices</div></div>
          : decisions.map(d => {
            const isEd = editingId === d.id;
            return (
            <div key={d.id} style={{ background: P.card, borderRadius: 12, padding: "13px 15px", marginBottom: 7, boxShadow: "0 1px 3px rgba(0,0,0,0.03)", borderLeft: `4px solid ${P.olive}`, border: isEd ? `2px solid ${P.terra}` : "2px solid transparent" }}>
              {isEd ? (
                <div>
                  <div style={{ display: "flex", gap: 5, flexWrap: "wrap", marginBottom: 5 }}>
                    <input value={d.title} onChange={e => upD(d.id,{title:e.target.value})} style={{ ...iS, flex: 3, minWidth: 150 }} />
                    <select value={d.category} onChange={e => upD(d.id,{category:e.target.value})} style={{ ...iS, flex: 1, minWidth: 100, background: "#fff" }}>{DECISION_CATS.map(c=><option key={c}>{c}</option>)}</select>
                  </div>
                  <textarea value={d.decision||""} onChange={e => upD(d.id,{decision:e.target.value})} placeholder="The decision" style={{ ...iS, minHeight: 36, resize: "vertical", marginBottom: 5 }} />
                  <textarea value={d.reasoning||""} onChange={e => upD(d.id,{reasoning:e.target.value})} placeholder="Why?" style={{ ...iS, minHeight: 36, resize: "vertical", marginBottom: 5 }} />
                  <div style={{ display: "flex", gap: 5, justifyContent: "flex-end" }}>
                    <button onClick={() => { if (window.confirm("Delete this decision?")) saveDecisions(decisions.filter(x=>x.id!==d.id)); }} style={{...bS,background:P.redP,color:P.red}}>Delete</button>
                    <button onClick={() => setEditingId(null)} style={bP}>Done</button>
                  </div>
                </div>
              ) : (
                <div>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                    <div onClick={() => setEditingId(d.id)} style={{ cursor: "pointer", flex: 1 }}><div style={{ fontSize: 12, fontWeight: 700, color: P.txt }}>{d.title}</div><div style={{ display: "flex", gap: 5, marginTop: 3 }}><span style={{ fontSize: 9, padding: "2px 6px", borderRadius: 10, background: P.oliveP, color: P.olive, fontWeight: 600 }}>{d.category}</span><span style={{ fontSize: 10, color: P.txtL }}>{new Date(d.date).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}</span></div></div>
                    <button onClick={() => setEditingId(isEd ? null : d.id)} style={{ background:"none",border:"none",cursor:"pointer",color:P.stoneL,fontSize:11 }}>{"\u270E"}</button>
                  </div>
                  {d.decision && <div style={{ fontSize: 11, color: P.txt, marginTop: 7, padding: "7px 9px", background: P.oliveP, borderRadius: 8 }}>{"\u2713"} {d.decision}</div>}
                  {d.reasoning && <div style={{ fontSize: 10, color: P.txtM, marginTop: 5, fontStyle: "italic" }}>{"\uD83D\uDCAD"} {d.reasoning}</div>}
                </div>
              )}
            </div>
          ); })}
        </div>
      );
    }

    /* ========== ROOMS ========== */
    function RoomsTab({ rooms, saveRooms, guests }) {
      const confirmed = guests.filter(g => g.status !== "Declined");
      const allAssigned = [...safeArr(rooms.santarsa), ...safeArr(rooms.vallorsaia)].flatMap(r => safeArr(r.guests));
      const unassigned = confirmed.filter(g => !allAssigned.includes(g.name)).map(g => g.name);

      const assign = (villa, ri, gName) => {
        if (!gName) return;
        const u = { ...rooms, [villa]: safeArr(rooms[villa]).map((r, i) => i === ri ? { ...r, guests: [...(r.guests||[]), gName] } : r) };
        saveRooms(u);
      };
      const remove = (villa, ri, gName) => {
        const u = { ...rooms, [villa]: safeArr(rooms[villa]).map((r, i) => i === ri ? { ...r, guests: (r.guests||[]).filter(g => g !== gName) } : r) };
        saveRooms(u);
      };

      const villaStats = (key) => {
        const rs = rooms[key] || [];
        const beds = rs.reduce((s, r) => s + r.sleeps, 0);
        const used = rs.reduce((s, r) => s + (r.guests||[]).length, 0);
        return { beds, used, free: beds - used };
      };
      const sS = villaStats("santarsa"), vS = villaStats("vallorsaia");

      const VillaSection = ({ title, villa, stats, color }) => (
        <div style={{ marginBottom: 18 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
            <div style={{ fontSize: 15, fontWeight: 700, color: P.txt, fontFamily: "'Playfair Display', Georgia, serif" }}>{title}</div>
            <div style={{ display: "flex", gap: 10, fontSize: 10 }}>
              <span style={{ color: P.txtM }}>{stats.beds} beds</span>
              <span style={{ color: P.olive }}>{stats.used} assigned</span>
              <span style={{ color: stats.free > 0 ? P.txtL : P.red }}>{stats.free} free</span>
            </div>
          </div>
          <div style={{ background: P.bgD, borderRadius: 8, height: 5, marginBottom: 12, overflow: "hidden" }}>
            <div style={{ height: "100%", borderRadius: 8, width: `${stats.beds ? Math.min(stats.used/stats.beds*100,100) : 0}%`, background: stats.used > stats.beds ? P.red : color, transition: "width 0.3s" }} />
          </div>
          {(rooms[villa]||[]).map((r, ri) => {
            const full = (r.guests||[]).length >= r.sleeps;
            const villaName = villa === "santarsa" ? "Santarsa" : "Vallorsaia";
            const available = unassigned.filter(n => { const gObj = confirmed.find(g => g.name === n); return !(r.guests||[]).includes(n) && (!gObj?.villa || gObj.villa === villaName || gObj.villa === "Off-site"); });
            return (
              <div key={ri} style={{ background: P.card, borderRadius: 10, padding: "10px 12px", marginBottom: 5, boxShadow: "0 1px 3px rgba(0,0,0,0.03)", borderLeft: `3px solid ${full ? P.olive : P.stoneL}` }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: (r.guests||[]).length > 0 || !full ? 6 : 0 }}>
                  <div style={{ fontSize: 12, fontWeight: 600, color: P.txt }}>{r.name}</div>
                  <div style={{ fontSize: 10, color: full ? P.olive : P.txtL }}>{(r.guests||[]).length}/{r.sleeps}</div>
                </div>
                {(r.guests||[]).length > 0 && (
                  <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginBottom: !full ? 6 : 0 }}>
                    {(r.guests||[]).map(g => (
                      <span key={g} style={{ padding: "2px 8px", borderRadius: 12, background: P.oliveP, fontSize: 11, color: P.olive, display: "flex", alignItems: "center", gap: 4 }}>
                        {g} <button onClick={() => remove(villa, ri, g)} style={{ background: "none", border: "none", cursor: "pointer", color: P.olive, fontSize: 12, padding: 0, lineHeight: 1 }}>{"\u00D7"}</button>
                      </span>
                    ))}
                  </div>
                )}
                {!full && available.length > 0 && (
                  <select onChange={e => { assign(villa, ri, e.target.value); e.target.value = ""; }} style={{ ...iS, fontSize: 11, padding: "4px 8px", background: "#fff" }} defaultValue="">
                    <option value="" disabled>+ Assign guest{"\u2026"}</option>
                    {available.map(n => <option key={n}>{n}</option>)}
                  </select>
                )}
              </div>
            );
          })}
        </div>
      );

      return (
        <div>
          <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 20, fontWeight: 700, color: P.txt, marginBottom: 3 }}>Room Allocation</div>
          <div style={{ fontSize: 12, color: P.txtL, marginBottom: 18 }}>Assign guests to villa rooms {"\u00B7"} {allAssigned.length} assigned / {confirmed.length} guests</div>

          {unassigned.length > 0 && (
            <div style={{ background: P.goldP, borderRadius: 12, padding: 14, marginBottom: 16 }}>
              <div style={{ fontSize: 11, fontWeight: 600, color: P.gold, marginBottom: 6 }}>Unassigned ({unassigned.length})</div>
              <div style={{ display: "flex", gap: 5, flexWrap: "wrap" }}>
                {unassigned.map(n => (<span key={n} style={{ padding: "3px 10px", borderRadius: 14, background: "#fff", fontSize: 11, color: P.txt }}>{n}</span>))}
              </div>
            </div>
          )}

          <div style={{ display: "flex", gap: 10, marginBottom: 18 }}>
            {[{ l: "Santarsa", v: `${sS.used}/${sS.beds}`, c: P.terra }, { l: "Vallorsaia", v: `${vS.used}/${vS.beds}`, c: P.olive }, { l: "Total", v: `${sS.used+vS.used}/${sS.beds+vS.beds}`, c: P.stone }].map((s,i) => (
              <div key={i} style={{ flex: 1, background: P.card, borderRadius: 12, padding: "10px 12px", boxShadow: "0 1px 3px rgba(0,0,0,0.03)", borderTop: `3px solid ${s.c}` }}>
                <div style={{ fontSize: 18, fontWeight: 700, color: P.txt }}>{s.v}</div>
                <div style={{ fontSize: 9, color: P.txtL, textTransform: "uppercase", letterSpacing: 1 }}>{s.l}</div>
              </div>
            ))}
          </div>

          <VillaSection title="Villa Santarsa" villa="santarsa" stats={sS} color={P.terra} />
          <VillaSection title="Villa Vallorsaia" villa="vallorsaia" stats={vS} color={P.olive} />
        </div>
      );
    }

    /* ========== PROJECT TIMELINE ========== */
    function ProjectTab({ milestones, saveMilestones, vendors, budget, upPay, legalChecklist, saveLegalChecklist, prepChecklist, savePrepChecklist }) {
      const now = new Date();
      const [showAdd, setShowAdd] = useState(false);
      const [form, setForm] = useState({ task: "", due: "", assignee: "" });
      const [assigneeFilter, setAssigneeFilter] = useState("");
      const [expIdea, setExpIdea] = useState(null);
      const [addedFlash, setAddedFlash] = useState(null);
      const scrollRef = React.useRef(null);

      const PHASES = [
        { id: "early", label: "Early Planning", range: ["2026-02", "2026-05"], color: P.blue },
        { id: "booking", label: "Booking", range: ["2026-06", "2026-09"], color: P.terra },
        { id: "planning", label: "Planning", range: ["2026-10", "2026-12"], color: P.olive },
        { id: "countdown", label: "Countdown", range: ["2027-01", "2027-03"], color: P.gold },
        { id: "final", label: "Final", range: ["2027-04", "2027-05"], color: P.red },
      ];

      const startMonth = new Date(Math.min(now.getTime(), new Date("2026-06-01").getTime()));
      startMonth.setDate(1);
      const months = [];
      const cursor = new Date(startMonth);
      while (cursor <= WEDDING_DATE) { months.push(new Date(cursor)); cursor.setMonth(cursor.getMonth() + 1); }

      const filteredMs = assigneeFilter ? milestones.filter(m => (m.assignee||"")=== assigneeFilter || (m.assignee||"")==="Both") : milestones;
      const mByMonth = {}; filteredMs.forEach(m => { const k = m.due.substring(0,7); if (!mByMonth[k]) mByMonth[k] = []; mByMonth[k].push(m); });
      const payByMonth = {}; upPay.forEach(p => { const k = p.date.substring(0,7); if (!payByMonth[k]) payByMonth[k] = []; payByMonth[k].push(p); });

      const bookedV = vendors.filter(v => ["Booked","Paid Deposit","Paid in Full"].includes(v.status)).length;
      const unbookedKey = vendors.filter(v => v.starred && !["Booked","Paid Deposit","Paid in Full"].includes(v.status)).length;

      const toggleM = (task) => { const i = milestones.findIndex(m => m.task === task); if (i<0) return; const u = [...milestones]; u[i] = {...u[i], done:!u[i].done}; saveMilestones(u); };
      const addM = () => { if (!form.task.trim()||!form.due) return; saveMilestones([...milestones, { task:form.task, due:form.due, done:false, assignee:form.assignee }]); setForm({ task:"", due:"", assignee:"" }); setShowAdd(false); };
      const rmM = (task) => { if (!window.confirm("Remove this milestone?")) return; saveMilestones(milestones.filter(m => m.task !== task)); };

      const done = milestones.filter(m => m.done).length;
      const overdue = milestones.filter(m => !m.done && new Date(m.due) < now).length;
      const pct = milestones.length ? Math.round(done / milestones.length * 100) : 0;

      const getPhase = (ym) => PHASES.find(p => ym >= p.range[0] && ym <= p.range[1]);
      const isCurMonth = (d) => d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
      const isPast = (d) => { const e = new Date(d); e.setMonth(e.getMonth()+1); return e < now; };

      // Auto-scroll to current month on mount
      useEffect(() => {
        if (scrollRef.current) {
          const cur = scrollRef.current.querySelector("[data-current]");
          if (cur) cur.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
        }
      }, []);

      const COL = 155;

      return (
        <div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 14, flexWrap: "wrap", gap: 8 }}>
            <div>
              <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 20, fontWeight: 700, color: P.txt }}>Project Timeline</div>
              <div style={{ fontSize: 12, color: P.txtL, marginTop: 2 }}>Scroll to see your full planning journey</div>
            </div>
            <div style={{ display: "flex", gap: 4, alignItems: "center" }}>
              <div style={{ display: "flex", gap: 2, background: P.bgD, borderRadius: 7, padding: 2 }}>
                {["","Sophie","Joe","Planner"].map(a => (<button key={a} onClick={() => setAssigneeFilter(assigneeFilter===a?"":a)} style={{ ...bS, background: assigneeFilter===a?P.terra:"transparent", color: assigneeFilter===a?"#fff":P.txtM, padding: "2px 8px", fontSize: 10 }}>{a||"All"}</button>))}
              </div>
              <button onClick={() => setShowAdd(!showAdd)} style={bP}>+ Milestone</button>
            </div>
          </div>

          {showAdd && (
            <div style={{ background: P.terraP, borderRadius: 14, padding: 14, marginBottom: 14 }}>
              <div style={{ display: "flex", gap: 5, flexWrap: "wrap" }}>
                <input placeholder="What needs doing?" value={form.task} onChange={e => setForm({...form,task:e.target.value})} style={{ ...iS, flex: 3, minWidth: 150 }} />
                <input type="date" value={form.due} onChange={e => setForm({...form,due:e.target.value})} style={{ ...iS, flex: 1, minWidth: 120 }} />
                <select value={form.assignee} onChange={e => setForm({...form,assignee:e.target.value})} style={{...iS, flex:1, minWidth:80, background:"#fff"}}>{MILESTONE_ASSIGNEES.map(a=><option key={a} value={a}>{a||"Anyone"}</option>)}</select>
                <button onClick={addM} style={bP}>Add</button>
              </div>
            </div>
          )}

          {/* Stats row */}
          <div style={{ display: "flex", gap: 8, marginBottom: 14, flexWrap: "wrap" }}>
            {[{ l: "Done", v: done, c: P.green },{ l: "Overdue", v: overdue, c: overdue ? P.red : P.stone },{ l: "Remaining", v: milestones.length - done, c: P.stone },{ l: "Booked", v: bookedV, c: P.olive },{ l: "Unbooked", v: unbookedKey, c: unbookedKey ? P.gold : P.stone }].map((s,i) => (
              <div key={i} style={{ flex: 1, minWidth: 65, background: P.card, borderRadius: 12, padding: "8px 10px", boxShadow: "0 1px 3px rgba(0,0,0,0.03)", borderTop: `3px solid ${s.c}`, textAlign: "center" }}>
                <div style={{ fontSize: 16, fontWeight: 700, color: P.txt }}>{s.v}</div>
                <div style={{ fontSize: 8, color: P.txtL, textTransform: "uppercase", letterSpacing: 1 }}>{s.l}</div>
              </div>
            ))}
          </div>

          {/* Progress bar */}
          <div style={{ background: P.card, borderRadius: 10, padding: "10px 14px", marginBottom: 14, boxShadow: "0 1px 3px rgba(0,0,0,0.03)" }}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}>
              <span style={{ fontSize: 11, fontWeight: 600, color: P.txt }}>Overall Progress</span>
              <span style={{ fontSize: 11, fontWeight: 700, color: P.terra }}>{pct}%</span>
            </div>
            <div style={{ background: P.bgD, borderRadius: 6, height: 6, overflow: "hidden" }}>
              <div style={{ height: "100%", borderRadius: 6, width: `${pct}%`, background: `linear-gradient(90deg, ${P.olive}, ${P.oliveL})`, transition: "width 0.5s" }} />
            </div>
          </div>

          {/* Phase legend */}
          <div style={{ display: "flex", gap: 10, marginBottom: 10 }}>
            {PHASES.map(p => (<div key={p.id} style={{ display: "flex", alignItems: "center", gap: 4 }}><div style={{ width: 8, height: 8, borderRadius: 2, background: p.color }} /><span style={{ fontSize: 10, color: P.txtM }}>{p.label}</span></div>))}
            <div style={{ display: "flex", alignItems: "center", gap: 4 }}><div style={{ width: 8, height: 8, borderRadius: 2, background: P.gold, opacity: 0.5 }} /><span style={{ fontSize: 10, color: P.txtM }}>Payment</span></div>
          </div>

          {/* Horizontal scrolling calendar */}
          <div ref={scrollRef} style={{ overflowX: "auto", overflowY: "visible", paddingBottom: 12, marginLeft: -10, marginRight: -10, paddingLeft: 10, paddingRight: 10 }}>
            {/* Phase bars */}
            <div style={{ display: "flex", minWidth: months.length * COL, marginBottom: 2 }}>
              {months.map((m, mi) => {
                const ym = `${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,"0")}`;
                const phase = getPhase(ym);
                const prevYm = mi > 0 ? `${months[mi-1].getFullYear()}-${String(months[mi-1].getMonth()+1).padStart(2,"0")}` : "";
                const prevPhase = mi > 0 ? getPhase(prevYm) : null;
                const isFirst = !prevPhase || prevPhase?.id !== phase?.id;
                return (
                  <div key={ym} style={{ width: COL, flexShrink: 0 }}>
                    {phase && isFirst ? (
                      <div style={{ fontSize: 9, fontWeight: 600, color: phase.color, textTransform: "uppercase", letterSpacing: 1, padding: "2px 0" }}>{phase.label}</div>
                    ) : <div style={{ height: 16 }} />}
                  </div>
                );
              })}
            </div>

            {/* Month columns */}
            <div style={{ display: "flex", minWidth: months.length * COL, position: "relative" }}>
              {/* Horizontal track line */}
              <div style={{ position: "absolute", top: 18, left: 0, right: 0, height: 2, background: P.bgD, zIndex: 0 }} />

              {months.map((m, mi) => {
                const ym = `${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,"0")}`;
                const items = mByMonth[ym] || [];
                const pays = payByMonth[ym] || [];
                const phase = getPhase(ym);
                const cur = isCurMonth(m);
                const past = isPast(m);
                const isWedding = ym === "2027-05";
                const monthShort = m.toLocaleDateString("en-GB", { month: "short" });
                const yearShort = m.toLocaleDateString("en-GB", { year: "2-digit" });

                return (
                  <div key={ym} {...(cur ? {"data-current":""} : {})} style={{ width: COL, flexShrink: 0, position: "relative", zIndex: 1 }}>
                    {/* Month header + dot */}
                    <div style={{ textAlign: "center", marginBottom: 10 }}>
                      <div style={{ fontSize: 11, fontWeight: cur ? 700 : 500, color: cur ? P.terra : past ? P.txtL : P.txt }}>{monthShort}</div>
                      <div style={{ fontSize: 9, color: P.txtL }}>{yearShort}</div>
                      <div style={{
                        width: cur ? 14 : 10, height: cur ? 14 : 10, borderRadius: "50%", margin: "4px auto 0",
                        background: cur ? P.terra : isWedding ? P.terra : past ? P.olive : phase ? phase.color : P.stoneL,
                        border: cur ? `3px solid ${P.terraL}` : isWedding ? `3px solid ${P.terraL}` : "2px solid #fff",
                        boxShadow: cur ? `0 0 0 3px ${P.terraP}` : isWedding ? `0 0 0 3px ${P.terraP}` : "none",
                        position: "relative", zIndex: 2,
                      }} />
                      {cur && <div style={{ fontSize: 8, fontWeight: 700, color: P.terra, marginTop: 2 }}>NOW</div>}
                      {isWedding && !cur && <div style={{ fontSize: 8, fontWeight: 700, color: P.terra, marginTop: 2 }}>{"\uD83D\uDC8D"}</div>}
                    </div>

                    {/* Cards stack */}
                    <div style={{ padding: "0 3px" }}>
                      {items.map((ms, i) => {
                        const ov = !ms.done && new Date(ms.due) < now;
                        return (
                          <div key={i} style={{
                            background: ms.done ? P.greenP : ov ? P.redP : P.card,
                            borderRadius: 8, padding: "6px 7px", marginBottom: 4,
                            borderLeft: `3px solid ${ms.done ? P.green : ov ? P.red : phase ? phase.color : P.stoneL}`,
                            boxShadow: "0 1px 3px rgba(0,0,0,0.04)", opacity: ms.done && past ? 0.55 : 1,
                          }}>
                            <div style={{ display: "flex", alignItems: "flex-start", gap: 4 }}>
                              <button onClick={() => toggleM(ms.task)} style={{
                                width: 14, height: 14, borderRadius: 3, flexShrink: 0, cursor: "pointer", marginTop: 1,
                                border: `2px solid ${ms.done ? P.green : ov ? P.red : P.stoneL}`,
                                background: ms.done ? P.green : "transparent",
                                display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 8,
                              }}>{ms.done && "\u2713"}</button>
                              <div style={{ flex: 1, minWidth: 0 }}>
                                <div style={{ fontSize: 10, fontWeight: 600, color: P.txt, textDecoration: ms.done ? "line-through" : "none", lineHeight: 1.3, wordBreak: "break-word" }}>{ms.task}</div>
                                <div style={{ fontSize: 8, color: ov ? P.red : P.txtL, marginTop: 1 }}>{new Date(ms.due).toLocaleDateString("en-GB",{day:"numeric",month:"short"})}{ms.assignee && <span style={{ marginLeft: 3, padding: "0 4px", borderRadius: 4, background: ms.assignee==="Sophie"?P.terraP:ms.assignee==="Joe"?P.blueP:P.oliveP, color: ms.assignee==="Sophie"?P.terra:ms.assignee==="Joe"?P.blue:P.olive, fontSize: 7, fontWeight: 600 }}>{ms.assignee}</span>}</div>
                              </div>
                              <button onClick={() => rmM(ms.task)} style={{ background: "none", border: "none", cursor: "pointer", color: P.stoneL, fontSize: 11, padding: 0, lineHeight: 1, flexShrink: 0 }}>{"\u00D7"}</button>
                            </div>
                          </div>
                        );
                      })}
                      {pays.map((p, i) => (
                        <div key={"p"+i} style={{ background: P.goldP, borderRadius: 8, padding: "5px 7px", marginBottom: 4, borderLeft: `3px solid ${P.gold}` }}>
                          <div style={{ fontSize: 10, fontWeight: 600, color: P.txt, lineHeight: 1.3 }}>{BUDGET_CATS.find(c => c.id === p.catId)?.icon} {p.label}</div>
                          <div style={{ fontSize: 9, color: P.gold, marginTop: 1 }}>{p.currency === "EUR" ? "\u20AC" : "\u00A3"}{p.amount.toLocaleString()}</div>
                        </div>
                      ))}
                      {items.length === 0 && pays.length === 0 && !isWedding && (
                        <div style={{ textAlign: "center", padding: "8px 0", fontSize: 18, opacity: 0.12 }}>{"\u00B7"}</div>
                      )}
                      {isWedding && (
                        <div style={{ background: `linear-gradient(135deg, ${P.terra}, ${P.terraL})`, borderRadius: 8, padding: "8px 7px", color: "#fff", textAlign: "center" }}>
                          <div style={{ fontSize: 11, fontWeight: 700 }}>Wedding Day</div>
                          <div style={{ fontSize: 8, opacity: 0.8 }}>Sat 29 May</div>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Ideas & Inspiration */}
          <div style={{ marginTop: 24 }}>
            <div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 18, fontWeight: 700, color: P.txt, marginBottom: 4 }}>Ideas & Inspiration</div>
            <div style={{ fontSize: 12, color: P.txtL, marginBottom: 14 }}>Curated for your Tuscany villa wedding {"\u2014"} tap to add any to your timeline</div>

            {IDEAS.map((group, gi) => {
              const isExp = expIdea === gi;
              const mTasks = milestones.map(m => m.task);
              return (
                <div key={gi} style={{ marginBottom: 8 }}>
                  <div onClick={() => setExpIdea(isExp ? null : gi)} style={{
                    display: "flex", alignItems: "center", gap: 8, padding: "10px 14px", cursor: "pointer",
                    background: P.card, borderRadius: isExp ? "12px 12px 0 0" : 12,
                    boxShadow: "0 1px 3px rgba(0,0,0,0.04)",
                  }}>
                    <div style={{ width: 10, height: 10, borderRadius: "50%", background: group.color, flexShrink: 0 }} />
                    <div style={{ flex: 1, fontSize: 13, fontWeight: 600, color: P.txt }}>{group.cat}</div>
                    <span style={{ fontSize: 10, color: P.txtL }}>{group.ideas.filter(i => mTasks.includes(i.title)).length}/{group.ideas.length}</span>
                    <span style={{ fontSize: 14, color: P.stoneL, transform: isExp ? "rotate(90deg)" : "none", transition: "transform 0.2s" }}>{"\u203A"}</span>
                  </div>
                  {isExp && (
                    <div style={{ background: P.card, borderRadius: "0 0 12px 12px", padding: "6px 10px 10px", boxShadow: "0 1px 3px rgba(0,0,0,0.04)" }}>
                      {group.ideas.map((idea, ii) => {
                        const exists = mTasks.includes(idea.title);
                        const justAdded = addedFlash === idea.title;
                        return (
                          <div key={ii} style={{
                            display: "flex", gap: 10, alignItems: "flex-start", padding: "10px 4px",
                            borderBottom: ii < group.ideas.length - 1 ? `1px solid ${P.bgD}` : "none",
                          }}>
                            <div style={{ width: 4, borderRadius: 2, alignSelf: "stretch", background: group.color, flexShrink: 0, opacity: 0.4 }} />
                            <div style={{ flex: 1 }}>
                              <div style={{ fontSize: 12, fontWeight: 600, color: P.txt }}>{idea.title}</div>
                              <div style={{ fontSize: 10, color: P.txtM, lineHeight: 1.4, marginTop: 2 }}>{idea.desc}</div>
                            </div>
                            {exists || justAdded ? (
                              <div style={{ fontSize: 10, fontWeight: 600, color: P.green, flexShrink: 0, padding: "4px 10px", borderRadius: 8, background: P.greenP }}>
                                {"\u2713"} {justAdded ? "Added!" : "In plan"}
                              </div>
                            ) : (
                              <button onClick={() => {
                                saveMilestones([...milestones, { task: idea.title, due: idea.due, done: false }]);
                                setAddedFlash(idea.title);
                                setTimeout(() => setAddedFlash(null), 2000);
                              }} style={{
                                ...bS, flexShrink: 0, background: `${group.color}18`, color: group.color,
                                padding: "4px 10px", borderRadius: 8, fontSize: 10, fontWeight: 600,
                              }}>+ Add</button>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          {/* Bride & Groom Prep */}
          {(() => {
            const [prepOpen, setPrepOpen] = React.useState(false);
            const [customInput, setCustomInput] = React.useState({ groom: "", bride: "" });
            const prep = prepChecklist || { groom: {}, bride: {}, customGroom: [], customBride: [] };
            const customG = safeArr(prep.customGroom);
            const customB = safeArr(prep.customBride);
            const allGroom = [...GROOM_PREP, ...customG];
            const allBride = [...BRIDE_PREP, ...customB];
            const gDone = allGroom.filter(c => prep.groom?.[c.key]?.done).length;
            const bDone = allBride.filter(c => prep.bride?.[c.key]?.done).length;
            const toggle = (who, key) => {
              const cur = prep[who]?.[key] || {};
              savePrepChecklist({ ...prep, [who]: { ...prep[who], [key]: { ...cur, done: !cur.done, date: !cur.done ? new Date().toISOString().slice(0, 10) : "" } } });
            };
            const addCustom = (who) => {
              const field = who === "groom" ? "customGroom" : "customBride";
              const label = customInput[who === "groom" ? "groom" : "bride"].trim();
              if (!label) return;
              const key = "custom_" + Date.now();
              savePrepChecklist({ ...prep, [field]: [...(who === "groom" ? customG : customB), { key, label }] });
              setCustomInput(p => ({ ...p, [who === "groom" ? "groom" : "bride"]: "" }));
            };
            const rmCustom = (who, key) => {
              if (!window.confirm("Remove this custom item?")) return;
              const field = who === "groom" ? "customGroom" : "customBride";
              const updated = (who === "groom" ? customG : customB).filter(c => c.key !== key);
              const newWho = { ...prep[who] }; delete newWho[key];
              savePrepChecklist({ ...prep, [field]: updated, [who]: newWho });
            };
            const renderPanel = (who, title, icon, items, doneCount, color) => (
              <div style={{ flex: 1, minWidth: 200 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 8 }}>
                  <span style={{ fontSize: 16 }}>{icon}</span>
                  <span style={{ fontSize: 13, fontWeight: 700, color: P.txt }}>{title}</span>
                  <span style={{ fontSize: 10, color: P.txtL, marginLeft: "auto" }}>{doneCount}/{items.length}</span>
                </div>
                <div style={{ height: 4, borderRadius: 2, background: P.bgD, marginBottom: 10 }}>
                  <div style={{ height: 4, borderRadius: 2, background: color, width: items.length ? `${(doneCount / items.length) * 100}%` : 0, transition: "width 0.3s" }} />
                </div>
                {items.map(c => {
                  const entry = prep[who]?.[c.key] || {};
                  const isCustom = c.key.startsWith("custom_");
                  return (
                    <div key={c.key} style={{ display: "flex", alignItems: "center", gap: 8, padding: "7px 0", borderBottom: `1px solid ${P.bgD}` }}>
                      <input type="checkbox" checked={!!entry.done} onChange={() => toggle(who, c.key)} style={{ accentColor: color }} />
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 11, color: entry.done ? P.txtL : P.txt, textDecoration: entry.done ? "line-through" : "none" }}>{c.label}</div>
                        {entry.done && entry.date && <div style={{ fontSize: 9, color: P.green, marginTop: 1 }}>Completed {entry.date}</div>}
                      </div>
                      {isCustom && <button onClick={() => rmCustom(who, c.key)} style={{ background: "none", border: "none", color: P.red, cursor: "pointer", fontSize: 12, padding: "2px 4px", opacity: 0.5 }} title="Remove">{"\u2715"}</button>}
                    </div>
                  );
                })}
                <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
                  <input value={customInput[who === "groom" ? "groom" : "bride"]} onChange={e => setCustomInput(p => ({ ...p, [who === "groom" ? "groom" : "bride"]: e.target.value }))} onKeyDown={e => e.key === "Enter" && addCustom(who)} placeholder="Add custom item..." style={{ ...iS, flex: 1, fontSize: 10 }} />
                  <button onClick={() => addCustom(who)} style={{ ...bS, fontSize: 10, padding: "4px 10px", color }}>+ Add</button>
                </div>
              </div>
            );
            return (
              <div style={{ marginTop: 18 }}>
                <div onClick={() => setPrepOpen(!prepOpen)} style={{ background: P.card, borderRadius: prepOpen ? "14px 14px 0 0" : 14, padding: "12px 14px", cursor: "pointer", boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `5px solid ${P.terra}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 700, color: P.txt, fontFamily: "'Playfair Display', Georgia, serif" }}>{"\uD83D\uDC70"}{"\uD83E\uDD35"} Bride & Groom Prep</div>
                    <div style={{ fontSize: 10, color: P.txtL, marginTop: 1 }}>Sophie: {bDone}/{allBride.length} ¬∑ Joe: {gDone}/{allGroom.length}</div>
                  </div>
                  <span style={{ fontSize: 15, color: P.stoneL, transform: prepOpen ? "rotate(90deg)" : "none", transition: "transform 0.2s" }}>{"\u203A"}</span>
                </div>
                {prepOpen && (
                  <div style={{ background: P.card, borderRadius: "0 0 14px 14px", padding: "14px", boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `5px solid ${P.terra}` }}>
                    <div style={{ display: "flex", gap: 18, flexWrap: "wrap" }}>
                      {renderPanel("groom", "Joe", "\uD83E\uDD35", allGroom, gDone, P.blue)}
                      {renderPanel("bride", "Sophie", "\uD83D\uDC70", allBride, bDone, P.terra)}
                    </div>
                  </div>
                )}
              </div>
            );
          })()}

          {/* Legal Ceremony Checklist */}
          {(() => {
            const [lcOpen, setLcOpen] = React.useState(false);
            const done = LEGAL_CHECKLIST.filter(c => legalChecklist[c.key]?.done).length;
            return (
              <div style={{ marginTop: 18 }}>
                <div onClick={() => setLcOpen(!lcOpen)} style={{ background: P.card, borderRadius: lcOpen ? "14px 14px 0 0" : 14, padding: "12px 14px", cursor: "pointer", boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `5px solid ${P.blue}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 700, color: P.txt, fontFamily: "'Playfair Display', Georgia, serif" }}>{"\uD83C\uDDEC\uD83C\uDDE7"} Legal Ceremony</div>
                    <div style={{ fontSize: 10, color: P.txtL, marginTop: 1 }}>Oakwood House, UK ‚Äî {done}/{LEGAL_CHECKLIST.length} complete</div>
                  </div>
                  <span style={{ fontSize: 15, color: P.stoneL, transform: lcOpen ? "rotate(90deg)" : "none", transition: "transform 0.2s" }}>{"\u203A"}</span>
                </div>
                {lcOpen && (
                  <div style={{ background: P.card, borderRadius: "0 0 14px 14px", padding: "8px 14px 14px", boxShadow: "0 1px 4px rgba(0,0,0,0.04)", borderLeft: `5px solid ${P.blue}` }}>
                    {LEGAL_CHECKLIST.map(c => {
                      const entry = legalChecklist[c.key] || {};
                      return (
                        <div key={c.key} style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 0", borderBottom: `1px solid ${P.bgD}` }}>
                          <input type="checkbox" checked={!!entry.done} onChange={e => {
                            saveLegalChecklist({ ...legalChecklist, [c.key]: { ...entry, done: e.target.checked, date: e.target.checked ? new Date().toISOString().slice(0, 10) : "" } });
                          }} style={{ accentColor: P.blue }} />
                          <div style={{ flex: 1 }}>
                            <div style={{ fontSize: 11, color: entry.done ? P.txtL : P.txt, textDecoration: entry.done ? "line-through" : "none" }}>{c.label}</div>
                            {entry.done && entry.date && <div style={{ fontSize: 9, color: P.green, marginTop: 1 }}>Completed {entry.date}</div>}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            );
          })()}
        </div>
      );
    }

    /* ========== MAIN ========== */
    function WeddingDashboard() {
      const [tab, setTab] = useState("dash");
      const fbConnected = useFirebaseConnected();
      const [budget, saveBudget, b1] = useStorage("wedding-budget-v3", DEFAULT_DATA.budget);
      const [guests, saveGuests, b2] = useStorage("wedding-guests-v4", DEFAULT_DATA.guests);
      const [vendors, saveVendors, b3] = useStorage("wedding-vendors-v4", DEFAULT_DATA.vendors);
      const [timeline, saveTimeline, b4] = useStorage("wedding-timeline-v3", DEFAULT_DATA.timeline);
      const [milestones, saveMilestones, b5] = useStorage("wedding-milestones-v4", DEFAULT_DATA.milestones);
      const [decisions, saveDecisions, b6] = useStorage("wedding-decisions-v3", DEFAULT_DATA.decisions);
      const [music, saveMusic, b7] = useStorage("wedding-music-v3", DEFAULT_DATA.music);
      const [packing, savePacking, b8] = useStorage("wedding-packing-v3", DEFAULT_DATA.packing);
      const [seating, saveSeating, b9] = useStorage("wedding-seating-v3", DEFAULT_DATA.seating);
      const [rooms, saveRooms, b10] = useStorage("wedding-rooms-v3", DEFAULT_DATA.rooms);
      const [contingency, saveContingency, b11] = useStorage("wedding-contingency-v1", {
        rain: "Move ceremony to indoor salon at villa. Cocktail hour under covered loggia. Reception in main dining room.",
        vendorNoShow: "Contact wedding planner immediately.\nBackup photographer: TBC\nBackup DJ: TBC",
        medical: "Nearest hospital: Ospedale Valtiberina, Sansepolcro (10 min drive).\nEmergency number: 112\nFirst aid kit: villa reception desk.",
        transport: "Backup taxi: Radio Taxi Arezzo (+39 0575 382626)\nCar hire: Europcar Sansepolcro\nVilla parking: 20+ spaces"
      });
      const [eurRate, saveEurRate, b12] = useStorage("wedding-eur-rate-v1", 1.17);
      const [legalChecklist, saveLegalChecklist, b13] = useStorage("wedding-legal-v1", {});
      const [speeches, saveSpeeches, b14] = useStorage("wedding-speeches-v1", []);
      const [prepChecklist, savePrepChecklist, b15] = useStorage("wedding-prep-v1", { groom: {}, bride: {}, customGroom: [], customBride: [] });
      EUR_RATE = eurRate;

      if (!(b1&&b2&&b3&&b4&&b5&&b6&&b7&&b8&&b9&&b10&&b11&&b12&&b13&&b14&&b15)) return (
        <div style={{ minHeight: "100vh", background: P.bg, display: "flex", alignItems: "center", justifyContent: "center" }}>
          <div style={{ textAlign: "center", color: P.txtL }}><div style={{ fontSize: 30, marginBottom: 8 }}>{"\uD83D\uDC8D"}</div><div style={{ fontFamily: "'Playfair Display', Georgia, serif", fontSize: 15 }}>Loading...</div></div>
        </div>
      );

      const now = new Date();
      const upPay = [];
      BUDGET_CATS.forEach(c => { const b = budget[c.id]; if (!b?.payments) return; b.payments.forEach(p => { if (!p.paid && p.date && p.amount > 0) upPay.push({ catId: c.id, label: p.label, amount: p.amount, date: p.date, currency: b.currency || "GBP" }); }); });
      upPay.sort((a, b) => new Date(a.date) - new Date(b.date));
      const gC = guests.length; const cC = guests.filter(g => g.status === "Confirmed").length;

      // Browser notifications for overdue items
      const [notifEnabled, setNotifEnabled] = React.useState(typeof Notification !== "undefined" && Notification.permission === "granted");
      const notifRef = React.useRef(new Set());
      React.useEffect(() => {
        if (typeof Notification === "undefined" || Notification.permission !== "granted") return;
        const today = new Date().toISOString().slice(0, 10);
        const overdue = [];
        milestones.filter(m => !m.done && m.due && m.due < today).forEach(m => overdue.push(`Milestone overdue: ${m.task}`));
        upPay.filter(p => p.date < today).forEach(p => overdue.push(`Payment overdue: ${p.label} (¬£${p.amount})`));
        overdue.forEach(msg => { if (!notifRef.current.has(msg)) { notifRef.current.add(msg); try { new Notification("Wedding Dashboard", { body: msg, icon: "\uD83D\uDC8D" }); } catch(e) {} } });
      }, [milestones, budget]);

      return (
        <div style={{ minHeight: "100vh", background: P.bg, fontFamily: "'DM Sans', -apple-system, sans-serif" }}>
          <div data-no-print style={{ position: "sticky", top: 0, zIndex: 100, background: P.bg, borderBottom: `1px solid ${P.bgD}`, padding: "0 4px" }}>
            <div style={{ maxWidth: 840, margin: "0 auto", display: "flex", gap: 0, overflowX: "auto", alignItems: "center" }}>
              {TABS.map(t => (
                <button key={t.id} onClick={() => setTab(t.id)} style={{
                  flex: 1, minWidth: 46, padding: "10px 2px 8px", border: "none", cursor: "pointer",
                  background: "transparent", fontSize: 9, fontWeight: tab===t.id?700:500,
                  color: tab===t.id?P.terra:P.txtL,
                  borderBottom: tab===t.id?`3px solid ${P.terra}`:"3px solid transparent",
                  transition: "all 0.2s", whiteSpace: "nowrap"
                }}><span style={{ fontSize: 13, display: "block", marginBottom: 1 }}>{t.icon}</span>{t.label}</button>
              ))}
              {typeof Notification !== "undefined" && Notification.permission === "default" && (
                <button onClick={() => Notification.requestPermission().then(p => { if (p === "granted") setNotifEnabled(true); })} title="Enable reminders for overdue items" style={{ ...bS, fontSize: 8, padding: "3px 6px", marginLeft: 4, flexShrink: 0 }}>{"\uD83D\uDD14"}</button>
              )}
              <div title={fbConnected ? "Synced to cloud" : "Offline \u2014 changes saved locally"} style={{
                flexShrink: 0, width: 8, height: 8, borderRadius: "50%", marginLeft: 6,
                background: fbConnected ? P.green : P.gold,
                boxShadow: fbConnected ? `0 0 4px ${P.green}` : `0 0 4px ${P.gold}`,
                transition: "all 0.3s"
              }} />
            </div>
          </div>
          <div style={{ maxWidth: 840, margin: "0 auto", padding: "18px 10px 50px" }}>
            {tab === "dash" && <DashTab data={{ budget, milestones }} saveMilestones={saveMilestones} gC={gC} cC={cC} upPay={upPay} vendors={vendors} guests={guests} timeline={timeline} allData={{ budget, guests, vendors, timeline, milestones, decisions, music, packing, seating, rooms, contingency, legalChecklist, speeches, eurRate, prepChecklist }} saveFns={{ saveBudget, saveGuests, saveVendors, saveTimeline, saveMilestones, saveDecisions, saveMusic, savePacking, saveSeating, saveRooms, saveContingency, saveLegalChecklist, saveSpeeches, saveEurRate, savePrepChecklist }} />}
            {tab === "budget" && <BudgetTab budget={budget} saveBudget={saveBudget} vendors={vendors} eurRate={eurRate} saveEurRate={saveEurRate} />}
            {tab === "vendors" && <VendorsTab vendors={vendors} saveVendors={saveVendors} />}
            {tab === "guests" && <GuestsTab guests={guests} saveGuests={saveGuests} />}
            {tab === "seating" && <SeatingTab seating={seating} saveSeating={saveSeating} guests={guests} />}
            {tab === "rooms" && <RoomsTab rooms={rooms} saveRooms={saveRooms} guests={guests} />}
            {tab === "project" && <ProjectTab milestones={milestones} saveMilestones={saveMilestones} vendors={vendors} budget={budget} upPay={upPay} legalChecklist={legalChecklist} saveLegalChecklist={saveLegalChecklist} prepChecklist={prepChecklist} savePrepChecklist={savePrepChecklist} />}
            {tab === "timeline" && <TimelineTab timeline={timeline} saveTimeline={saveTimeline} contingency={contingency} saveContingency={saveContingency} speeches={speeches} saveSpeeches={saveSpeeches} />}
            {tab === "music" && <MusicTab music={music} saveMusic={saveMusic} />}
            {tab === "packing" && <PackingTab packing={packing} savePacking={savePacking} />}
            {tab === "decisions" && <DecisionsTab decisions={decisions} saveDecisions={saveDecisions} />}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<WeddingDashboard />);
  </script>
</body>
</html>
